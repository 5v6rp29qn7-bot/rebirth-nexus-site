<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Rebirth Nexus ‚Äî Municipal Stormwater & Sewer Intelligence</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-tertiary: #1a1a24;
  --bg-card: #1e1e2a;
  --bg-card-hover: #262636;
  --border: #2a2a3a;
  --border-accent: #3a3a50;
  --text-primary: #f0f0f5;
  --text-secondary: #a0a0b0;
  --text-muted: #606072;
  --accent-gold: #d4af37;
  --accent-gold-dim: rgba(212,175,55,0.12);
  --accent-emerald: #10b981;
  --accent-emerald-dim: rgba(16,185,129,0.12);
  --accent-cyan: #22d3ee;
  --accent-cyan-dim: rgba(34,211,238,0.10);
  --accent-red: #ef4444;
  --accent-red-dim: rgba(239,68,68,0.10);
  --accent-amber: #f59e0b;
  --accent-amber-dim: rgba(245,158,11,0.10);
  --accent-purple: #a855f7;
  --accent-purple-dim: rgba(168,85,247,0.10);
  --gradient-brand: linear-gradient(135deg, #d4af37 0%, #f59e0b 50%, #ef4444 100%);
  --gradient-subtle: linear-gradient(135deg, rgba(212,175,55,0.08) 0%, rgba(245,158,11,0.05) 100%);
  --shadow: 0 4px 24px rgba(0,0,0,0.5);
  --radius: 10px;
  --radius-sm: 6px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; background: var(--bg-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; color: var(--text-primary); -webkit-font-smoothing: antialiased; }

/* ===== LAYOUT ===== */
.app { display: flex; flex-direction: column; height: 100vh; }

/* TOP BAR */
.top-bar {
  height: 48px; min-height: 48px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px; z-index: 100;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-icon { width: 28px; height: 28px; background: transparent; border-radius: 7px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.brand-icon img { width: 100%; height: 100%; object-fit: contain; }
.brand-name { font-size: 14px; font-weight: 600; background: var(--gradient-brand); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.brand-sub { font-size: 10px; color: var(--text-muted); margin-left: 2px; }
.brand-tag { font-size: 9px; color: var(--accent-gold); background: var(--accent-gold-dim); padding: 2px 7px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

.top-right { display: flex; align-items: center; gap: 14px; }
.kpi-ticker { display: flex; align-items: center; gap: 10px; }
.kpi-pill { display: flex; align-items: center; gap: 6px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; padding: 3px 10px; font-size: 10px; }
.kpi-pill-label { color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; font-weight: 500; }
.kpi-pill-val { font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-weight: 700; font-size: 11px; }
.kpi-pill-val.r { color: var(--accent-red); }
.kpi-pill-val.a { color: var(--accent-amber); }
.kpi-pill-val.g { color: var(--accent-emerald); }
.kpi-pill-delta { font-size: 9px; font-family: monospace; }
.kpi-pill-delta.up { color: var(--accent-red); }
.kpi-pill-delta.dn { color: var(--accent-emerald); }

.live-dot-wrap { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--accent-red); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }
.live-dot { width: 5px; height: 5px; background: var(--accent-red); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
.demo-mode-indicator { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--accent-amber); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; background: var(--accent-amber-dim); padding: 3px 8px; border-radius: 4px; }
.demo-dot { width: 5px; height: 5px; background: var(--accent-amber); border-radius: 50%; }
@keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(239,68,68,0.3)} 50%{opacity:.6;box-shadow:0 0 0 5px rgba(239,68,68,0)} }
.tour-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 11px; padding: 4px 10px; border-radius: 4px; cursor: pointer; transition: all .2s; }
.tour-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

/* MAIN */
.main { flex: 1; display: flex; overflow: hidden; }

/* ===== INTEL SIDEBAR ===== */
.sidebar {
  width: 260px; min-width: 260px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.sidebar-header {
  padding: 12px 14px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.sidebar-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px; }
.sidebar-live { display: flex; align-items: center; gap: 5px; font-size: 9px; color: var(--accent-red); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.sidebar-live .live-dot { width: 4px; height: 4px; }

/* Feed */
.feed { flex: 1; overflow-y: auto; padding: 8px 10px; }
.feed::-webkit-scrollbar { width: 2px; } .feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 1px; }
.feed-item {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 9px 11px; margin-bottom: 6px; cursor: pointer; transition: all .2s;
  border-left: 3px solid var(--accent-cyan);
}
.feed-item:hover { background: var(--bg-card); transform: translateX(2px); }
.feed-item.crit { border-left-color: var(--accent-red); }
.feed-item.warn { border-left-color: var(--accent-amber); }
.feed-item.info { border-left-color: var(--accent-cyan); }
.feed-time { font-size: 9px; color: var(--text-muted); font-family: monospace; margin-bottom: 3px; display: flex; align-items: center; gap: 6px; }
.feed-sev { font-size: 8px; padding: 1px 5px; border-radius: 2px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
.feed-sev.critical { background: var(--accent-red-dim); color: var(--accent-red); }
.feed-sev.warning { background: var(--accent-amber-dim); color: var(--accent-amber); }
.feed-sev.info { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.feed-text { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
.feed-text strong { color: var(--text-primary); font-weight: 600; }
.feed-tags { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
.ftag { font-size: 8px; padding: 1px 5px; border-radius: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
.ftag.thermal { background: var(--accent-red-dim); color: var(--accent-red); }
.ftag.grid { background: var(--accent-amber-dim); color: var(--accent-amber); }
.ftag.water { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.ftag.power { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.ftag.supply { background: var(--accent-purple-dim); color: var(--accent-purple); }
.ftag.weather { background: var(--accent-gold-dim); color: var(--accent-gold); }

/* ===== MAP PANEL ===== */
.map-panel {
  flex: 1; position: relative; min-width: 0;
  border-right: 1px solid var(--border);
}
#mapView { width: 100%; height: 100%; }
.map-legend {
  position: absolute; bottom: 12px; left: 12px;
  background: rgba(10,10,15,0.92); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  font-size: 10px; z-index: 10; backdrop-filter: blur(8px);
}
.map-legend-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px; }
.legend-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; color: var(--text-muted); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.legend-line { width: 16px; height: 2px; flex-shrink: 0; border-radius: 1px; }

/* ===== CHAT PANEL ===== */
.chat-panel {
  width: 380px; min-width: 380px;
  display: flex; flex-direction: column;
  background: var(--bg-primary);
  overflow: hidden;
}
.chat-header {
  padding: 10px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-secondary);
}
.chat-avatar { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 13px; overflow: hidden; }
.chat-avatar img { width: 100%; height: 100%; object-fit: contain; }
.chat-header-text { font-size: 12px; font-weight: 600; color: var(--text-secondary); }

/* Messages */
.chat-messages { flex: 1; overflow-y: auto; padding: 14px 16px; scroll-behavior: smooth; }
.chat-messages::-webkit-scrollbar { width: 3px; } .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.message { margin-bottom: 16px; animation: fadeIn .35s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.msg-head { display: flex; align-items: center; gap: 7px; margin-bottom: 6px; }
.msg-av { width: 22px; height: 22px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
.msg-av.ai { overflow: hidden; }
.msg-av.ai img { width: 100%; height: 100%; object-fit: contain; }
.msg-av.user { background: var(--bg-card); border: 1px solid var(--border); }
.msg-name { font-size: 11px; font-weight: 600; color: var(--text-muted); }
.msg-time { font-size: 9px; color: var(--text-muted); font-family: monospace; }
.msg-body { margin-left: 29px; font-size: 13px; line-height: 1.6; color: var(--text-primary); }
.msg-body strong { color: #fff; font-weight: 600; }
.msg-body em { color: var(--text-secondary); }
.msg-body p { margin-bottom: 8px; }
.msg-body ul, .msg-body ol { margin: 6px 0 6px 20px; }
.msg-body li { margin-bottom: 3px; font-size: 12px; color: var(--text-secondary); }

/* Viz components inside messages */
.viz-alert { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-alert-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); }
.viz-alert-header.critical, .viz-alert-header:not(.warning):not(.info):not(.success) { background: var(--accent-red-dim); color: var(--accent-red); }
.viz-alert-header.warning { background: var(--accent-amber-dim); color: var(--accent-amber); }
.viz-alert-header.info { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.viz-alert-header.success { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.viz-alert-row { display: flex; justify-content: space-between; padding: 6px 12px; font-size: 11px; border-bottom: 1px solid rgba(42,42,58,0.4); }
.viz-alert-row:last-child { border-bottom: none; }
.viz-alert-row span:first-child { color: var(--text-secondary); }
.viz-alert-row span:last-child { color: var(--text-primary); font-family: monospace; font-weight: 500; }

.viz-roi { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-roi-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.viz-roi-total { text-align: center; font-size: 24px; font-weight: 700; font-family: monospace; color: var(--accent-emerald); padding: 12px; }
.viz-roi-row { display: flex; justify-content: space-between; padding: 6px 12px; font-size: 11px; border-top: 1px solid rgba(42,42,58,0.4); }
.viz-roi-label { color: var(--text-secondary); } .viz-roi-value { color: var(--text-primary); font-family: monospace; }

.viz-timeline { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-timeline-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.timeline-track { padding: 10px 12px; position: relative; }
.timeline-line { position: absolute; left: 17px; top: 10px; bottom: 10px; width: 2px; background: var(--border); }
.timeline-item { display: flex; align-items: flex-start; gap: 10px; padding: 4px 0; position: relative; }
.timeline-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; margin-top: 4px; z-index: 1; }
.timeline-dot.active { background: var(--accent-emerald); box-shadow: 0 0 6px rgba(16,185,129,0.4); }
.timeline-dot.warning { background: var(--accent-amber); }
.timeline-dot.danger { background: var(--accent-red); }
.timeline-time { font-size: 9px; color: var(--text-muted); font-family: monospace; min-width: 44px; }
.timeline-label { font-size: 11px; color: var(--text-secondary); line-height: 1.3; }

.viz-asset { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-asset-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); }
.viz-asset-id { font-family: monospace; font-size: 12px; font-weight: 600; color: var(--accent-gold); }
.viz-asset-status { font-size: 9px; padding: 2px 7px; border-radius: 3px; font-weight: 600; text-transform: uppercase; }
.viz-asset-status.ok { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.viz-asset-status.warning { background: var(--accent-amber-dim); color: var(--accent-amber); }
.viz-asset-status.critical { background: var(--accent-red-dim); color: var(--accent-red); }
.viz-asset-body { padding: 8px 12px; }
.viz-asset-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
.viz-asset-row span:first-child { color: var(--text-muted); }
.viz-asset-row span:last-child { color: var(--text-primary); font-family: monospace; }

.temp-gauge { display: flex; align-items: center; gap: 6px; margin: 6px 0; }
.temp-bar { flex: 1; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; }
.temp-bar-fill { height: 100%; border-radius: 3px; transition: width .5s; }
.temp-bar-fill.ok { background: var(--accent-emerald); }
.temp-bar-fill.warning { background: var(--accent-amber); }
.temp-bar-fill.danger { background: var(--accent-red); }
.temp-value { font-size: 11px; font-family: monospace; font-weight: 600; min-width: 36px; text-align: right; }

/* Network Trace Visualization */
.viz-trace { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-trace-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--accent-purple-dim); color: var(--accent-purple); }
.trace-diagram { display: flex; align-items: center; padding: 12px; gap: 4px; overflow-x: auto; }
.trace-node { padding: 6px 10px; border-radius: 4px; font-size: 10px; font-family: monospace; font-weight: 600; text-align: center; white-space: nowrap; }
.trace-node.transformer { background: var(--accent-red-dim); color: var(--accent-red); border: 1px solid var(--accent-red); }
.trace-node.busbar { background: var(--accent-amber-dim); color: var(--accent-amber); border: 1px solid var(--accent-amber); }
.trace-node.switch { background: var(--accent-cyan-dim); color: var(--accent-cyan); border: 1px solid var(--accent-cyan); }
.trace-node.fuse { background: var(--accent-purple-dim); color: var(--accent-purple); border: 1px solid var(--accent-purple); }
.trace-node.service-point { background: var(--accent-emerald-dim); color: var(--accent-emerald); border: 1px solid var(--accent-emerald); }
.trace-connector { color: var(--text-muted); font-size: 12px; }
.trace-summary { padding: 8px 12px; font-size: 11px; color: var(--text-secondary); border-top: 1px solid var(--border); background: var(--bg-tertiary); }
.trace-summary strong { color: var(--text-primary); }

/* Work Order Visualization */
.viz-workorder { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-workorder-header { padding: 10px 12px; font-size: 13px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--accent-gold-dim); color: var(--accent-gold); }
.workorder-field { display: flex; padding: 6px 12px; font-size: 11px; border-bottom: 1px solid rgba(42,42,58,0.3); }
.wo-label { color: var(--text-muted); width: 130px; flex-shrink: 0; }
.wo-value { color: var(--text-primary); font-family: monospace; }
.wo-value.priority-P1 { color: var(--accent-red); font-weight: 700; }
.wo-value.priority-P2 { color: var(--accent-amber); font-weight: 700; }
.wo-value.priority-P3 { color: var(--accent-cyan); }
.wo-value.priority-P4 { color: var(--text-secondary); }
.workorder-actions { display: flex; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); }
.wo-btn { padding: 6px 12px; font-size: 10px; border-radius: 4px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; transition: all .2s; }
.wo-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

/* Enhanced Data Table with Header */
.viz-data-table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-data-table-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.viz-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.viz-table th { text-align: left; padding: 6px 8px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 9px; letter-spacing: 0.3px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); }
.viz-table td { padding: 5px 8px; color: var(--text-secondary); border-bottom: 1px solid rgba(42,42,58,0.3); }
.viz-table td.highlight { color: var(--accent-amber); font-weight: 600; }
.viz-table td.vip { color: var(--accent-red); font-weight: 600; }
.viz-table td.normal { color: var(--accent-emerald); }

/* Notification Preview */
.viz-notification { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-notification-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.notification-preview { padding: 10px 12px; font-size: 11px; color: var(--text-secondary); line-height: 1.5; font-style: italic; background: var(--bg-tertiary); border-left: 3px solid var(--accent-gold); margin: 8px 12px; border-radius: 0 4px 4px 0; }
.notification-meta { padding: 6px 12px; font-size: 10px; color: var(--text-muted); display: flex; gap: 16px; }

/* Data table */
.viz-data-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 11px; }
.viz-data-table th { text-align: left; padding: 6px 8px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 9px; letter-spacing: 0.3px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
.viz-data-table td { padding: 5px 8px; color: var(--text-secondary); border-bottom: 1px solid rgba(42,42,58,0.3); font-family: monospace; }

/* Compact response components */
.vb { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; padding: 0; }
.vt { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); color: var(--accent-cyan); }
.vr { display: flex; justify-content: space-between; padding: 6px 12px; font-size: 11px; border-bottom: 1px solid rgba(42,42,58,0.3); gap: 12px; }
.vr:last-child { border-bottom: none; }
.vr .l { color: var(--text-muted); flex-shrink: 0; min-width: 120px; }
.vr .v { color: var(--text-primary); font-family: monospace; font-weight: 500; text-align: right; }
.vr .v.red { color: var(--accent-red); }
.vr .v.amb { color: var(--accent-amber); }
.vr .v.grn { color: var(--accent-emerald); }
.tb { width: 100%; border-collapse: collapse; font-size: 11px; margin: 0; }
.tb th { text-align: left; padding: 6px 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 9px; letter-spacing: 0.3px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); }
.tb td { padding: 5px 10px; color: var(--text-secondary); border-bottom: 1px solid rgba(42,42,58,0.3); }
.tb td.h, .tb td.hl { color: var(--text-primary); font-weight: 600; }
.pv { margin: 10px 0 4px; }
.pl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.pg { display: flex; flex-wrap: wrap; gap: 4px; }
.pt { font-size: 9px; padding: 2px 8px; border-radius: 3px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-muted); }
.an { background: var(--bg-card); border: 1px solid rgba(239,68,68,0.3); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.ah { padding: 8px 12px; font-size: 12px; font-weight: 600; background: var(--accent-red-dim); color: var(--accent-red); }
.ab, .ab2 { padding: 8px 12px; font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
.wo-f { display: flex; padding: 6px 12px; font-size: 11px; border-bottom: 1px solid rgba(42,42,58,0.3); }
.wo-f .wl { color: var(--text-muted); width: 110px; flex-shrink: 0; }
.wo-f .wv { color: var(--text-primary); font-family: monospace; }
.tn { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 10px; font-family: monospace; font-weight: 600; }
.tn.start { background: var(--accent-red-dim); color: var(--accent-red); }
.tn.mid { background: var(--accent-amber-dim); color: var(--accent-amber); }
.tn.end { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.ta { color: var(--text-muted); margin: 0 4px; }

/* Chips */
.chips-section { padding: 8px 16px; border-top: 1px solid var(--border); }
.chips-grid { display: flex; flex-wrap: wrap; gap: 5px; }
.chip {
  font-size: 10px; padding: 5px 10px; border-radius: 4px;
  background: var(--bg-tertiary); border: 1px solid var(--border);
  color: var(--text-secondary); cursor: pointer; transition: all .2s;
  white-space: nowrap;
}
.chip:hover { border-color: var(--accent-gold); color: var(--accent-gold); background: var(--accent-gold-dim); }

/* Input */
.chat-input-area { padding: 10px 16px; border-top: 1px solid var(--border); }
.input-wrap { display: flex; gap: 8px; }
.chat-input {
  flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 8px 12px; color: var(--text-primary); font-size: 12px; outline: none; transition: border .2s;
  font-family: inherit;
}
.chat-input::placeholder { color: var(--text-muted); }
.chat-input:focus { border-color: var(--accent-gold); }
.send-btn {
  background: var(--gradient-brand); border: none; color: #000; font-weight: 600;
  padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-size: 11px;
  transition: opacity .2s; font-family: inherit;
}
.send-btn:hover { opacity: 0.9; }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.chat-footer { padding: 6px 16px 10px; font-size: 9px; color: var(--text-muted); text-align: center; }
.chat-footer a { color: var(--accent-gold); text-decoration: none; }

/* Typing indicator */
.typing-indicator { display: flex; gap: 4px; padding: 8px 0; margin-left: 29px; }
.typing-dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: typingBounce 1.2s ease-in-out infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-6px);opacity:1} }

/* ===== TOUR ===== */
.tour-overlay {
  display: none; position: fixed; inset: 0; z-index: 10000;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
}
.tour-overlay.active { display: block; }
.tour-tooltip {
  position: absolute; background: var(--bg-secondary); border: 1px solid var(--accent-gold);
  border-radius: var(--radius); padding: 16px 18px; max-width: 320px; box-shadow: var(--shadow);
}
.tour-title { font-size: 14px; font-weight: 700; color: var(--accent-gold); margin-bottom: 8px; }
.tour-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
.tour-btns { display: flex; justify-content: space-between; align-items: center; }
.tour-step-count { font-size: 10px; color: var(--text-muted); font-family: monospace; }
.tour-skip { background: none; border: none; color: var(--text-muted); font-size: 11px; cursor: pointer; padding: 4px 8px; }
.tour-skip:hover { color: var(--text-secondary); }
.tour-next {
  background: var(--gradient-brand); border: none; color: #000; font-weight: 600;
  padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 11px;
}
.tour-next:hover { opacity: 0.9; }

/* Responsive */
@media (max-width: 1200px) {
  .sidebar { width: 220px; min-width: 220px; }
  .chat-panel { width: 340px; min-width: 340px; }
  .kpi-ticker { display: none; }
}
@media (max-width: 900px) {
  .sidebar { display: none; }
  .chat-panel { width: 300px; min-width: 300px; }
}
/* === PASSWORD GATE === */
.password-gate { position: fixed; inset: 0; background: #0a0e17; display: flex; align-items: center; justify-content: center; z-index: 99999; }
.password-gate.hidden { display: none; }
.password-box { background: #111827; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 40px; text-align: center; max-width: 400px; width: 90%; }
.pw-logo { width: 64px; height: 64px; background: transparent; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; overflow: hidden; }
.pw-logo img { width: 100%; height: 100%; object-fit: contain; }
.pw-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #f1f5f9; }
.pw-subtitle { font-size: 13px; color: #64748b; margin-bottom: 24px; }
.pw-input { width: 100%; padding: 12px 16px; background: #0a0e17; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #f1f5f9; font-size: 14px; text-align: center; outline: none; margin-bottom: 12px; font-family: inherit; box-sizing: border-box; }
.pw-input:focus { border-color: #fbbf24; }
.pw-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; border-radius: 8px; color: #000; font-weight: 600; font-size: 14px; cursor: pointer; font-family: inherit; }
.pw-btn:hover { opacity: 0.9; }
.pw-error { color: #ef4444; font-size: 12px; margin-top: 8px; display: none; }
.pw-error.show { display: block; }
.pw-footer { font-size: 11px; color: #475569; margin-top: 20px; }
@keyframes pwShake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }
.pw-shake { animation: pwShake 0.4s ease; }

</style>
</head>
<body>
<!-- PASSWORD GATE -->
<div class="password-gate" id="pwGate">
  <div class="password-box">
    <div class="pw-logo"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='‚ö°'"></div>
    <div class="pw-title">Nexus Demo Access</div>
    <div class="pw-subtitle">TAQA Stormwater Intelligence</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="Enter access code" autocomplete="off">
    <button class="pw-btn" id="pwBtn">Access Demo</button>
    <div class="pw-error" id="pwError">Incorrect access code</div>
    <div class="pw-footer">Rebirth Nexus Inc. ¬∑ Confidential</div>
  </div>
</div>
<script>
(function(){
  var k='nexus_taqa_sewer';
  if(sessionStorage.getItem(k)==='granted'){document.getElementById('pwGate').classList.add('hidden');}
  document.getElementById('pwBtn').onclick=check;
  document.getElementById('pwInput').addEventListener('keydown',function(e){if(e.key==='Enter')check();});
  function check(){
    if(document.getElementById('pwInput').value==='deserthawk'){
      sessionStorage.setItem(k,'granted');
      document.getElementById('pwGate').classList.add('hidden');
    } else {
      var e=document.getElementById('pwError');e.classList.add('show');
      var b=document.querySelector('.password-box');b.classList.add('pw-shake');
      setTimeout(function(){b.classList.remove('pw-shake');},400);
    }
  }
})();
</script>

<div class="app">
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="brand">
      <div class="brand-icon"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='‚ö°'"></div>
      <span class="brand-name">Rebirth Nexus</span>
      <span class="brand-sub">Stormwater & Sewer Intelligence ‚Äî Houston TX</span>
      <span class="brand-tag">Live Intelligence</span>
    </div>
    <div class="top-right">
      <div class="kpi-ticker">
        <div class="kpi-pill">
          <span class="kpi-pill-label">Rain Rate</span>
          <span class="kpi-pill-val r">3.2 in/hr</span>
          <span class="kpi-pill-delta up">‚Üë 100-yr</span>
        </div>
        <div class="kpi-pill">
          <span class="kpi-pill-label">System Load</span>
          <span class="kpi-pill-val r">127%</span>
          <span class="kpi-pill-delta up">‚Üë 42%</span>
        </div>
        <div class="kpi-pill">
          <span class="kpi-pill-label">SSO Risk</span>
          <span class="kpi-pill-val a">4 Sites</span>
          <span class="kpi-pill-delta up">‚Üë 3</span>
        </div>
        <div class="kpi-pill">
          <span class="kpi-pill-label">Exposure</span>
          <span class="kpi-pill-val r">$15.0M</span>
          <span class="kpi-pill-delta up">‚Üë $8.2M</span>
        </div>
      </div>
      <div class="live-dot-wrap"><div class="live-dot"></div> LIVE</div>
      <div class="demo-mode-indicator" id="demoModeIndicator" style="display:none"><div class="demo-dot"></div> OFFLINE</div>
      <!-- Tour removed -->
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- INTEL SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Flood Intelligence</span>
        <span class="sidebar-live"><div class="live-dot"></div> Live</span>
      </div>
      <div class="feed" id="intelFeed">
        <div class="feed-item crit" onclick="handle('Investigate Brays Bayou overflow cascade')">
          <div class="feed-time"><span class="feed-sev critical">Critical</span> 15:42 CST</div>
          <div class="feed-text"><strong>MH-101 at 127% capacity.</strong> Brays Bayou trunk surcharging. 0.6 ft to street overflow.</div>
          <div class="feed-tags"><span class="ftag thermal">Overflow</span><span class="ftag grid">Cascade</span></div>
        </div>
        <div class="feed-item crit" onclick="handle('Show all SSO risk locations')">
          <div class="feed-time"><span class="feed-sev critical">Critical</span> 15:38 CST</div>
          <div class="feed-text"><strong>4 SSO locations at risk.</strong> Est. 1.1M gallons. EPA Consent Decree threshold.</div>
          <div class="feed-tags"><span class="ftag thermal">SSO</span><span class="ftag grid">Regulatory</span></div>
        </div>
        <div class="feed-item warn" onclick="handle('What\'s our total flood exposure?')">
          <div class="feed-time"><span class="feed-sev warning">Warning</span> 15:31 CST</div>
          <div class="feed-text"><strong>Exposure: $12.4M direct + $2.5M EPA.</strong> Mitigation window: 45 min remaining.</div>
          <div class="feed-tags"><span class="ftag grid">Financial</span><span class="ftag thermal">Exposure</span></div>
        </div>
        <div class="feed-item warn" onclick="handle('Lift station status across network')">
          <div class="feed-time"><span class="feed-sev warning">Warning</span> 15:24 CST</div>
          <div class="feed-text"><strong>LS-01 Westpark at 92%.</strong> All pumps running ‚Äî zero redundancy. 18/22 stations operational.</div>
          <div class="feed-tags"><span class="ftag water">Lift Station</span><span class="ftag power">Pumps</span></div>
        </div>
        <div class="feed-item warn" onclick="handle('Manhole & pipe inventory summary')">
          <div class="feed-time"><span class="feed-sev warning">Warning</span> 15:18 CST</div>
          <div class="feed-text"><strong>38-year trunk line in Brays corridor.</strong> Joint separation and root intrusion. Condition Grade 3.</div>
          <div class="feed-tags"><span class="ftag grid">Infrastructure</span><span class="ftag water">Aging</span></div>
        </div>
        <div class="feed-item info" onclick="handle('Catchment capacity ranking')">
          <div class="feed-time"><span class="feed-sev info">Info</span> 15:10 CST</div>
          <div class="feed-text"><strong>NWS QPE radar: 3.2 in/hr.</strong> 83,800 residents at risk across Meyerland, Westbury, Bellaire.</div>
          <div class="feed-tags"><span class="ftag weather">Radar</span><span class="ftag power">Forecast</span></div>
        </div>
        <div class="feed-item info" onclick="handle('Investigate Brays Bayou overflow cascade')">
          <div class="feed-time"><span class="feed-sev info">Info</span> 15:02 CST</div>
          <div class="feed-text"><strong>Nexus predicted cascade trajectory</strong> 45 min before static level alarms would trigger ‚Äî diversion to detention basin was still viable.</div>
          <div class="feed-tags"><span class="ftag water">Predictive</span><span class="ftag power">Early Warning</span></div>
        </div>
      </div>
    </div>
    <!-- MAP PANEL -->
    <div class="map-panel">
      <div id="mapView"></div>
      <div class="map-legend">
        <div class="map-legend-title">Sewer Network</div>
        <div class="legend-row"><div class="legend-dot" style="background:var(--accent-red)"></div> Manhole ‚Äî Overflow</div>
        <div class="legend-row"><div class="legend-dot" style="background:var(--accent-amber)"></div> Manhole ‚Äî Stressed</div>
        <div class="legend-row"><div class="legend-dot" style="background:var(--accent-emerald)"></div> Manhole ‚Äî Normal</div>
        <div class="legend-row"><div class="legend-dot" style="background:var(--accent-purple)"></div> SSO Risk Point</div>
        <div class="legend-row"><div class="legend-dot" style="background:var(--accent-cyan)"></div> Lift Station / WWTP</div>
        <div class="legend-row"><div class="legend-dot" style="background:var(--accent-cyan);border-radius:2px"></div> Detention Basin</div>
        <div class="legend-row"><div class="legend-line" style="background:var(--accent-cyan)"></div> Trunk Sewer Line</div>
      </div>
    </div>

    <!-- CHAT PANEL -->
    <div class="chat-panel">
      <div class="chat-header">
        <div class="chat-avatar"><img src="/logo.png" alt="R" style="width:100%;height:100%;object-fit:contain;border-radius:50%" onerror="this.outerHTML='‚ö°'"></div>
        <span class="chat-header-text">Nexus Stormwater Intelligence</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message">
          <div class="msg-head">
            <div class="msg-av ai"><img src="/logo.png" alt="R" style="width:100%;height:100%;object-fit:contain;border-radius:50%" onerror="this.outerHTML='‚ö°'"></div>
            <span class="msg-name">Nexus Stormwater Intelligence</span>
            <span class="msg-time">Just now</span>
          </div>
          <div class="msg-body">
            <strong>üåä FLOOD EVENT ALERT ‚Äî Houston Metro Under Extreme Rainfall</strong><br><br>
            Monitoring <strong>16,737 manholes</strong> and <strong>969 miles</strong> of sewer main across Harris County. Rainfall: <strong>3.2 in/hr</strong> (100-year return period). System capacity exceeded in 3 catchments.<br><br>
            <div class="viz-alert">
              <div class="viz-alert-header critical">üåä CRITICAL ‚Äî 3 Active Overflows, 4 SSO Risk Points</div>
              <div class="viz-alert-row"><span>MH-101 Brays Bayou Trunk</span><span style="color:var(--accent-red)">127% capacity ‚Äî 0.6 ft to street</span></div>
              <div class="viz-alert-row"><span>SSO Risk Points</span><span style="color:var(--accent-red)">4 locations ‚Äî 1.1M gallons estimated</span></div>
              <div class="viz-alert-row"><span>Lift Station LS-01</span><span style="color:var(--accent-amber)">92% ‚Äî zero pump redundancy</span></div>
              <div class="viz-alert-row"><span>69th St WWTP</span><span style="color:var(--accent-amber)">91% headworks capacity</span></div>
            </div>
            Nexus detected the upstream flow acceleration pattern <strong>45 minutes before</strong> traditional level sensors would have alarmed ‚Äî when diversion to the Westpark detention basin was still feasible.<br><br>
            Total flood exposure: <strong>$12.4M direct + $2.5M regulatory = $15.0M</strong>. What would you like to investigate?
          </div>
        </div>
      </div>

      <div class="chips-section">
        <div class="chips-grid" id="chipsGrid">
          <div class="chip" onclick="handle('Investigate Brays Bayou overflow cascade')">üåä Investigate Brays Bayou overflow cascade</div>
          <div class="chip" onclick="handle('Show all SSO risk locations')">üî¥ SSO risk locations</div>
          <div class="chip" onclick="handle('What\'s our total flood exposure?')">üí∞ Total flood exposure</div>
          <div class="chip" onclick="handle('Manhole & pipe inventory summary')">üèóÔ∏è Asset inventory</div>
          <div class="chip" onclick="handle('Lift station status across network')">‚öôÔ∏è Lift station status</div>
          <div class="chip" onclick="handle('Catchment capacity ranking')">üìä Catchment ranking</div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="input-wrap">
          <input type="text" class="chat-input" id="chatInput" placeholder="Ask about flood risks, SSO events, catchment capacity, mitigation options..." />
          <button class="send-btn" id="sendBtn" onclick="handleSend()">Send</button>
        </div>
      </div>
      <div class="chat-footer">Demo of <a href="https://rebirthnexus.ai" target="_blank">Rebirth Nexus</a> ‚Ä¢ Synthetic scenario; Houston parameters are illustrative</div>
    </div>
  </div>
</div>

<!-- TOUR -->
<div class="tour-overlay" id="tourOverlay">
  <div class="tour-tooltip" id="tourTooltip">
    <div class="tour-title" id="tourTitle"></div>
    <div class="tour-text" id="tourText"></div>
    <div class="tour-btns">
      <span class="tour-step-count" id="tourStepCount"></span>
      <div>
        <button class="tour-skip" onclick="endTour()">Skip</button>
        <button class="tour-next" id="tourNext" onclick="nextTourStep()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ESRI MAP -->
<script src="https://js.arcgis.com/4.28/"></script>
<script>
require([
  "esri/Map", "esri/views/MapView",
  "esri/Graphic", "esri/layers/GraphicsLayer", "esri/Color"
], function(Map, MapView, Graphic, GraphicsLayer, Color) {
  const map = new Map({ basemap: "dark-gray-vector" });
  const view = new MapView({
    container: "mapView", map: map,
    center: [-95.37, 29.72], zoom: 11,
    constraints: { minZoom: 9 },
    ui: { components: [] }
  });
  window._mapView = view;
  const ptLyr = new GraphicsLayer();
  const lineLyr = new GraphicsLayer();
  map.addMany([lineLyr, ptLyr]);

  const nodes = [
    { id:"MH-101", name:"Brays Bayou Trunk MH-101", lat:29.70, lon:-95.40, status:"OVERFLOW", type:"Manhole" },
    { id:"MH-204", name:"Sims Bayou Interceptor MH-204", lat:29.66, lon:-95.35, status:"OVERFLOW", type:"Manhole" },
    { id:"MH-312", name:"Buffalo Bayou Junction MH-312", lat:29.76, lon:-95.37, status:"OVERFLOW", type:"Junction" },
    { id:"LS-01", name:"Westpark Lift Station LS-01", lat:29.72, lon:-95.44, status:"STRESSED", type:"Lift Station" },
    { id:"LS-02", name:"Almeda Lift Station LS-02", lat:29.68, lon:-95.38, status:"STRESSED", type:"Lift Station" },
    { id:"LS-03", name:"Hobby Airport Lift Station", lat:29.64, lon:-95.28, status:"NORMAL", type:"Lift Station" },
    { id:"MH-156", name:"Meyerland Trunk MH-156", lat:29.68, lon:-95.44, status:"STRESSED", type:"Manhole" },
    { id:"WWTP", name:"69th St WWTP Headworks", lat:29.72, lon:-95.30, status:"STRESSED", type:"WWTP" },
    { id:"MH-420", name:"Galleria Area MH-420", lat:29.74, lon:-95.46, status:"NORMAL", type:"Manhole" },
    { id:"OUT-01", name:"Buffalo Bayou Outfall", lat:29.77, lon:-95.33, status:"NORMAL", type:"Outfall" },
    { id:"SSO-1", name:"SSO Risk - Bellaire Blvd", lat:29.70, lon:-95.46, status:"SSO_RISK", type:"SSO Point" },
    { id:"SSO-2", name:"SSO Risk - South Main", lat:29.67, lon:-95.37, status:"SSO_RISK", type:"SSO Point" },
    { id:"SSO-3", name:"SSO Risk - Telephone Rd", lat:29.69, lon:-95.32, status:"SSO_RISK", type:"SSO Point" },
    { id:"SSO-4", name:"SSO Risk - Navigation Blvd", lat:29.75, lon:-95.34, status:"SSO_RISK", type:"SSO Point" },
    { id:"DET-1", name:"Westpark Detention Basin", lat:29.71, lon:-95.46, status:"STRESSED", type:"Detention" },
    { id:"DET-2", name:"Brays Bayou Detention (HCFCD)", lat:29.69, lon:-95.42, status:"STRESSED", type:"Detention" },
  ];
  const colors = { OVERFLOW:[239,68,68], STRESSED:[245,158,11], NORMAL:[16,185,129], SSO_RISK:[168,85,247], DETENTION:[34,211,238] };
  nodes.forEach(n => {
    const c = colors[n.status] || [100,100,100];
    const sz = n.status==="OVERFLOW" ? 16 : n.status==="SSO_RISK" ? 13 : n.type==="Lift Station"||n.type==="WWTP" ? 14 : 10;
    const sym = n.type==="Lift Station"||n.type==="WWTP"||n.type==="Outfall"
      ? { type:"simple-marker", color:c, size:sz, style:"diamond", outline:{ color:[255,255,255,80], width:1.5 } }
      : n.type==="Detention"
      ? { type:"simple-marker", color:c, size:14, style:"square", outline:{ color:[255,255,255,80], width:1.5 } }
      : { type:"simple-marker", color:c, size:sz, outline:{ color:[255,255,255,60], width:1 } };
    ptLyr.add(new Graphic({
      geometry: { type:"point", longitude:n.lon, latitude:n.lat },
      symbol: sym, attributes: n,
      popupTemplate: { title:"{name}", content:"Status: {status} | Type: {type}" }
    }));
  });
  const trunks = [
    [[-95.46,29.70],[-95.44,29.70],[-95.40,29.70],[-95.37,29.72],[-95.33,29.77]],
    [[-95.44,29.68],[-95.40,29.70]],
    [[-95.38,29.66],[-95.37,29.68],[-95.37,29.72]],
    [[-95.35,29.66],[-95.32,29.69],[-95.30,29.72]],
    [[-95.37,29.76],[-95.37,29.72],[-95.33,29.77]],
  ];
  trunks.forEach((t,i) => {
    lineLyr.add(new Graphic({
      geometry: { type:"polyline", paths:[t] },
      symbol: { type:"simple-line", color: i<2 ? [34,211,238,160] : [168,85,247,120], width: i<2 ? 2.5 : 1.5 }
    }));
  });
  ptLyr.add(new Graphic({
    geometry: { type:"polygon", rings:[[[-95.48,29.72],[-95.38,29.72],[-95.34,29.68],[-95.36,29.64],[-95.44,29.64],[-95.48,29.68],[-95.48,29.72]]] },
    symbol: { type:"simple-fill", color: new Color([239,68,68,0.08]), outline:{ color: new Color([239,68,68,0.3]), width:1.5, style:"dash" } }
  }));
});


const SYSTEM_PROMPT = `You are Rebirth Nexus Stormwater Intelligence, the AI engine for municipal sewer and stormwater predictive intelligence. You are demonstrating capabilities for Harris County/Houston TX stormwater operations.

SCENARIO: Extreme rainfall event - 3.2 in/hr (100-year return period). System capacity exceeded in 3 catchments. 3 manholes surcharged, 4 SSO risk points, 83,800 residents at risk.

KEY DATA:
- MH-101 Brays Bayou: 127% capacity, 0.6 ft to street overflow
- 4 SSO locations: est. 1.1M gallons total
- Total exposure: $12.4M direct + $2.5M EPA = $15.0M
- Mitigation cost: $270K (ROI: 38:1)
- Nexus detected 45 min before SCADA level sensors

Always include financial impacts. Use HTML formatting with div class="viz-alert" blocks. Be specific with numbers.`;

const API_ENDPOINT = '/api/chat';
let conversationHistory = [];
let isProcessing = false;
let interactionCount = 0;
let demoMode = true; // Default to demo mode for subdirectory deployment

const chipSets={
initial:["üåä Investigate Brays Bayou overflow cascade","üî¥ Show all SSO risk locations","üí∞ What's our total flood exposure?","üèóÔ∏è Manhole & pipe inventory summary","‚öôÔ∏è Lift station status across network","üìä Catchment capacity ranking"],
cascade:["Which neighborhoods flood first?","Show downstream contamination risk","Mitigation: diversion options","Generate emergency work order","Regulatory notification (TCEQ)","‚Ü©Ô∏è Return to overview"],
sso:["SSO volume estimates","EPA/TCEQ reporting requirements","Affected waterways","Emergency bypass pumping options","‚Ü©Ô∏è Return to overview"],
operations:["Deploy emergency bypass pumps","Generate SSO notification to TCEQ","Crew dispatch to MH-312","Activate flood gates at Outfall-01","‚Ü©Ô∏è Return to overview"],
assets:["Pipe condition assessment summary","Manholes due for rehabilitation","Lift station maintenance backlog","CCTV inspection priorities","‚Ü©Ô∏è Return to overview"]
};

const R={
"investigate brays bayou overflow cascade":{
content:`<p><strong>üåä BRAYS BAYOU TRUNK ‚Äî CRITICAL CASCADE OVERFLOW</strong></p>
<div class="vb"><div class="vt">Overflow Status ‚Äî MH-101 (Brays Bayou Trunk)</div>
<div class="vr"><span class="l">Current Flow</span><span class="v red">127% of design capacity</span></div>
<div class="vr"><span class="l">Water Surface Elevation</span><span class="v red">14.2 ft (rim at 14.8 ft)</span></div>
<div class="vr"><span class="l">Surcharge Status</span><span class="v red">SURCHARGING ‚Äî 0.6 ft to street overflow</span></div>
<div class="vr"><span class="l">Rainfall Intensity</span><span class="v red">3.2 in/hr (1-hr intensity, 100-yr return period)</span></div>
<div class="vr"><span class="l">Upstream Catchment</span><span class="v">42 sq mi ‚Äî Meyerland, Bellaire, Westbury</span></div>
<div class="vr"><span class="l">Pipe Diameter</span><span class="v">96" RCP (1987, 38 years old)</span></div>
<div class="vr"><span class="l">Condition Rating</span><span class="v amb">3 (Fair ‚Äî root intrusion, joint separation)</span></div>
</div>
<p><strong>Cascade sequence if MH-101 overflows:</strong></p>
<div class="vb"><div class="vt">Cascade Timeline</div>
<div class="vr"><span class="l">T+0 min</span><span class="v red">MH-101 surcharges to street ‚Üí Brays Bayou Blvd flooding</span></div>
<div class="vr"><span class="l">T+12 min</span><span class="v red">MH-204 (Sims Bayou) overtops ‚Äî backwater effect</span></div>
<div class="vr"><span class="l">T+20 min</span><span class="v red">Combined flow overwhelms MH-312 (Buffalo junction)</span></div>
<div class="vr"><span class="l">T+25 min</span><span class="v amb">4 SSO points activate ‚Äî raw sewage enters bayou</span></div>
<div class="vr"><span class="l">T+45 min</span><span class="v amb">Westpark Lift Station LS-01 overwhelmed ‚Üí emergency bypass</span></div>
<div class="vr"><span class="l">T+2 hrs</span><span class="v amb">69th St WWTP headworks at 140% ‚Äî partial bypass to bayou</span></div>
<div class="vr"><span class="l">T+4 hrs</span><span class="v red">EPA Consent Decree escalation threshold reached ‚Äî enforcement risk elevated</span></div>
</div>
<p>Nexus detected the upstream flow acceleration pattern <strong>45 minutes before</strong> traditional level sensors would alarm ‚Äî when diversion to the detention basin was still feasible.</p>
<div class="prov"><div class="prov-l">Data Sources</div><div class="prov-t"><span class="pt">SCADA Level Sensors</span><span class="pt">USGS Stream Gauges</span><span class="pt">NWS QPE Radar</span><span class="pt">HCFCD Flood Warning</span><span class="pt">Esri Sewer GIS</span></div></div>`,
chips:chipSets.cascade},

"which neighborhoods flood first":{
content:`<p><strong>FLOOD SEQUENCE ‚Äî Neighborhood Impact Analysis</strong></p>
<div class="vb"><div class="vt">Network Trace: MH-101 Overflow ‚Üí Street Flooding</div>
<div class="trace">
<span class="tn src">MH-101 (127%)</span><span class="ta">‚Üí</span>
<span class="tn mid">Brays Bayou Blvd</span><span class="ta">‚Üí</span>
<span class="tn mid">Bellaire Blvd</span><span class="ta">‚Üí</span>
<span class="tn mid">S. Rice Ave</span><span class="ta">‚Üí</span>
<span class="tn end">Meyerland Plaza</span>
</div></div>
<div class="vb"><div class="vt">Impact by Neighborhood (sorted by time to flood)</div>
<table class="vtbl">
<tr><th>Neighborhood</th><th>Pop.</th><th>Flood Time</th><th>Depth (est.)</th><th>Properties</th></tr>
<tr><td class="hl" style="color:var(--red)">Meyerland</td><td>12,400</td><td style="color:var(--red)">T+15 min</td><td>18-24 in</td><td>3,200 homes</td></tr>
<tr><td class="hl" style="color:var(--red)">Westbury</td><td>38,700</td><td style="color:var(--red)">T+25 min</td><td>12-18 in</td><td>8,400 homes</td></tr>
<tr><td class="hl" style="color:var(--amb)">Bellaire</td><td>18,200</td><td style="color:var(--amb)">T+35 min</td><td>6-12 in</td><td>4,100 homes</td></tr>
<tr><td>Braeswood</td><td>8,900</td><td>T+50 min</td><td>6-10 in</td><td>2,300 homes</td></tr>
<tr><td>Willowbend</td><td>5,600</td><td>T+60 min</td><td>4-8 in</td><td>1,400 homes</td></tr>
</table></div>
<p><strong>Summary:</strong> 83,800 residents at risk. 19,400 residential properties. First responders need to focus on Meyerland ‚Äî it floods first and deepest. Estimated property damage: <strong>$8.2M</strong> if no intervention.</p>`,
chips:chipSets.cascade},

"show downstream contamination risk":{
content:`<p><strong>üî¥ CONTAMINATION CASCADE ‚Äî SSO to Waterway Impact</strong></p>
<div class="vb"><div class="vt">Sanitary Sewer Overflow Projections</div>
<div class="vr"><span class="l">SSO-1 (Bellaire Blvd)</span><span class="v red">Est. 340,000 gallons</span></div>
<div class="vr"><span class="l">SSO-2 (South Main)</span><span class="v red">Est. 520,000 gallons</span></div>
<div class="vr"><span class="l">SSO-3 (Telephone Rd)</span><span class="v amb">Est. 180,000 gallons</span></div>
<div class="vr"><span class="l">SSO-4 (Navigation Blvd)</span><span class="v amb">Est. 95,000 gallons</span></div>
<div class="vr" style="border-top:1px solid var(--brd);padding-top:4px;margin-top:4px"><span class="l" style="font-weight:700;color:var(--t1)">TOTAL SSO VOLUME</span><span class="v red">1,135,000 gallons</span></div>
</div>
<div class="vb"><div class="vt">Affected Waterways</div>
<div class="vr"><span class="l">Brays Bayou</span><span class="v red">Direct SSO discharge ‚Äî E. coli spike expected</span></div>
<div class="vr"><span class="l">Sims Bayou</span><span class="v amb">Indirect via tributary ‚Äî 2-hour travel time</span></div>
<div class="vr"><span class="l">Buffalo Bayou</span><span class="v amb">Downstream from junction ‚Äî 4-hour travel time</span></div>
<div class="vr"><span class="l">Houston Ship Channel</span><span class="v">Ultimate receiving water ‚Äî 8-12 hours</span></div>
</div>
<p><strong>Regulatory implications:</strong> All SSOs require TCEQ 24-hour notification regardless of volume. SSOs ‚â•50,000 gallons also trigger mandatory public notification. Four simultaneous SSOs exceeding 1M gallons total will trigger EPA Consent Decree review. Last similar event: Hurricane Harvey (2017).</p>`,
chips:chipSets.sso},

"show all sso risk locations":{
content:`<p><strong>üî¥ SANITARY SEWER OVERFLOW ‚Äî 4 Active Risk Locations</strong></p>
<div class="vb"><div class="vt">SSO Risk Assessment (sorted by urgency)</div>
<table class="vtbl">
<tr><th>Location</th><th>Cause</th><th>Est. Volume</th><th>Time to SSO</th><th>Waterway</th></tr>
<tr><td class="hl" style="color:var(--red)">SSO-2: South Main</td><td>I&I + surcharge</td><td style="color:var(--red)">520K gal</td><td style="color:var(--red)">Active NOW</td><td>Sims Bayou</td></tr>
<tr><td class="hl" style="color:var(--red)">SSO-1: Bellaire Blvd</td><td>Trunk overflow</td><td style="color:var(--red)">340K gal</td><td style="color:var(--red)">~8 min</td><td>Brays Bayou</td></tr>
<tr><td class="hl" style="color:var(--amb)">SSO-3: Telephone Rd</td><td>Lift station backup</td><td style="color:var(--amb)">180K gal</td><td style="color:var(--amb)">~25 min</td><td>Sims Bayou</td></tr>
<tr><td class="hl">SSO-4: Navigation Blvd</td><td>Junction overflow</td><td>95K gal</td><td>~45 min</td><td>Buffalo Bayou</td></tr>
</table></div>
<p><strong>I&I (Inflow & Infiltration)</strong> is the primary driver ‚Äî aging pipes with joint failures and root intrusion are letting stormwater into the sanitary system. This 96" trunk was installed in 1987 and has a condition rating of 3 (Fair). CCTV inspection in 2023 found 47 defects across 12,000 linear feet.</p>`,
chips:chipSets.sso},

"whats our total flood exposure":{
content:`<p><strong>üí∞ TOTAL FLOOD EXPOSURE ‚Äî Houston Sewer/Stormwater Event</strong></p>
<div class="vb"><div class="vt">Financial Impact Breakdown</div>
<div class="vr"><span class="l">Residential Property Damage</span><span class="v red">$5.8M</span></div>
<div class="vr"><span class="l">Commercial/Industrial Damage</span><span class="v red">$2.4M</span></div>
<div class="vr"><span class="l">Emergency Response & Cleanup</span><span class="v amb">$1.2M</span></div>
<div class="vr"><span class="l">SSO Remediation & Disinfection</span><span class="v amb">$0.8M</span></div>
<div class="vr"><span class="l">TCEQ Regulatory Penalties</span><span class="v amb">$1.4M</span></div>
<div class="vr"><span class="l">EPA Consent Decree Fine (if triggered)</span><span class="v red">$2.5M</span></div>
<div class="vr"><span class="l">Infrastructure Repair (pipe, manholes)</span><span class="v">$0.9M</span></div>
<div class="vr" style="border-top:1px solid var(--brd);padding-top:6px;margin-top:4px"><span class="l" style="font-weight:700;color:var(--t1)">TOTAL EXPOSURE</span><span class="v red" style="font-size:14px">$15.0M</span></div>
</div>
<div class="vb"><div class="vt">Proactive Mitigation Cost</div>
<div class="vr"><span class="l">Emergency diversion to Westpark detention basin</span><span class="v grn">$120K</span></div>
<div class="vr"><span class="l">Deploy 3 bypass pumps to SSO-1 and SSO-2</span><span class="v grn">$85K</span></div>
<div class="vr"><span class="l">Emergency crew deployment (4 teams)</span><span class="v grn">$65K</span></div>
<div class="vr" style="border-top:1px solid var(--brd);padding-top:6px;margin-top:4px"><span class="l" style="font-weight:700;color:var(--t1)">TOTAL MITIGATION</span><span class="v grn">$270K</span></div>
</div>
<p><strong>Net protection:</strong> $270K spent protects $10.2M in damages. <strong>ROI: 38:1</strong>. Remaining $4.8M is residual from rain intensity exceeding all available capacity.</p>`,
chips:chipSets.initial},

"manhole pipe inventory summary":{
content:`<p><strong>üèóÔ∏è SEWER ASSET INVENTORY ‚Äî Harris County District</strong></p>
<div class="vb"><div class="vt">Manholes (from Sewer GIS ‚Äî wManhole)</div>
<table class="vtbl">
<tr><th>Type</th><th>Count</th><th>Avg Age</th><th>Avg Depth</th></tr>
<tr><td class="hl">Standard</td><td>14,234</td><td>28 yr</td><td>8.4 ft</td></tr>
<tr><td class="hl">Junction</td><td>1,847</td><td>32 yr</td><td>12.1 ft</td></tr>
<tr><td>Drop</td><td>567</td><td>25 yr</td><td>14.8 ft</td></tr>
<tr><td>Diversion</td><td>89</td><td>18 yr</td><td>10.2 ft</td></tr>
<tr style="border-top:1px solid var(--brd)"><td class="hl">TOTAL</td><td class="hl">16,737</td><td>28.5 yr</td><td>9.1 ft</td></tr>
</table></div>
<div class="vb"><div class="vt">Gravity Mains (from wGravityMain)</div>
<table class="vtbl">
<tr><th>Diameter</th><th>Length (mi)</th><th>Material</th><th>Avg Age</th></tr>
<tr><td>8"</td><td>456</td><td>VCP/PVC</td><td>22 yr</td></tr>
<tr><td>12-15"</td><td>234</td><td>RCP/VCP</td><td>30 yr</td></tr>
<tr><td>18-24"</td><td>156</td><td>RCP</td><td>32 yr</td></tr>
<tr><td>30-48"</td><td>89</td><td>RCP</td><td>35 yr</td></tr>
<tr><td>54-96" (Trunks)</td><td>34</td><td>RCP</td><td>38 yr</td></tr>
<tr style="border-top:1px solid var(--brd)"><td class="hl">TOTAL</td><td class="hl">969 mi</td><td>‚Äî</td><td>27 yr</td></tr>
</table></div>
<div class="vb"><div class="vt">Condition Ratings (NASSCO PACP)</div>
<div class="vr"><span class="l">Grade 1 (Excellent)</span><span class="v grn">12% ‚Äî 116 mi</span></div>
<div class="vr"><span class="l">Grade 2 (Good)</span><span class="v grn">28% ‚Äî 271 mi</span></div>
<div class="vr"><span class="l">Grade 3 (Fair)</span><span class="v amb">34% ‚Äî 329 mi</span></div>
<div class="vr"><span class="l">Grade 4 (Poor)</span><span class="v amb">18% ‚Äî 174 mi</span></div>
<div class="vr"><span class="l">Grade 5 (Immediate attention)</span><span class="v red">8% ‚Äî 78 mi ‚ö†Ô∏è</span></div>
</div>
<p>78 miles of sewer main require immediate rehabilitation or replacement. These Grade 5 segments are the primary I&I contributors driving today's SSO events.</p>`,
chips:chipSets.assets},

"lift station status across network":{
content:`<p><strong>‚öôÔ∏è LIFT STATION STATUS ‚Äî All 22 Stations</strong></p>
<div class="vb"><div class="vt">Station Status Summary</div>
<table class="vtbl">
<tr><th>Station</th><th>Capacity %</th><th>Pumps</th><th>Status</th><th>Wet Well</th></tr>
<tr><td class="hl" style="color:var(--amb)">LS-01 Westpark</td><td style="color:var(--amb)">92%</td><td>3/3 running</td><td style="color:var(--amb)">STRESSED</td><td>High alarm</td></tr>
<tr><td class="hl" style="color:var(--amb)">LS-02 Almeda</td><td style="color:var(--amb)">88%</td><td>2/2 running</td><td style="color:var(--amb)">STRESSED</td><td>High alarm</td></tr>
<tr><td>LS-03 Hobby Airport</td><td>64%</td><td>2/3 running</td><td style="color:var(--grn)">NORMAL</td><td>Normal</td></tr>
<tr><td>LS-04 Clear Lake</td><td>71%</td><td>2/3 running</td><td style="color:var(--grn)">NORMAL</td><td>Normal</td></tr>
<tr><td>LS-05 Spring Branch</td><td>58%</td><td>1/2 running</td><td style="color:var(--grn)">NORMAL</td><td>Normal</td></tr>
</table></div>
<p><strong>Key risk:</strong> LS-01 (Westpark) is running all 3 pumps at 92% ‚Äî no redundancy. If any pump fails during this event, immediate overflow via the 16-inch force main to 69th St WWTP. LS-02 similar risk ‚Äî its 12-inch force main is already at maximum hydraulic grade. Both stations serve the highest-impact trunk lines feeding the Brays Bayou overflow area.</p>
<p>Remaining 17 stations operating normally (45-75% capacity). Emergency bypass pumps (6-inch diesel) staged at LS-01.</p>`,
chips:chipSets.operations},

"generate emergency work order":{
content:`<p><strong>üìã WORK ORDER GENERATED</strong></p>
<div class="wo"><div class="wo-h">WO-2025-STORM-1847 ‚Äî EMERGENCY</div>
<div class="wo-f"><span class="wl">Asset</span><span class="wv">MH-101 (Brays Bayou Trunk), MH-204, MH-312</span></div>
<div class="wo-f"><span class="wl">Issue</span><span class="wv">Surcharged manholes ‚Äî overflow imminent / active</span></div>
<div class="wo-f"><span class="wl">Priority</span><span class="wv" style="color:var(--red)">P1 ‚Äî EMERGENCY</span></div>
<div class="wo-f"><span class="wl">Description</span><span class="wv">100-yr rainfall event (3.2 in/hr). 3 manholes surcharged >85% rim depth. 4 SSO locations at risk. Cascade to WWTP headworks.</span></div>
<div class="wo-f"><span class="wl">Crew</span><span class="wv">Emergency Response Team A + B (12 persons)</span></div>
<div class="wo-f"><span class="wl">Equipment</span><span class="wv">3√ó 6-inch diesel bypass pumps (1,500 GPM each), 500 ft discharge hose per pump, traffic barriers, portable generators, vac truck</span></div>
<div class="wo-f"><span class="wl">Regulatory</span><span class="wv">TCEQ 24-hr SSO notification required for all SSOs regardless of volume</span></div>
<div class="wo-f"><span class="wl">Est. Duration</span><span class="wv">8-12 hours (weather dependent)</span></div>
</div>
<p>Work order synced to Cityworks. TCEQ notification template pre-populated and ready for supervisor approval.</p>`,
chips:chipSets.operations},

"regulatory notification tceq":{
content:`<p><strong>üìã TCEQ SSO NOTIFICATION ‚Äî Pre-Populated</strong></p>
<div class="vb" style="border-color:rgba(155,89,182,.3);background:rgba(155,89,182,.05)">
<div class="vt" style="color:var(--purp)">TCEQ-00501 ‚Äî Water Quality Noncompliance Notification (24-Hour)</div>
<div class="vr"><span class="l">Permitted Entity</span><span class="v">City of Houston ‚Äî WW Permit TX0028070</span></div>
<div class="vr"><span class="l">Date/Time of SSO</span><span class="v">[AUTO-POPULATED FROM SCADA]</span></div>
<div class="vr"><span class="l">Duration</span><span class="v">Ongoing ‚Äî est. 4-8 hours</span></div>
<div class="vr"><span class="l">SSO Locations</span><span class="v">4 locations (Bellaire, S. Main, Telephone, Navigation)</span></div>
<div class="vr"><span class="l">Estimated Volume</span><span class="v red">1,135,000 gallons (combined)</span></div>
<div class="vr"><span class="l">Cause</span><span class="v">Extreme rainfall (3.2 in/hr, 100-yr) exceeding system capacity; I&I through aging infrastructure</span></div>
<div class="vr"><span class="l">Receiving Waters</span><span class="v">Brays Bayou, Sims Bayou, Buffalo Bayou</span></div>
<div class="vr"><span class="l">Corrective Actions</span><span class="v">Bypass pumping deployed, diversion activated, emergency crews on-site</span></div>
<div class="vr"><span class="l">Public Notification</span><span class="v">Posted at SSO locations, downstream public areas</span></div>
</div>
<p>Form pre-populated from real-time SCADA and GIS data. Requires supervisor digital signature before electronic submission to TCEQ. <strong>Deadline: 24 hours from SSO start.</strong> 5-business-day written follow-up also required.</p>
<p style="font-size:11px;color:var(--text-secondary)"><strong>Also triggered:</strong> MS4 permit (Phase I ‚Äî City of Houston) wet-weather reporting ¬∑ CMOM program incident log ¬∑ HCFCD Flood Warning System coordination ¬∑ EPA ECHO consent decree notification</p>`,
chips:chipSets.sso},

"catchment capacity ranking":{
content:`<p><strong>üìä CATCHMENT CAPACITY ‚Äî Ranked by Stress Level</strong></p>
<div class="vb"><div class="vt">Top 10 Catchments (sorted by % capacity used)</div>
<table class="vtbl">
<tr><th>#</th><th>Catchment</th><th>Area (mi¬≤)</th><th>Capacity %</th><th>Pop.</th><th>SSO Risk</th></tr>
<tr><td>1</td><td class="hl" style="color:var(--red)">Brays Bayou Upper</td><td>42</td><td style="color:var(--red)">127%</td><td>84K</td><td style="color:var(--red)">ACTIVE</td></tr>
<tr><td>2</td><td class="hl" style="color:var(--red)">Sims Bayou Central</td><td>28</td><td style="color:var(--red)">134%</td><td>56K</td><td style="color:var(--red)">ACTIVE</td></tr>
<tr><td>3</td><td class="hl" style="color:var(--red)">Buffalo Bayou Junction</td><td>18</td><td style="color:var(--red)">145%</td><td>32K</td><td style="color:var(--red)">ACTIVE</td></tr>
<tr><td>4</td><td class="hl" style="color:var(--amb)">Westpark</td><td>15</td><td style="color:var(--amb)">92%</td><td>24K</td><td style="color:var(--amb)">HIGH</td></tr>
<tr><td>5</td><td style="color:var(--amb)">Almeda</td><td>12</td><td style="color:var(--amb)">88%</td><td>18K</td><td style="color:var(--amb)">HIGH</td></tr>
<tr><td>6</td><td>Meyerland</td><td>8</td><td>87%</td><td>12K</td><td>MODERATE</td></tr>
<tr><td>7</td><td>Galleria</td><td>6</td><td>55%</td><td>28K</td><td style="color:var(--grn)">LOW</td></tr>
<tr><td>8</td><td>Hobby Airport</td><td>14</td><td>64%</td><td>22K</td><td style="color:var(--grn)">LOW</td></tr>
</table></div>
<p>The top 3 catchments are all exceeding 100% design capacity ‚Äî this is the cascading failure zone. Each drains into the other, compounding the problem downstream.</p>`,
chips:chipSets.cascade},

"return to overview":{
content:`<p>Back to the main dashboard. Storm conditions remain active:</p>
<div class="vb"><div class="vt">Current Status</div>
<div class="vr"><span class="l">Active Overflows</span><span class="v red">3 manholes</span></div>
<div class="vr"><span class="l">SSO Risk Points</span><span class="v amb">4 locations (1 active, 3 imminent)</span></div>
<div class="vr"><span class="l">Total Exposure</span><span class="v red">$15.0M (direct + regulatory)</span></div>
<div class="vr"><span class="l">Lift Stations</span><span class="v amb">2 stressed (LS-01 92%, LS-02 88%)</span></div>
<div class="vr"><span class="l">Residents at Risk</span><span class="v red">83,800 across 5 neighborhoods</span></div>
<div class="vr"><span class="l">Mitigation Window</span><span class="v amb">~45 min remaining</span></div>
<div class="vr"><span class="l">Rainfall Forecast</span><span class="v">2.8 in/hr next 2 hours, then diminishing</span></div>
</div><p>What would you like to investigate?</p>`,
chips:chipSets.initial}
};

// ===== ENGINE =====
let isProc=false;
function norm(t){return t.toLowerCase().replace(/[^\w\s]/g,'').replace(/\s+/g,' ').trim()}
function find(t){
const n=norm(t);
for(const[k,v]of Object.entries(R)){if(n===k||n.includes(k)||k.includes(n))return v}
if(n.includes('brays')||n.includes('cascade')||n.includes('overflow'))return R['investigate brays bayou overflow cascade'];
if(n.includes('sso')||n.includes('sanitary'))return R['show all sso risk locations'];
if(n.includes('neighborhood')||n.includes('flood first'))return R['which neighborhoods flood first'];
if(n.includes('contaminat')||n.includes('downstream'))return R['show downstream contamination risk'];
if(n.includes('financial')||n.includes('exposure')||n.includes('cost')||n.includes('dollar'))return R['whats our total flood exposure'];
if(n.includes('manhole')||n.includes('pipe')||n.includes('inventory'))return R['manhole pipe inventory summary'];
if(n.includes('lift')||n.includes('pump')||n.includes('station'))return R['lift station status across network'];
if(n.includes('work order'))return R['generate emergency work order'];
if(n.includes('tceq')||n.includes('regulatory')||n.includes('epa'))return R['regulatory notification tceq'];
if(n.includes('catchment')||n.includes('capacity')||n.includes('ranking'))return R['catchment capacity ranking'];
if(n.includes('overview')||n.includes('return')||n.includes('back'))return R['return to overview'];
return null;
}
function scroll(){document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight}
function addMsg(c,u=false){
const el=document.getElementById('chatMessages'),m=document.createElement('div');
m.className=`msg ${u?'u':'a'}`;
m.innerHTML=`<div class="mb">${u?DOMPurify.sanitize(c):DOMPurify.sanitize(c,{ALLOWED_TAGS:['div','span','strong','em','br','p','b','i','table','tr','td','th','thead','tbody'],ALLOWED_ATTR:['class','style','colspan']})}</div>`;
el.appendChild(m);scroll();
}
function showTyp(){const el=document.getElementById('chatMessages'),m=document.createElement('div');m.className='msg a';m.id='typ';m.innerHTML='<div class="mb"><div class="td"><div class="tdt"></div><div class="tdt"></div><div class="tdt"></div></div></div>';el.appendChild(m);scroll()}
function hideTyp(){const e=document.getElementById('typ');if(e)e.remove()}
function updChips(chips){const g=document.getElementById('chipsGrid');g.innerHTML='';chips.forEach(c=>{const b=document.createElement('button');b.className='chip';if(c.includes('‚Ü©Ô∏è'))b.className+=' ov';b.textContent=c;b.onclick=()=>handle(c);g.appendChild(b)})}
// Map zoom targets
const zoomTargets = {
  "brays": { center: [-95.40, 29.70], zoom: 14 },
  "mh-101": { center: [-95.40, 29.70], zoom: 15 },
  "sso": { center: [-95.40, 29.70], zoom: 12 },
  "neighborhood": { center: [-95.40, 29.70], zoom: 13 },
  "contamina": { center: [-95.37, 29.72], zoom: 12 },
  "financial": { center: [-95.37, 29.72], zoom: 11 },
  "exposure": { center: [-95.37, 29.72], zoom: 11 },
  "manhole": { center: [-95.37, 29.72], zoom: 12 },
  "pipe": { center: [-95.37, 29.72], zoom: 12 },
  "lift": { center: [-95.44, 29.72], zoom: 13 },
  "pump": { center: [-95.44, 29.72], zoom: 13 },
  "work order": { center: [-95.40, 29.70], zoom: 14 },
  "tceq": { center: [-95.37, 29.72], zoom: 11 },
  "regulatory": { center: [-95.37, 29.72], zoom: 11 },
  "catchment": { center: [-95.37, 29.70], zoom: 12 },
  "overview": { center: [-95.37, 29.72], zoom: 11 },
  "return": { center: [-95.37, 29.72], zoom: 11 },
};
function getZoom(text) {
  var t = text.toLowerCase();
  for (var key in zoomTargets) { if (t.indexOf(key) !== -1) return zoomTargets[key]; }
  return null;
}

async function handle(t){
if(isProc)return;isProc=true;addMsg(t,true);showTyp();
var z=getZoom(t);
if(z&&window._mapView){window._mapView.goTo({center:z.center,zoom:z.zoom},{duration:800,easing:"ease-in-out"});}
await new Promise(r=>setTimeout(r,400+Math.random()*400));
const resp=find(t);hideTyp();
if(resp){addMsg(resp.content);updChips(resp.chips||chipSets.initial)}
else{addMsg('<p>I can investigate that area further. The current storm event has 3 active overflow points and 4 SSO risk locations. Try one of the suggested queries for detailed analysis.</p>');updChips(chipSets.initial)}
isProc=false;
}
function handleSend(){const i=document.getElementById('chatInput'),t=i.value.trim();if(!t)return;i.value='';handle(t)}
document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend()}});

updChips(chipSets.initial);
addMsg(`<p><strong>üåä FLOOD EVENT ALERT ‚Äî Houston Metro Area Under Extreme Rainfall</strong></p>
<p>Nexus has detected cascading sewer and stormwater failures across southern Harris County:</p>
<div class="vb">
<div class="vr"><span class="l">Rainfall Intensity</span><span class="v red">3.2 in/hr (100-year return period)</span></div>
<div class="vr"><span class="l">Manholes Surcharged</span><span class="v red">3 critical (MH-101, MH-204, MH-312)</span></div>
<div class="vr"><span class="l">SSO Risk Points</span><span class="v amb">4 locations ‚Äî 1 active overflow</span></div>
<div class="vr"><span class="l">Total Exposure</span><span class="v red">$15.0M (direct + regulatory)</span></div>
<div class="vr"><span class="l">Residents at Risk</span><span class="v">83,800 across 5 neighborhoods</span></div>
</div>
<p>This pattern was detected <strong>45 minutes before</strong> level sensors triggered ‚Äî when diversion to the Westpark detention basin was still feasible. What would you like to investigate?</p>`);

function sendMessage(t) { handle(t); }
</script>
</body>
</html>
