<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus ‚Äî Retail C3 Command Center</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-tertiary: #1a1a24;
            --bg-card: #242430;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            --accent-red: #ef4444;
            --accent-amber: #f59e0b;
            --accent-emerald: #10b981;
            --accent-cyan: #06b6d4;
            --border-subtle: #2a2a3a;
        }
        html, body { height: 100%; overflow: hidden; background: var(--bg-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; color: var(--text-primary); }
        .app-container { display: flex; flex-direction: column; height: 100%; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .alert-feed { width: 300px; background: var(--bg-secondary); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; flex-shrink: 0; }
        .feed-header { padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; background: var(--bg-primary); }
        .feed-title { font-size: 12px; font-weight: 700; color: var(--accent-red); text-transform: uppercase; }
        .feed-live { font-size: 10px; background: rgba(239, 68, 68, 0.2); color: var(--accent-red); padding: 3px 8px; border-radius: 10px; display: flex; align-items: center; gap: 4px; }
        .feed-live::before { content: ""; width: 6px; height: 6px; background: var(--accent-red); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .feed-items { flex: 1; overflow-y: auto; padding: 12px; }
        .feed-item { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .feed-item:hover { border-color: var(--accent-red); transform: translateY(-2px); }
        .feed-item.critical { border-left: 3px solid var(--accent-red); }
        .feed-item.warning { border-left: 3px solid var(--accent-amber); }
        .feed-item.info { border-left: 3px solid var(--accent-cyan); }
        .feed-item.success { border-left: 3px solid var(--accent-emerald); }
        .feed-meta { font-size: 10px; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 6px; }
        .feed-type { text-transform: uppercase; font-weight: 600; }
        .feed-type.critical { color: var(--accent-red); }
        .feed-type.warning { color: var(--accent-amber); }
        .feed-type.info { color: var(--accent-cyan); }
        .feed-type.success { color: var(--accent-emerald); }
        .feed-headline { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .feed-body { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .center-panel { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-primary); }
        #mapView { flex: 1; width: 100%; height: 100%; }
        .stats-overlay { position: absolute; top: 20px; right: 20px; background: rgba(10, 10, 15, 0.95); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 16px; width: 260px; backdrop-filter: blur(8px); z-index: 100; }
        .overlay-title { font-size: 11px; font-weight: 700; color: var(--accent-red); margin-bottom: 14px; text-transform: uppercase; border-bottom: 1px solid var(--border-subtle); padding-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; }
        .stat-label { color: var(--text-muted); }
        .stat-val { font-weight: 600; }
        .stat-val.up { color: var(--accent-emerald); }
        .stat-val.down { color: var(--accent-red); }
        .stat-val.warn { color: var(--accent-amber); }
        .chat-panel { width: 420px; background: var(--bg-secondary); border-left: 1px solid var(--border-subtle); display: flex; flex-direction: column; flex-shrink: 0; }
        .chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 14px; background: var(--bg-primary); }
        .logo-box { width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent-red), #dc2626); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .header-info h2 { font-size: 15px; font-weight: 700; }
        .header-info p { font-size: 10px; color: var(--accent-red); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 2px; }
        .kpi-strip { display: flex; padding: 14px 16px; gap: 12px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-tertiary); }
        .kpi-card { flex: 1; text-align: center; padding: 8px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-subtle); }
        .kpi-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .kpi-val { font-size: 15px; font-weight: 700; }
        .kpi-val.green { color: var(--accent-emerald); }
        .kpi-val.red { color: var(--accent-red); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 20px; max-width: 95%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { margin-left: auto; text-align: right; }
        .message-content { display: inline-block; padding: 14px 18px; border-radius: 14px; font-size: 13px; line-height: 1.6; text-align: left; }
        .message.assistant .message-content { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .message.user .message-content { background: var(--accent-red); color: #fff; font-weight: 500; }
        .viz-roi-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 14px 0; }
        .roi-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px; text-align: center; }
        .roi-card.positive { border-color: var(--accent-emerald); }
        .roi-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }
        .roi-value { font-size: 18px; font-weight: 700; }
        .roi-value.green { color: var(--accent-emerald); }
        .roi-value.red { color: var(--accent-red); }
        .roi-value.amber { color: var(--accent-amber); }
        .viz-risk-matrix { background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 8px; margin: 14px 0; overflow: hidden; }
        .risk-matrix-header { background: var(--bg-card); padding: 10px 14px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border-subtle); }
        .risk-item { display: flex; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--border-subtle); gap: 12px; }
        .risk-item:last-child { border-bottom: none; }
        .risk-level { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .risk-level.critical { background: var(--accent-red); }
        .risk-level.high { background: var(--accent-amber); }
        .risk-info { flex: 1; }
        .risk-name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .risk-detail { font-size: 11px; color: var(--text-muted); }
        .risk-value { font-size: 13px; font-weight: 700; min-width: 60px; text-align: right; }
        .risk-value.red { color: var(--accent-red); }
        .risk-value.amber { color: var(--accent-amber); }
        .viz-timeline { margin: 14px 0; padding-left: 20px; border-left: 2px solid var(--border-subtle); }
        .timeline-item { position: relative; padding: 0 0 20px 20px; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-marker { position: absolute; left: -26px; top: 4px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-secondary); }
        .timeline-marker.red { background: var(--accent-red); }
        .timeline-marker.amber { background: var(--accent-amber); }
        .timeline-time { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
        .timeline-title { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .timeline-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .typing-indicator { display: flex; gap: 4px; padding: 14px 18px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 14px; width: fit-content; }
        .typing-dot { width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%; animation: typingBounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        .input-area { padding: 16px 20px; border-top: 1px solid var(--border-subtle); background: var(--bg-primary); }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
        .chip { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--accent-cyan); padding: 8px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .chip:hover { border-color: var(--accent-red); color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .input-box { display: flex; gap: 10px; }
        .chat-input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: white; padding: 12px 16px; border-radius: 8px; outline: none; font-size: 13px; }
        .chat-input:focus { border-color: var(--accent-red); }
        .send-btn { background: var(--accent-red); color: #fff; border: none; padding: 0 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; }
        .send-btn:hover { background: #dc2626; }
        .send-btn:disabled { background: var(--text-muted); cursor: not-allowed; }
        .map-legend { position: absolute; bottom: 20px; left: 20px; background: rgba(10, 10, 15, 0.95); padding: 14px 16px; border-radius: 8px; border: 1px solid var(--border-subtle); font-size: 11px; z-index: 100; }
        .legend-title { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; color: var(--text-secondary); }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.red { background: var(--accent-red); }
        .legend-dot.amber { background: var(--accent-amber); }
        .legend-dot.green { background: var(--accent-emerald); }
        @media (max-width: 1200px) { .alert-feed { width: 260px; } .chat-panel { width: 380px; } }
        @media (max-width: 1000px) { .alert-feed { display: none; } .stats-overlay { display: none; } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <div class="alert-feed">
                <div class="feed-header">
                    <span class="feed-title">üö® Threat Feed</span>
                    <span class="feed-live">LIVE</span>
                </div>
                <div class="feed-items" id="feedItems"></div>
            </div>
            <div class="center-panel">
                <div id="mapView"></div>
                <div class="stats-overlay">
                    <div class="overlay-title">‚ö†Ô∏è C3 Command Status</div>
                    <div class="stat-row"><span class="stat-label">High Risk Stores</span><span class="stat-val down">47</span></div>
                    <div class="stat-row"><span class="stat-label">ORC Groups Tracked</span><span class="stat-val warn">234</span></div>
                    <div class="stat-row"><span class="stat-label">Prevented Losses (30d)</span><span class="stat-val up">$8.4M</span></div>
                    <div class="stat-row"><span class="stat-label">Alert Accuracy</span><span class="stat-val up">92.7%</span></div>
                </div>
                <div class="map-legend">
                    <div class="legend-title">Store Risk Status</div>
                    <div class="legend-item"><div class="legend-dot red"></div> Critical Risk</div>
                    <div class="legend-item"><div class="legend-dot amber"></div> High Risk</div>
                    <div class="legend-item"><div class="legend-dot green"></div> Normal</div>
                </div>
            </div>
            <div class="chat-panel">
                <div class="chat-header">
                    <div class="logo-box">üéØ</div>
                    <div class="header-info"><h2>NEXUS C3</h2><p>Retail Command Center</p></div>
                </div>
                <div class="kpi-strip">
                    <div class="kpi-card"><div class="kpi-label">Stores</div><div class="kpi-val">2,047</div></div>
                    <div class="kpi-card"><div class="kpi-label">At Risk</div><div class="kpi-val red">47</div></div>
                    <div class="kpi-card"><div class="kpi-label">Shrink ‚Üì</div><div class="kpi-val green">27%</div></div>
                    <div class="kpi-card"><div class="kpi-label">Accuracy</div><div class="kpi-val green">92.7%</div></div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="input-area">
                    <div class="chip-container" id="chipContainer"></div>
                    <div class="input-box">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about threats, stores, or actions...">
                        <button class="send-btn" id="sendBtn">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://js.arcgis.com/4.28/"></script>
    <script>
        const DEMO_TOKEN = 'nexus-retail-2025';
        const INITIAL_CHIPS = ['Show high-risk stores', 'Predict next 72 hours', 'Deploy LP resources', 'ORC group analysis'];
        const FEED_EVENTS = [
            { type: 'critical', title: 'Oakland #2251 Alert', detail: 'Social media chatter + vehicle spotted. 89% hit probability.', delay: 2000 },
            { type: 'warning', title: 'Portland Cluster', detail: '3 stores showing correlated POS anomalies.', delay: 8000 },
            { type: 'success', title: 'Seattle Prevented', detail: 'LP deployment successful. $12,400 intercepted.', delay: 15000 },
            { type: 'info', title: 'Bay Area Pattern', detail: 'Group migration: South Bay to East Bay.', delay: 22000 },
            { type: 'critical', title: 'New ORC Group', detail: '7 members identified, targeting electronics.', delay: 30000 }
        ];
        const scriptedResponses = {
            'show high-risk stores': {
                content: `<p><strong>47 stores at elevated risk:</strong></p>
                <div class="viz-risk-matrix"><div class="risk-matrix-header">‚ö†Ô∏è Immediate Threats (24-48h)</div>
                <div class="risk-item"><div class="risk-level critical"></div><div class="risk-info"><div class="risk-name">Oakland Bayfair #2251</div><div class="risk-detail">Social media + vehicle spotted</div></div><div class="risk-value red">89%</div></div>
                <div class="risk-item"><div class="risk-level critical"></div><div class="risk-info"><div class="risk-name">Portland Lloyd #1426</div><div class="risk-detail">POS anomalies + migration pattern</div></div><div class="risk-value red">84%</div></div>
                <div class="risk-item"><div class="risk-level high"></div><div class="risk-info"><div class="risk-name">Seattle Northgate #1285</div><div class="risk-detail">Historical pattern + weekend timing</div></div><div class="risk-value amber">81%</div></div></div>`,
                chips: ['Deploy LP now', 'See group profiles', 'Notify law enforcement', 'Show prevention ROI']
            },
            'predict next 72 hours': {
                content: `<p><strong>72-Hour Threat Forecast:</strong></p>
                <div class="viz-timeline">
                <div class="timeline-item"><div class="timeline-marker red"></div><div class="timeline-content"><div class="timeline-time">Next 24 Hours</div><div class="timeline-title">Bay Area - 3 Hits Expected</div><div class="timeline-desc">Electronics, Beauty. Est. loss: $127,000</div></div></div>
                <div class="timeline-item"><div class="timeline-marker amber"></div><div class="timeline-content"><div class="timeline-time">24-48 Hours</div><div class="timeline-title">Portland/Seattle Corridor</div><div class="timeline-desc">5 stores at risk during shift changes.</div></div></div>
                <div class="timeline-item"><div class="timeline-marker amber"></div><div class="timeline-content"><div class="timeline-time">48-72 Hours</div><div class="timeline-title">Weekend Surge</div><div class="timeline-desc">12 stores vulnerable. Social coordination +340%.</div></div></div></div>`,
                chips: ['Deploy preventive measures', 'Alert store managers', 'Request LE support']
            },
            'deploy lp resources': {
                content: `<p><strong>LP Deployment Recommendations:</strong></p>
                <div class="viz-roi-cards">
                <div class="roi-card"><div class="roi-label">Stores Covered</div><div class="roi-value">9</div></div>
                <div class="roi-card"><div class="roi-label">Response Time</div><div class="roi-value green">12 min</div></div>
                <div class="roi-card"><div class="roi-label">Est. Prevention</div><div class="roi-value green">$127K</div></div>
                <div class="roi-card"><div class="roi-label">Deployment Cost</div><div class="roi-value">$8.4K</div></div></div>
                <p><strong>ROI:</strong> 15:1 return on LP investment</p>`,
                chips: ['Execute deployment', 'View historical ROI', 'Adjust coverage']
            },
            'orc group analysis': {
                content: `<p><strong>234 ORC Groups Tracked:</strong></p>
                <div class="viz-risk-matrix"><div class="risk-matrix-header">üîç Active High-Threat Groups</div>
                <div class="risk-item"><div class="risk-level critical"></div><div class="risk-info"><div class="risk-name">Bay Area Collective</div><div class="risk-detail">12 members ‚Ä¢ Electronics ‚Ä¢ $890K losses</div></div><div class="risk-value red">Active</div></div>
                <div class="risk-item"><div class="risk-level critical"></div><div class="risk-info"><div class="risk-name">PDX Ring</div><div class="risk-detail">8 members ‚Ä¢ Beauty/Apparel ‚Ä¢ Cross-state</div></div><div class="risk-value red">Active</div></div>
                <div class="risk-item"><div class="risk-level high"></div><div class="risk-info"><div class="risk-name">SoCal Network</div><div class="risk-detail">15+ members ‚Ä¢ Organized resale</div></div><div class="risk-value amber">Tracked</div></div></div>`,
                chips: ['Deep dive: Bay Area', 'View movement patterns', 'LE coordination']
            }
        };
        function normalizeQuery(q) { return q.toLowerCase().trim().replace(/[?!.,]/g, ''); }
        function findResponse(query) {
            const n = normalizeQuery(query);
            if (scriptedResponses[n]) return scriptedResponses[n];
            const keywords = { 'high-risk': 'show high-risk stores', 'risk': 'show high-risk stores', 'stores': 'show high-risk stores', 'predict': 'predict next 72 hours', 'forecast': 'predict next 72 hours', 'deploy': 'deploy lp resources', 'lp': 'deploy lp resources', 'orc': 'orc group analysis', 'group': 'orc group analysis' };
            for (const [k, v] of Object.entries(keywords)) { if (n.includes(k)) return scriptedResponses[v]; }
            return null;
        }
        let conversationHistory = [], isProcessing = false;
        function addMessage(content, isUser, chips = []) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;
            const sanitized = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(content, { ALLOWED_TAGS: ['div', 'p', 'strong', 'br', 'ul', 'li', 'span'], ALLOWED_ATTR: ['class'] }) : content;
            div.innerHTML = `<div class="message-content">${sanitized}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            if (!isUser && chips.length > 0) updateChips(chips);
        }
        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message assistant typing';
            div.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        function removeTypingIndicator() { const t = document.querySelector('.message.typing'); if (t) t.remove(); }
        function updateChips(chips) {
            const container = document.getElementById('chipContainer');
            container.innerHTML = '';
            chips.forEach(text => {
                const btn = document.createElement('button');
                btn.className = 'chip';
                btn.textContent = text;
                btn.onclick = () => handleInput(text);
                container.appendChild(btn);
            });
        }
        async function handleInput(overrideText) {
            if (isProcessing) return;
            const input = document.getElementById('chatInput');
            const text = overrideText || input.value.trim();
            if (!text) return;
            input.value = '';
            isProcessing = true;
            document.getElementById('sendBtn').disabled = true;
            addMessage(text, true);
            conversationHistory.push({ role: 'user', content: text });
            addTypingIndicator();
            const scriptedResponse = findResponse(text);
            if (scriptedResponse) {
                setTimeout(() => {
                    removeTypingIndicator();
                    addMessage(scriptedResponse.content, false, scriptedResponse.chips || INITIAL_CHIPS);
                    conversationHistory.push({ role: 'assistant', content: scriptedResponse.content });
                    isProcessing = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 800 + Math.random() * 400);
            } else {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    const apiResponse = await fetch('/.netlify/functions/retail-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Demo-Token': DEMO_TOKEN },
                        body: JSON.stringify({ message: text, conversationHistory: conversationHistory.slice(-10).map(m => ({ role: m.role, content: m.content.replace(/<[^>]*>/g, '') })) }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!apiResponse.ok) throw new Error('API failed');
                    const data = await apiResponse.json();
                    removeTypingIndicator();
                    let resp = data.response;
                    if (!resp.includes('<div') && !resp.includes('<p>')) resp = resp.split('\n\n').map(p => `<p>${p}</p>`).join('');
                    addMessage(resp, false, INITIAL_CHIPS);
                    conversationHistory.push({ role: 'assistant', content: resp });
                } catch (e) {
                    removeTypingIndicator();
                    addMessage(`<p>I can help with ORC analysis, store risk, and LP deployment. Try "high-risk stores" or "deploy LP".</p>`, false, INITIAL_CHIPS);
                }
                isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }
        function initFeed() {
            const container = document.getElementById('feedItems');
            FEED_EVENTS.forEach(event => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = `feed-item ${event.type}`;
                    div.innerHTML = `<div class="feed-meta"><span>${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span><span class="feed-type ${event.type}">${event.type.toUpperCase()}</span></div><div class="feed-headline">${event.title}</div><div class="feed-body">${event.detail}</div>`;
                    div.style.opacity = '0';
                    container.prepend(div);
                    requestAnimationFrame(() => { div.style.transition = 'opacity 0.3s'; div.style.opacity = '1'; });
                }, event.delay);
            });
        }
        require(['esri/Map', 'esri/views/MapView', 'esri/Graphic', 'esri/layers/GraphicsLayer'], function(Map, MapView, Graphic, GraphicsLayer) {
            const map = new Map({ basemap: 'dark-gray-vector' });
            const view = new MapView({ container: 'mapView', map: map, center: [-98.5, 39.8], zoom: 4 });
            const storeLayer = new GraphicsLayer();
            map.add(storeLayer);
            const stores = [
                { lon: -122.18, lat: 37.72, risk: 'critical' },
                { lon: -122.66, lat: 45.53, risk: 'critical' },
                { lon: -122.32, lat: 47.71, risk: 'high' },
                { lon: -121.89, lat: 37.34, risk: 'high' },
                { lon: -118.24, lat: 34.05, risk: 'medium' },
                { lon: -87.63, lat: 41.88, risk: 'low' },
                { lon: -73.97, lat: 40.78, risk: 'low' }
            ];
            const colors = { critical: '#ef4444', high: '#f59e0b', medium: '#06b6d4', low: '#10b981' };
            stores.forEach(s => {
                storeLayer.add(new Graphic({
                    geometry: { type: 'point', longitude: s.lon, latitude: s.lat },
                    symbol: { type: 'simple-marker', color: colors[s.risk], size: s.risk === 'critical' ? 16 : 12, outline: { color: '#fff', width: 2 } }
                }));
            });
            view.ui.remove('zoom');
        });
        document.addEventListener('DOMContentLoaded', () => {
            updateChips(INITIAL_CHIPS);
            addMessage(`<p><strong>C3 Command Center Active.</strong></p><p>Detecting <span style="color:var(--accent-red)">47 stores at elevated risk</span>. Oakland #2251 shows 89% probability of organized hit in 24-48h.</p>`, false, INITIAL_CHIPS);
            initFeed();
            document.getElementById('sendBtn').addEventListener('click', () => handleInput());
            document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter') handleInput(); });
        });
    </script>
</body>
</html>
