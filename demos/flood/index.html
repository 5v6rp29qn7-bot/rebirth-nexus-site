<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Nexus â€” Climate Risk Forecast Intelligence</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-tertiary: #1a1a24;
  --bg-card: #1e1e2a;
  --bg-card-hover: #262636;
  --border: #2a2a3a;
  --border-accent: #3a3a50;
  --text-primary: #f0f0f5;
  --text-secondary: #a0a0b0;
  --text-muted: #606072;
  --accent-gold: #d4af37;
  --accent-gold-dim: rgba(212,175,55,0.12);
  --accent-emerald: #10b981;
  --accent-emerald-dim: rgba(16,185,129,0.12);
  --accent-cyan: #22d3ee;
  --accent-cyan-dim: rgba(34,211,238,0.10);
  --accent-red: #ef4444;
  --accent-red-dim: rgba(239,68,68,0.10);
  --accent-amber: #f59e0b;
  --accent-amber-dim: rgba(245,158,11,0.10);
  --accent-purple: #a855f7;
  --accent-purple-dim: rgba(168,85,247,0.10);
  --gradient-brand: linear-gradient(135deg, #d4af37 0%, #f59e0b 50%, #ef4444 100%);
  --gradient-subtle: linear-gradient(135deg, rgba(212,175,55,0.08) 0%, rgba(245,158,11,0.05) 100%);
  --shadow: 0 4px 24px rgba(0,0,0,0.5);
  --radius: 10px;
  --radius-sm: 6px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; background: var(--bg-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; color: var(--text-primary); -webkit-font-smoothing: antialiased; }

.app { display: flex; flex-direction: column; height: 100vh; }

/* TOP BAR */
.top-bar {
  height: 48px; min-height: 48px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px; z-index: 100;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-icon { width: 28px; height: 28px; background: transparent; border-radius: 7px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.brand-icon img { width: 100%; height: 100%; object-fit: contain; }
.brand-name { font-size: 14px; font-weight: 600; background: var(--gradient-brand); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.brand-sub { font-size: 10px; color: var(--text-muted); margin-left: 2px; }
.brand-tag { font-size: 9px; color: var(--accent-gold); background: var(--accent-gold-dim); padding: 2px 7px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

.top-right { display: flex; align-items: center; gap: 14px; }
.kpi-ticker { display: flex; align-items: center; gap: 10px; }
.kpi-pill { display: flex; align-items: center; gap: 6px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; padding: 3px 10px; font-size: 10px; }
.kpi-pill-label { color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; font-weight: 500; }
.kpi-pill-val { font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-weight: 700; font-size: 11px; }
.kpi-pill-val.r { color: var(--accent-red); }
.kpi-pill-val.a { color: var(--accent-amber); }
.kpi-pill-val.g { color: var(--accent-emerald); }
.kpi-pill-delta { font-size: 9px; font-family: monospace; }
.kpi-pill-delta.up { color: var(--accent-red); }
.kpi-pill-delta.dn { color: var(--accent-emerald); }

.live-dot-wrap { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--accent-red); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }
.live-dot { width: 5px; height: 5px; background: var(--accent-red); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(239,68,68,0.3)} 50%{opacity:.6;box-shadow:0 0 0 5px rgba(239,68,68,0)} }
.tour-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 11px; padding: 4px 10px; border-radius: 4px; cursor: pointer; transition: all .2s; }
.tour-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

/* MAIN */
.main { flex: 1; display: flex; overflow: hidden; }

/* INTEL SIDEBAR */
.sidebar {
  width: 260px; min-width: 260px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.sidebar-header {
  padding: 12px 14px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.sidebar-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px; }
.sidebar-live { display: flex; align-items: center; gap: 5px; font-size: 9px; color: var(--accent-red); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.sidebar-live .live-dot { width: 4px; height: 4px; }

/* Sidebar Tabs */
.sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); }
.sidebar-tab { flex: 1; padding: 8px; font-size: 10px; text-align: center; cursor: pointer; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; transition: all .2s; border-bottom: 2px solid transparent; }
.sidebar-tab.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }
.sidebar-tab:hover { color: var(--text-secondary); }

.feed { flex: 1; overflow-y: auto; padding: 8px 10px; }
.feed::-webkit-scrollbar { width: 2px; } .feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 1px; }
.feed-item {
  background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 9px 11px; margin-bottom: 6px; cursor: pointer; transition: all .2s;
  border-left: 3px solid var(--accent-cyan);
}
.feed-item:hover { background: var(--bg-card); transform: translateX(2px); }
.feed-item.crit { border-left-color: var(--accent-red); }
.feed-item.warn { border-left-color: var(--accent-amber); }
.feed-item.info { border-left-color: var(--accent-cyan); }
.feed-item.ok { border-left-color: var(--accent-emerald); }
.feed-time { font-size: 9px; color: var(--text-muted); font-family: monospace; margin-bottom: 3px; display: flex; align-items: center; gap: 6px; }
.feed-sev { font-size: 8px; padding: 1px 5px; border-radius: 2px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
.feed-sev.critical { background: var(--accent-red-dim); color: var(--accent-red); }
.feed-sev.warning { background: var(--accent-amber-dim); color: var(--accent-amber); }
.feed-sev.info { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.feed-sev.normal { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.feed-text { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
.feed-text strong { color: var(--text-primary); font-weight: 600; }
.feed-tags { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
.ftag { font-size: 8px; padding: 1px 5px; border-radius: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
.ftag.baron { background: var(--accent-amber-dim); color: var(--accent-amber); }
.ftag.esri { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.ftag.irl { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.ftag.infra { background: var(--accent-red-dim); color: var(--accent-red); }
.ftag.asset { background: var(--accent-gold-dim); color: var(--accent-gold); }
.ftag.mobility { background: var(--accent-purple-dim); color: var(--accent-purple); }

/* MAP PANEL */
.map-panel {
  flex: 1; position: relative; min-width: 0;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
}
#mapView { width: 100%; flex: 1; }
.map-legend {
  position: absolute; bottom: 80px; left: 12px;
  background: rgba(10,10,15,0.92); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  font-size: 10px; z-index: 10; backdrop-filter: blur(8px);
}
.map-legend-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px; }
.legend-section { margin-bottom: 6px; }
.legend-section-title { font-size: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; margin-top: 4px; }
.legend-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; color: var(--text-muted); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.legend-swatch { width: 14px; height: 8px; border-radius: 2px; flex-shrink: 0; }

/* FLOOD SLIDER */
.flood-slider-bar {
  background: var(--bg-secondary); border-top: 1px solid var(--border);
  padding: 8px 16px 10px; z-index: 10;
}
.slider-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.slider-info { display: flex; align-items: center; gap: 10px; }
.baron-badge { font-size: 9px; padding: 2px 8px; border-radius: 3px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
.baron-badge.l1 { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.baron-badge.l2 { background: var(--accent-amber-dim); color: var(--accent-amber); }
.baron-badge.l3 { background: var(--accent-red-dim); color: var(--accent-red); }
.slider-label { font-size: 11px; color: var(--text-primary); font-family: monospace; font-weight: 600; }
.slider-kpis { display: flex; gap: 12px; font-size: 10px; color: var(--text-muted); }
.slider-kpi-val { font-family: monospace; font-weight: 600; margin-left: 4px; }
.slider-kpi-val.r { color: var(--accent-red); }
.slider-kpi-val.a { color: var(--accent-amber); }
.slider-kpi-val.g { color: var(--accent-emerald); }
.slider-controls { display: flex; align-items: center; gap: 10px; }
.play-btn { width: 28px; height: 28px; border-radius: 50%; background: var(--accent-gold-dim); border: 1px solid var(--accent-gold); color: var(--accent-gold); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all .2s; flex-shrink: 0; }
.play-btn:hover { background: var(--accent-gold); color: #000; }
.slider-track-wrap { flex: 1; position: relative; }
.slider-track { width: 100%; height: 6px; -webkit-appearance: none; appearance: none; background: var(--bg-tertiary); border-radius: 3px; outline: none; cursor: pointer; }
.slider-track::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-gold); border: 2px solid var(--bg-secondary); cursor: pointer; box-shadow: 0 0 8px rgba(212,175,55,0.4); }
.slider-track::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--accent-gold); border: 2px solid var(--bg-secondary); cursor: pointer; }
.slider-labels { display: flex; justify-content: space-between; margin-top: 4px; }
.slider-step-label { font-size: 8px; color: var(--text-muted); cursor: pointer; font-family: monospace; padding: 2px 4px; border-radius: 2px; transition: all .2s; }
.slider-step-label:hover { color: var(--accent-gold); }
.slider-step-label.active { color: var(--accent-gold); font-weight: 700; }

/* CHAT PANEL */
.chat-panel {
  width: 380px; min-width: 380px;
  display: flex; flex-direction: column;
  background: var(--bg-primary);
  overflow: hidden;
}
.chat-header {
  padding: 10px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-secondary);
}
.chat-avatar { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 13px; overflow: hidden; }
.chat-avatar img { width: 100%; height: 100%; object-fit: contain; }
.chat-header-text { font-size: 12px; font-weight: 600; color: var(--text-secondary); }

.chat-messages { flex: 1; overflow-y: auto; padding: 14px 16px; scroll-behavior: smooth; }
.chat-messages::-webkit-scrollbar { width: 3px; } .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.message { margin-bottom: 16px; animation: fadeIn .35s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.msg-head { display: flex; align-items: center; gap: 7px; margin-bottom: 6px; }
.msg-av { width: 22px; height: 22px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
.msg-av.ai { overflow: hidden; }
.msg-av.ai img { width: 100%; height: 100%; object-fit: contain; }
.msg-av.user { background: var(--bg-card); border: 1px solid var(--border); }
.msg-name { font-size: 11px; font-weight: 600; color: var(--text-muted); }
.msg-time { font-size: 9px; color: var(--text-muted); font-family: monospace; }
.msg-body { margin-left: 29px; font-size: 13px; line-height: 1.6; color: var(--text-primary); }
.msg-body strong { color: #fff; font-weight: 600; }
.msg-body em { color: var(--text-secondary); }
.msg-body p { margin-bottom: 8px; }

/* Viz components */
.viz-alert { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.viz-alert-header { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); }
.viz-alert-header.critical { background: var(--accent-red-dim); color: var(--accent-red); }
.viz-alert-header.warning { background: var(--accent-amber-dim); color: var(--accent-amber); }
.viz-alert-header.info { background: var(--accent-cyan-dim); color: var(--accent-cyan); }
.viz-alert-header.success { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
.viz-alert-row { display: flex; justify-content: space-between; padding: 6px 12px; font-size: 11px; border-bottom: 1px solid rgba(42,42,58,0.4); }
.viz-alert-row:last-child { border-bottom: none; }
.viz-alert-row span:first-child { color: var(--text-secondary); }
.viz-alert-row span:last-child { color: var(--text-primary); font-family: monospace; font-weight: 500; }

.vb { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; padding: 0; }
.vt { padding: 8px 12px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); color: var(--accent-cyan); }
.vr { display: flex; justify-content: space-between; padding: 6px 12px; font-size: 11px; border-bottom: 1px solid rgba(42,42,58,0.3); gap: 12px; }
.vr:last-child { border-bottom: none; }
.vr .l { color: var(--text-muted); flex-shrink: 0; min-width: 120px; }
.vr .v { color: var(--text-primary); font-family: monospace; font-weight: 500; text-align: right; }
.vr .v.red { color: var(--accent-red); }
.vr .v.amb { color: var(--accent-amber); }
.vr .v.grn { color: var(--accent-emerald); }
.tb { width: 100%; border-collapse: collapse; font-size: 11px; margin: 0; }
.tb th { text-align: left; padding: 6px 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 9px; letter-spacing: 0.3px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); }
.tb td { padding: 5px 10px; color: var(--text-secondary); border-bottom: 1px solid rgba(42,42,58,0.3); }
.tb td.h, .tb td.hl { color: var(--text-primary); font-weight: 600; }
.pv { margin: 10px 0 4px; }
.pl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.pg { display: flex; flex-wrap: wrap; gap: 4px; }
.pt { font-size: 9px; padding: 2px 8px; border-radius: 3px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-muted); }
.an { background: var(--bg-card); border: 1px solid rgba(239,68,68,0.3); border-radius: var(--radius-sm); margin: 10px 0; overflow: hidden; }
.ah { padding: 8px 12px; font-size: 12px; font-weight: 600; background: var(--accent-red-dim); color: var(--accent-red); }
.ab2 { padding: 8px 12px; font-size: 11px; color: var(--text-secondary); line-height: 1.5; }

/* Chips */
.chips-section { padding: 8px 16px; border-top: 1px solid var(--border); }
.chips-grid { display: flex; flex-wrap: wrap; gap: 5px; }
.chip {
  font-size: 10px; padding: 5px 10px; border-radius: 4px;
  background: var(--bg-tertiary); border: 1px solid var(--border);
  color: var(--text-secondary); cursor: pointer; transition: all .2s;
  white-space: nowrap;
}
.chip:hover { border-color: var(--accent-gold); color: var(--accent-gold); background: var(--accent-gold-dim); }
.chip.ov { border-color: var(--border-accent); color: var(--text-muted); }
.chip.ov:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

/* Input */
.chat-input-area { padding: 10px 16px; border-top: 1px solid var(--border); }
.input-wrap { display: flex; gap: 8px; }
.chat-input {
  flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 8px 12px; color: var(--text-primary); font-size: 12px; outline: none; transition: border .2s;
  font-family: inherit;
}
.chat-input::placeholder { color: var(--text-muted); }
.chat-input:focus { border-color: var(--accent-gold); }
.send-btn {
  background: var(--gradient-brand); border: none; color: #000; font-weight: 600;
  padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-size: 11px;
  transition: opacity .2s; font-family: inherit;
}
.send-btn:hover { opacity: 0.9; }
.chat-footer { padding: 6px 16px 10px; font-size: 9px; color: var(--text-muted); text-align: center; }
.chat-footer a { color: var(--accent-gold); text-decoration: none; }

/* Typing indicator */
.td { display: flex; gap: 4px; padding: 8px 0; }
.tdt { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: typingBounce 1.2s ease-in-out infinite; }
.tdt:nth-child(2) { animation-delay: 0.2s; }
.tdt:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-6px);opacity:1} }
.msg .mb { margin-left: 29px; font-size: 13px; line-height: 1.6; }
.msg.u .mb { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px; margin-left: 40px; font-size: 12px; color: var(--text-secondary); }
.msg.a .mb { color: var(--text-primary); }
.msg.a .mb strong { color: #fff; }
.msg.a .mb p { margin-bottom: 8px; }

/* Pulsing asset animation */
@keyframes assetPulse { 0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4)} 50%{box-shadow:0 0 0 8px rgba(245,158,11,0)} }

/* TOUR */
.tour-overlay {
  display: none; position: fixed; inset: 0; z-index: 10000;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
}
.tour-overlay.active { display: block; }
.tour-tooltip {
  position: absolute; background: var(--bg-secondary); border: 1px solid var(--accent-gold);
  border-radius: var(--radius); padding: 16px 18px; max-width: 320px; box-shadow: var(--shadow);
}
.tour-title { font-size: 14px; font-weight: 700; color: var(--accent-gold); margin-bottom: 8px; }
.tour-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
.tour-btns { display: flex; justify-content: space-between; align-items: center; }
.tour-step-count { font-size: 10px; color: var(--text-muted); font-family: monospace; }
.tour-skip { background: none; border: none; color: var(--text-muted); font-size: 11px; cursor: pointer; padding: 4px 8px; }
.tour-skip:hover { color: var(--text-secondary); }
.tour-next {
  background: var(--gradient-brand); border: none; color: #000; font-weight: 600;
  padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 11px;
}
.tour-next:hover { opacity: 0.9; }

/* PASSWORD GATE */
.password-gate { position: fixed; inset: 0; background: #0a0e17; display: flex; align-items: center; justify-content: center; z-index: 99999; }
.password-gate.hidden { display: none; }
.password-box { background: #111827; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 40px; text-align: center; max-width: 400px; width: 90%; }
.pw-logo { width: 64px; height: 64px; background: transparent; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; overflow: hidden; }
.pw-logo img { width: 100%; height: 100%; object-fit: contain; }
.pw-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #f1f5f9; }
.pw-subtitle { font-size: 13px; color: #64748b; margin-bottom: 24px; }
.pw-input { width: 100%; padding: 12px 16px; background: #0a0e17; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #f1f5f9; font-size: 14px; text-align: center; outline: none; margin-bottom: 12px; font-family: inherit; box-sizing: border-box; }
.pw-input:focus { border-color: #fbbf24; }
.pw-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; border-radius: 8px; color: #000; font-weight: 600; font-size: 14px; cursor: pointer; font-family: inherit; }
.pw-btn:hover { opacity: 0.9; }
.pw-error { color: #ef4444; font-size: 12px; margin-top: 8px; display: none; }
.pw-error.show { display: block; }
.pw-footer { font-size: 11px; color: #475569; margin-top: 20px; }
@keyframes pwShake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }
.pw-shake { animation: pwShake 0.4s ease; }

/* Responsive */
@media (max-width: 1200px) {
  .sidebar { width: 220px; min-width: 220px; }
  .chat-panel { width: 340px; min-width: 340px; }
  .kpi-ticker { display: none; }
}
@media (max-width: 900px) {
  .sidebar { display: none; }
  .chat-panel { width: 300px; min-width: 300px; }
}
</style>
</head>
<body>
<!-- PASSWORD GATE -->
<div class="password-gate" id="pwGate">
  <div class="password-box">
    <div class="pw-logo"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='âš¡'"></div>
    <div class="pw-title">Nexus Demo Access</div>
    <div class="pw-subtitle">Predictive Flood Impact Analysis Â· Abu Dhabi</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="Enter access code" autocomplete="off">
    <button class="pw-btn" id="pwBtn">Access Demo</button>
    <div class="pw-error" id="pwError">Incorrect access code</div>
    <div class="pw-footer">Rebirth Nexus Inc. Â· Confidential</div>
  </div>
</div>
<script>
(function(){
  var k='nexus_flood_forecast';
  if(sessionStorage.getItem(k)==='granted'){document.getElementById('pwGate').classList.add('hidden');}
  document.getElementById('pwBtn').onclick=check;
  document.getElementById('pwInput').addEventListener('keydown',function(e){if(e.key==='Enter')check();});
  function check(){
    if(document.getElementById('pwInput').value==='nexus2026'){
      sessionStorage.setItem(k,'granted');
      document.getElementById('pwGate').classList.add('hidden');
    } else {
      var e=document.getElementById('pwError');e.classList.add('show');
      var b=document.querySelector('.password-box');b.classList.add('pw-shake');
      setTimeout(function(){b.classList.remove('pw-shake');},400);
    }
  }
})();
</script>

<div class="app">
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="brand">
      <div class="brand-icon"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='âš¡'"></div>
      <span class="brand-name">Nexus</span>
      <span class="brand-sub">Climate Risk Forecast Intelligence Â· Abu Dhabi</span>
      <span class="brand-tag">Predictive</span>
    </div>
    <div class="top-right">
      <div class="kpi-ticker" id="kpiTicker">
        <div class="kpi-pill">
          <span class="kpi-pill-label">Assets at Risk</span>
          <span class="kpi-pill-val g" id="kpiAssets">0</span>
        </div>
        <div class="kpi-pill">
          <span class="kpi-pill-label">Exposure</span>
          <span class="kpi-pill-val g" id="kpiExposure">â€”</span>
        </div>
        <div class="kpi-pill">
          <span class="kpi-pill-label">Baron Level</span>
          <span class="kpi-pill-val g" id="kpiBaron">1</span>
        </div>
        <div class="kpi-pill">
          <span class="kpi-pill-label">Infrastructure</span>
          <span class="kpi-pill-val g" id="kpiInfra">Normal</span>
        </div>
      </div>
      <div class="live-dot-wrap"><div class="live-dot"></div> LIVE</div>
      <button class="tour-btn" onclick="startTour()">Tour</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- INTEL SIDEBAR -->
    <div class="sidebar" id="sidebarPanel">
      <div class="sidebar-header">
        <span class="sidebar-title">Intel Feed</span>
        <span class="sidebar-live"><div class="live-dot"></div> Live</span>
      </div>
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" id="tabForecast" onclick="switchTab('forecast')">Forecast</div>
        <div class="sidebar-tab" id="tabAssets" onclick="switchTab('assets')">Assets</div>
      </div>
      <div class="feed" id="intelFeed"></div>
      <div class="feed" id="assetsFeed" style="display:none"></div>
    </div>

    <!-- MAP PANEL -->
    <div class="map-panel" id="mapPanel">
      <div id="mapView"></div>
      <div class="map-legend" id="mapLegend">
        <div class="map-legend-title">Flood Forecast</div>
        <div class="legend-section">
          <div class="legend-section-title">Weather</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(180,180,200,0.3)"></div> Cloud cover</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(0,200,0,0.35)"></div> Light rain</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(255,255,0,0.4)"></div> Moderate rain</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(255,165,0,0.45)"></div> Heavy rain</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(255,0,0,0.5)"></div> Extreme rain</div>
        </div>
        <div class="legend-section">
          <div class="legend-section-title">Flood / Assets</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(0,100,255,0.4)"></div> Flood water</div>
          <div class="legend-row"><div class="legend-swatch" style="background:rgba(0,40,160,0.5)"></div> Deep water</div>
          <div class="legend-row"><div class="legend-dot" style="background:#10b981"></div> Asset â€” Safe</div>
          <div class="legend-row"><div class="legend-dot" style="background:#f59e0b"></div> Asset â€” Approaching</div>
          <div class="legend-row"><div class="legend-dot" style="background:#ef4444"></div> Asset â€” In flood zone</div>
        </div>
      </div>

      <!-- FLOOD SLIDER -->
      <div class="flood-slider-bar" id="sliderBar">
        <div class="slider-top">
          <div class="slider-info">
            <span class="baron-badge l1" id="baronBadge">Baron âš¡ Level 1</span>
            <span class="slider-label" id="sliderLabel">T+0: Now</span>
          </div>
          <div class="slider-kpis">
            <span>Assets: <span class="slider-kpi-val g" id="sliderAssets">0</span></span>
            <span>Exposure: <span class="slider-kpi-val g" id="sliderExposure">â€”</span></span>
          </div>
        </div>
        <div class="slider-controls">
          <button class="play-btn" id="playBtn" onclick="toggleAutoPlay()">â–¶</button>
          <div class="slider-track-wrap">
            <input type="range" class="slider-track" id="floodSlider" min="0" max="7" value="0" step="1">
            <div class="slider-labels">
              <span class="slider-step-label active" onclick="jumpToStep(0)">T+0</span>
              <span class="slider-step-label" onclick="jumpToStep(1)">T+1</span>
              <span class="slider-step-label" onclick="jumpToStep(2)">T+2</span>
              <span class="slider-step-label" onclick="jumpToStep(3)">T+3</span>
              <span class="slider-step-label" onclick="jumpToStep(4)">T+4</span>
              <span class="slider-step-label" onclick="jumpToStep(5)">T+5</span>
              <span class="slider-step-label" onclick="jumpToStep(6)">T+6</span>
              <span class="slider-step-label" onclick="jumpToStep(7)">T+7</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT PANEL -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-header">
        <div class="chat-avatar"><img src="/logo.png" alt="R" style="width:100%;height:100%;object-fit:contain;border-radius:50%" onerror="this.outerHTML='âš¡'"></div>
        <span class="chat-header-text">Nexus Climate Risk Intelligence</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message">
          <div class="msg-head">
            <div class="msg-av ai"><img src="/logo.png" alt="R" style="width:100%;height:100%;object-fit:contain;border-radius:50%" onerror="this.outerHTML='âš¡'"></div>
            <span class="msg-name">Nexus Climate Intelligence</span>
            <span class="msg-time">Just now</span>
          </div>
          <div class="msg-body">
            <strong>ðŸŒŠ FLOOD FORECAST INTELLIGENCE â€” Abu Dhabi Region</strong><br><br>
            Good morning. Baron Weather has issued a <strong>Level 1 heavy rain alert</strong> for the Abu Dhabi region. The Extreme Weather Index shows developing conditions over the Gulf with a 7-day forecast window.<br><br>
            <div class="viz-alert">
              <div class="viz-alert-header warning">Current Portfolio Status</div>
              <div class="viz-alert-row"><span>Assets Monitored</span><span>16 across Abu Dhabi</span></div>
              <div class="viz-alert-row"><span>Total Portfolio Value</span><span style="font-weight:700">AED 8.5B</span></div>
              <div class="viz-alert-row"><span>Flood-Vulnerable (below 5m)</span><span style="color:var(--accent-amber)">12 assets</span></div>
              <div class="viz-alert-row"><span>Current Risk Status</span><span style="color:var(--accent-emerald)">NORMAL â€” no action required</span></div>
            </div>
            Use the <strong>forecast slider</strong> below the map to see how this weather event is predicted to develop over the next 7 days and which assets will be affected.<br><br>
            <div class="pv"><div class="pl">Data Sources</div>
            <div class="pg"><span class="pt">Baron Weather EWI</span><span class="pt">Esri World Elevation</span><span class="pt">IRL Mobility</span><span class="pt">Asset Registry</span></div></div>
          </div>
        </div>
      </div>

      <div class="chips-section">
        <div class="chips-grid" id="chipsGrid"></div>
      </div>

      <div class="chat-input-area">
        <div class="input-wrap">
          <input type="text" class="chat-input" id="chatInput" placeholder="Ask about flood exposure, assets, elevation, mitigation..." />
          <button class="send-btn" onclick="handleSend()">Send</button>
        </div>
      </div>
      <div class="chat-footer">Demonstration using synthetic/illustrative data â€” not actual client data.<br>Demo of <a href="https://rebirthnexus.ai" target="_blank">Rebirth Nexus</a> Â· Predictive Flood Impact Analysis</div>
    </div>
  </div>
</div>

<!-- TOUR -->
<div class="tour-overlay" id="tourOverlay">
  <div class="tour-tooltip" id="tourTooltip">
    <div class="tour-title" id="tourTitle"></div>
    <div class="tour-text" id="tourText"></div>
    <div class="tour-btns">
      <span class="tour-step-count" id="tourStepCount"></span>
      <div>
        <button class="tour-skip" onclick="endTour()">Skip</button>
        <button class="tour-next" id="tourNext" onclick="nextTourStep()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ESRI MAP -->
<script src="https://js.arcgis.com/4.28/"></script>
<script>
// ===== FLOOD DATA =====
var currentStep = 0;
var previousStep = -1;
var autoPlayInterval = null;
var autoPlayActive = false;

var stepMeta = [
  { label:"T+0: Now", baron:1, baronLabel:"Baron âš¡ Level 1", baronClass:"l1", assets:0, exposure:"â€”", expClass:"g", infra:"Normal", infraClass:"g" },
  { label:"T+1: +24hr", baron:2, baronLabel:"Baron âš¡ Level 2", baronClass:"l2", assets:4, exposure:"AED 620M", expClass:"a", infra:"Monitoring", infraClass:"g" },
  { label:"T+2: +48hr", baron:2, baronLabel:"Baron âš¡ Level 2", baronClass:"l2", assets:21, exposure:"AED 1.2B", expClass:"a", infra:"Stressed", infraClass:"a" },
  { label:"T+3: +72hr", baron:3, baronLabel:"Baron âš¡ Level 3", baronClass:"l3", assets:45, exposure:"AED 1.8B", expClass:"r", infra:"Stressed", infraClass:"a" },
  { label:"T+4: +96hr", baron:3, baronLabel:"Baron âš¡ Level 3", baronClass:"l3", assets:67, exposure:"AED 2.6B", expClass:"r", infra:"Critical", infraClass:"r" },
  { label:"T+5: +120hr", baron:3, baronLabel:"Baron âš¡ Level 3", baronClass:"l3", assets:89, exposure:"AED 3.4B", expClass:"r", infra:"Critical", infraClass:"r" },
  { label:"T+6: +144hr", baron:2, baronLabel:"Baron âš¡ Level 2", baronClass:"l2", assets:72, exposure:"AED 2.1B", expClass:"a", infra:"Recovering", infraClass:"a" },
  { label:"T+7: +168hr", baron:1, baronLabel:"Baron âš¡ Level 1", baronClass:"l1", assets:28, exposure:"AED 840M", expClass:"a", infra:"Recovering", infraClass:"g" }
];

// Asset definitions: [lon, lat, name, type, value, elevation, floodStep]
var assets = [
  [54.63, 24.50, "Al Reem Island Towers", "residential", "AED 1.2B", "2.8m", 3],
  [54.60, 24.55, "Saadiyat Cultural District", "residential", "AED 890M", "1.8m", 1],
  [54.59, 24.41, "Khalifa City Phase 4", "residential", "AED 340M", "3.5m", 4],
  [54.60, 24.47, "Yas Island Waterfront", "residential", "AED 520M", "4.2m", 5],
  [54.65, 24.50, "Al Maryah Island", "commercial", "AED 1.8B", "12m", 99],
  [54.48, 24.35, "Mussafah Industrial A", "industrial", "AED 180M", "1.2m", 1],
  [54.46, 24.34, "Mussafah Port Services", "industrial", "AED 260M", "0.8m", 1],
  [54.53, 24.33, "ICAD Zone 1", "industrial", "AED 420M", "2.1m", 3],
  [54.54, 24.37, "KIZAD Logistics Hub", "industrial", "AED 310M", "2.1m", 3],
  [54.55, 24.39, "E-12 Highway Bridge", "infrastructure", "â€”", "2.5m", 4],
  [54.50, 24.42, "Abu Dhabi Metro (planned)", "infrastructure", "â€”", "4.0m", 5],
  [54.49, 24.36, "Mussafah Power Substation", "infrastructure", "â€”", "1.5m", 2],
  [54.47, 24.35, "Water Treatment Facility", "infrastructure", "â€”", "1.3m", 2],
  [54.38, 24.49, "Abu Dhabi Mall District", "commercial", "AED 650M", "6.5m", 99],
  [54.35, 24.48, "Corniche Hotel Row", "commercial", "AED 780M", "5.8m", 99],
  [54.63, 24.49, "Reem Mall", "commercial", "AED 1.1B", "3.2m", 5]
];

// ===== REALISTIC FLOOD POLYGONS =====
var floodSteps = {
  0: [],
  1: [
    [[54.455,24.338],[54.46,24.336],[54.463,24.337],[54.467,24.335],[54.47,24.336],[54.473,24.334],[54.477,24.335],[54.48,24.333],[54.484,24.334],[54.488,24.332],[54.492,24.333],[54.495,24.331],[54.498,24.332],[54.50,24.334],[54.498,24.337],[54.496,24.339],[54.493,24.341],[54.49,24.343],[54.487,24.345],[54.484,24.346],[54.48,24.348],[54.477,24.347],[54.474,24.349],[54.47,24.348],[54.467,24.35],[54.464,24.349],[54.461,24.347],[54.458,24.346],[54.456,24.344],[54.454,24.342],[54.455,24.34],[54.455,24.338]],
    [[54.457,24.332],[54.46,24.33],[54.464,24.331],[54.466,24.333],[54.464,24.335],[54.461,24.336],[54.458,24.335],[54.457,24.333],[54.457,24.332]],
    [[54.575,24.557],[54.58,24.558],[54.585,24.559],[54.59,24.558],[54.595,24.559],[54.60,24.558],[54.605,24.559],[54.61,24.558],[54.615,24.557],[54.62,24.556],[54.622,24.554],[54.62,24.552],[54.615,24.551],[54.61,24.552],[54.605,24.551],[54.60,24.552],[54.595,24.553],[54.59,24.552],[54.585,24.553],[54.58,24.554],[54.577,24.555],[54.575,24.557]]
  ],
  2: [
    [[54.445,24.335],[54.45,24.332],[54.455,24.33],[54.46,24.328],[54.465,24.329],[54.47,24.327],[54.475,24.328],[54.48,24.326],[54.485,24.327],[54.49,24.325],[54.495,24.326],[54.50,24.328],[54.505,24.327],[54.51,24.329],[54.515,24.33],[54.52,24.332],[54.522,24.335],[54.52,24.338],[54.518,24.341],[54.515,24.344],[54.512,24.346],[54.51,24.348],[54.507,24.35],[54.504,24.352],[54.50,24.354],[54.497,24.356],[54.493,24.358],[54.49,24.36],[54.486,24.361],[54.482,24.362],[54.478,24.36],[54.474,24.358],[54.47,24.357],[54.466,24.358],[54.462,24.356],[54.458,24.354],[54.455,24.352],[54.452,24.35],[54.45,24.348],[54.448,24.345],[54.446,24.342],[54.445,24.339],[54.445,24.335]],
    [[54.57,24.558],[54.575,24.56],[54.58,24.561],[54.585,24.56],[54.59,24.561],[54.595,24.56],[54.60,24.561],[54.605,24.56],[54.61,24.559],[54.615,24.558],[54.62,24.557],[54.625,24.555],[54.627,24.553],[54.625,24.55],[54.622,24.548],[54.618,24.546],[54.614,24.545],[54.61,24.546],[54.605,24.545],[54.60,24.546],[54.595,24.547],[54.59,24.546],[54.585,24.547],[54.58,24.549],[54.576,24.551],[54.573,24.553],[54.571,24.555],[54.57,24.558]]
  ],
  3: [
    [[54.44,24.33],[54.445,24.327],[54.45,24.324],[54.455,24.322],[54.46,24.32],[54.465,24.321],[54.47,24.32],[54.475,24.319],[54.48,24.32],[54.485,24.319],[54.49,24.32],[54.495,24.321],[54.50,24.322],[54.505,24.323],[54.51,24.324],[54.515,24.325],[54.52,24.327],[54.525,24.329],[54.53,24.331],[54.535,24.333],[54.538,24.336],[54.54,24.339],[54.541,24.342],[54.54,24.345],[54.538,24.348],[54.536,24.351],[54.534,24.354],[54.531,24.357],[54.528,24.36],[54.525,24.362],[54.522,24.364],[54.518,24.366],[54.514,24.368],[54.51,24.37],[54.506,24.371],[54.502,24.372],[54.498,24.373],[54.494,24.374],[54.49,24.375],[54.486,24.374],[54.482,24.373],[54.478,24.372],[54.474,24.37],[54.47,24.368],[54.466,24.366],[54.462,24.364],[54.458,24.362],[54.455,24.36],[54.452,24.357],[54.45,24.354],[54.448,24.351],[54.446,24.348],[54.444,24.345],[54.442,24.342],[54.441,24.339],[54.44,24.336],[54.44,24.33]],
    [[54.618,24.505],[54.62,24.507],[54.623,24.505],[54.625,24.503],[54.627,24.5],[54.629,24.497],[54.63,24.494],[54.631,24.491],[54.63,24.488],[54.628,24.486],[54.626,24.484],[54.624,24.486],[54.622,24.488],[54.62,24.491],[54.619,24.494],[54.618,24.497],[54.617,24.5],[54.617,24.503],[54.618,24.505]],
    [[54.565,24.559],[54.57,24.561],[54.575,24.562],[54.58,24.563],[54.585,24.562],[54.59,24.563],[54.595,24.562],[54.60,24.563],[54.605,24.562],[54.61,24.561],[54.615,24.56],[54.62,24.558],[54.625,24.556],[54.628,24.554],[54.63,24.551],[54.628,24.548],[54.625,24.545],[54.622,24.543],[54.618,24.541],[54.614,24.54],[54.61,24.539],[54.605,24.538],[54.60,24.539],[54.595,24.54],[54.59,24.539],[54.585,24.54],[54.58,24.542],[54.576,24.544],[54.573,24.546],[54.57,24.549],[54.568,24.552],[54.566,24.555],[54.565,24.559]]
  ],
  4: [
    [[54.435,24.325],[54.44,24.32],[54.445,24.317],[54.45,24.315],[54.455,24.313],[54.46,24.312],[54.465,24.313],[54.47,24.312],[54.475,24.313],[54.48,24.312],[54.485,24.313],[54.49,24.314],[54.495,24.315],[54.50,24.316],[54.505,24.317],[54.51,24.318],[54.515,24.32],[54.52,24.322],[54.525,24.324],[54.53,24.326],[54.535,24.329],[54.54,24.332],[54.545,24.335],[54.548,24.338],[54.55,24.341],[54.552,24.345],[54.553,24.349],[54.554,24.353],[54.555,24.357],[54.555,24.361],[54.554,24.365],[54.553,24.369],[54.551,24.373],[54.549,24.377],[54.547,24.38],[54.544,24.383],[54.541,24.386],[54.538,24.389],[54.534,24.391],[54.53,24.393],[54.526,24.394],[54.522,24.395],[54.518,24.394],[54.514,24.393],[54.51,24.392],[54.506,24.391],[54.502,24.39],[54.498,24.389],[54.494,24.388],[54.49,24.387],[54.486,24.385],[54.482,24.383],[54.478,24.381],[54.474,24.379],[54.47,24.377],[54.466,24.375],[54.462,24.373],[54.458,24.37],[54.455,24.367],[54.452,24.364],[54.449,24.361],[54.447,24.358],[54.445,24.355],[54.443,24.351],[54.441,24.347],[54.44,24.343],[54.438,24.339],[54.437,24.335],[54.436,24.331],[54.435,24.327],[54.435,24.325]],
    [[54.615,24.508],[54.618,24.51],[54.622,24.509],[54.626,24.507],[54.629,24.504],[54.632,24.501],[54.634,24.498],[54.636,24.495],[54.637,24.492],[54.638,24.489],[54.637,24.486],[54.636,24.483],[54.634,24.48],[54.631,24.478],[54.628,24.477],[54.625,24.478],[54.622,24.48],[54.62,24.482],[54.618,24.484],[54.616,24.487],[54.615,24.49],[54.614,24.493],[54.613,24.496],[54.613,24.499],[54.613,24.502],[54.614,24.505],[54.615,24.508]],
    [[54.582,24.415],[54.585,24.413],[54.588,24.411],[54.59,24.409],[54.592,24.407],[54.594,24.405],[54.596,24.403],[54.598,24.401],[54.60,24.399],[54.601,24.397],[54.60,24.395],[54.598,24.393],[54.596,24.392],[54.593,24.393],[54.59,24.395],[54.588,24.397],[54.586,24.399],[54.584,24.401],[54.583,24.403],[54.582,24.405],[54.581,24.407],[54.58,24.409],[54.58,24.411],[54.581,24.413],[54.582,24.415]],
    [[54.56,24.56],[54.565,24.562],[54.57,24.563],[54.575,24.564],[54.58,24.565],[54.585,24.564],[54.59,24.565],[54.595,24.564],[54.60,24.565],[54.605,24.564],[54.61,24.563],[54.615,24.562],[54.62,24.56],[54.625,24.558],[54.63,24.555],[54.632,24.552],[54.633,24.549],[54.632,24.546],[54.63,24.543],[54.627,24.54],[54.624,24.537],[54.62,24.535],[54.615,24.534],[54.61,24.533],[54.605,24.532],[54.60,24.533],[54.595,24.534],[54.59,24.533],[54.585,24.534],[54.58,24.536],[54.576,24.538],[54.573,24.54],[54.57,24.543],[54.568,24.546],[54.566,24.549],[54.564,24.552],[54.562,24.555],[54.56,24.558],[54.56,24.56]]
  ],
  5: [
    [[54.43,24.32],[54.435,24.316],[54.44,24.312],[54.445,24.309],[54.45,24.307],[54.455,24.305],[54.46,24.304],[54.465,24.305],[54.47,24.304],[54.475,24.305],[54.48,24.306],[54.485,24.307],[54.49,24.308],[54.495,24.309],[54.50,24.31],[54.505,24.311],[54.51,24.312],[54.515,24.314],[54.52,24.316],[54.525,24.318],[54.53,24.32],[54.535,24.323],[54.54,24.326],[54.545,24.33],[54.55,24.334],[54.554,24.338],[54.557,24.343],[54.559,24.348],[54.56,24.353],[54.561,24.358],[54.561,24.363],[54.56,24.368],[54.559,24.373],[54.557,24.378],[54.555,24.383],[54.552,24.388],[54.549,24.392],[54.546,24.396],[54.542,24.4],[54.538,24.403],[54.534,24.406],[54.53,24.408],[54.526,24.409],[54.522,24.41],[54.518,24.409],[54.514,24.408],[54.51,24.407],[54.506,24.405],[54.502,24.403],[54.498,24.401],[54.494,24.399],[54.49,24.397],[54.486,24.395],[54.482,24.393],[54.478,24.39],[54.474,24.387],[54.47,24.384],[54.466,24.381],[54.462,24.378],[54.458,24.375],[54.455,24.372],[54.452,24.369],[54.449,24.365],[54.447,24.361],[54.445,24.357],[54.443,24.353],[54.441,24.349],[54.439,24.345],[54.437,24.34],[54.436,24.335],[54.434,24.33],[54.433,24.325],[54.43,24.32]],
    [[54.612,24.512],[54.615,24.514],[54.62,24.513],[54.625,24.511],[54.629,24.508],[54.633,24.505],[54.636,24.501],[54.639,24.497],[54.641,24.493],[54.642,24.489],[54.641,24.485],[54.64,24.481],[54.638,24.477],[54.635,24.474],[54.632,24.472],[54.628,24.471],[54.624,24.472],[54.62,24.474],[54.617,24.477],[54.615,24.48],[54.613,24.483],[54.611,24.487],[54.61,24.491],[54.609,24.495],[54.609,24.499],[54.609,24.503],[54.61,24.507],[54.611,24.51],[54.612,24.512]],
    [[54.578,24.418],[54.582,24.416],[54.586,24.413],[54.59,24.41],[54.593,24.407],[54.596,24.404],[54.599,24.401],[54.602,24.398],[54.604,24.395],[54.606,24.392],[54.605,24.389],[54.603,24.387],[54.6,24.385],[54.597,24.384],[54.593,24.385],[54.59,24.387],[54.587,24.389],[54.584,24.392],[54.582,24.395],[54.58,24.398],[54.579,24.401],[54.578,24.404],[54.577,24.407],[54.576,24.41],[54.576,24.413],[54.577,24.416],[54.578,24.418]],
    [[54.555,24.562],[54.56,24.564],[54.565,24.566],[54.57,24.567],[54.575,24.568],[54.58,24.567],[54.585,24.568],[54.59,24.567],[54.595,24.568],[54.60,24.567],[54.605,24.566],[54.61,24.565],[54.615,24.563],[54.62,24.561],[54.625,24.558],[54.63,24.555],[54.633,24.552],[54.635,24.548],[54.636,24.544],[54.635,24.54],[54.633,24.536],[54.63,24.533],[54.626,24.53],[54.622,24.528],[54.618,24.526],[54.614,24.525],[54.61,24.524],[54.605,24.523],[54.6,24.524],[54.595,24.525],[54.59,24.524],[54.585,24.525],[54.58,24.528],[54.576,24.531],[54.572,24.534],[54.569,24.537],[54.566,24.541],[54.563,24.545],[54.561,24.549],[54.559,24.553],[54.557,24.557],[54.556,24.56],[54.555,24.562]],
    [[54.33,24.478],[54.335,24.479],[54.34,24.48],[54.345,24.481],[54.35,24.482],[54.355,24.481],[54.36,24.48],[54.365,24.479],[54.37,24.48],[54.375,24.479],[54.377,24.477],[54.375,24.475],[54.372,24.473],[54.368,24.472],[54.364,24.471],[54.36,24.472],[54.355,24.473],[54.35,24.474],[54.345,24.473],[54.34,24.474],[54.335,24.475],[54.332,24.476],[54.33,24.478]]
  ],
  6: [
    [[54.44,24.328],[54.445,24.324],[54.45,24.321],[54.455,24.318],[54.46,24.316],[54.465,24.317],[54.47,24.316],[54.475,24.317],[54.48,24.318],[54.485,24.319],[54.49,24.32],[54.495,24.321],[54.50,24.322],[54.505,24.323],[54.51,24.325],[54.515,24.327],[54.52,24.329],[54.525,24.332],[54.528,24.335],[54.53,24.339],[54.531,24.343],[54.53,24.347],[54.528,24.351],[54.526,24.355],[54.523,24.358],[54.52,24.361],[54.517,24.364],[54.513,24.366],[54.509,24.368],[54.505,24.369],[54.5,24.37],[54.496,24.371],[54.492,24.37],[54.488,24.369],[54.484,24.368],[54.48,24.366],[54.476,24.364],[54.472,24.362],[54.468,24.36],[54.465,24.358],[54.462,24.355],[54.459,24.352],[54.456,24.349],[54.454,24.346],[54.452,24.342],[54.45,24.338],[54.448,24.334],[54.446,24.331],[54.44,24.328]],
    [[54.617,24.506],[54.62,24.508],[54.623,24.506],[54.626,24.503],[54.628,24.5],[54.63,24.497],[54.631,24.494],[54.632,24.491],[54.631,24.488],[54.63,24.485],[54.628,24.483],[54.625,24.482],[54.622,24.483],[54.62,24.485],[54.618,24.488],[54.616,24.491],[54.615,24.494],[54.614,24.497],[54.614,24.5],[54.615,24.503],[54.617,24.506]],
    [[54.57,24.558],[54.575,24.56],[54.58,24.561],[54.585,24.56],[54.59,24.561],[54.595,24.56],[54.60,24.561],[54.605,24.56],[54.61,24.559],[54.615,24.558],[54.62,24.556],[54.624,24.554],[54.625,24.551],[54.624,24.548],[54.622,24.546],[54.618,24.544],[54.614,24.543],[54.61,24.542],[54.605,24.541],[54.60,24.542],[54.595,24.543],[54.59,24.542],[54.585,24.543],[54.58,24.545],[54.576,24.547],[54.573,24.549],[54.571,24.552],[54.57,24.555],[54.57,24.558]]
  ],
  7: [
    [[54.46,24.338],[54.463,24.336],[54.467,24.335],[54.47,24.334],[54.474,24.335],[54.478,24.334],[54.482,24.335],[54.486,24.336],[54.49,24.337],[54.493,24.339],[54.495,24.341],[54.496,24.344],[54.495,24.347],[54.493,24.35],[54.49,24.352],[54.487,24.354],[54.484,24.355],[54.48,24.356],[54.477,24.355],[54.474,24.354],[54.471,24.352],[54.468,24.35],[54.466,24.348],[54.464,24.345],[54.462,24.342],[54.461,24.34],[54.46,24.338]],
    [[54.45,24.336],[54.453,24.334],[54.456,24.335],[54.458,24.337],[54.456,24.339],[54.453,24.34],[54.451,24.338],[54.45,24.336]],
    [[54.458,24.328],[54.462,24.327],[54.465,24.328],[54.466,24.33],[54.464,24.332],[54.461,24.333],[54.459,24.331],[54.458,24.329],[54.458,24.328]]
  ]
};

var deepWaterOverlays = {
  4: [[[54.465,24.335],[54.47,24.333],[54.475,24.334],[54.48,24.333],[54.485,24.334],[54.49,24.336],[54.492,24.339],[54.493,24.342],[54.492,24.346],[54.49,24.349],[54.487,24.351],[54.483,24.352],[54.479,24.353],[54.475,24.352],[54.471,24.35],[54.468,24.348],[54.466,24.345],[54.465,24.342],[54.464,24.339],[54.465,24.335]]],
  5: [[[54.46,24.332],[54.465,24.33],[54.47,24.328],[54.475,24.329],[54.48,24.328],[54.485,24.329],[54.49,24.33],[54.495,24.333],[54.498,24.336],[54.499,24.34],[54.498,24.344],[54.496,24.348],[54.493,24.352],[54.49,24.355],[54.486,24.357],[54.482,24.358],[54.478,24.357],[54.474,24.356],[54.47,24.354],[54.467,24.351],[54.464,24.348],[54.462,24.345],[54.461,24.341],[54.46,24.338],[54.46,24.335],[54.46,24.332]]],
  6: [[[54.465,24.336],[54.47,24.334],[54.475,24.335],[54.48,24.334],[54.485,24.336],[54.488,24.339],[54.489,24.342],[54.488,24.346],[54.486,24.349],[54.483,24.351],[54.479,24.352],[54.475,24.351],[54.472,24.349],[54.469,24.347],[54.467,24.344],[54.466,24.341],[54.465,24.338],[54.465,24.336]]]
};

// ===== WEATHER POLYGONS =====
var weatherSteps = {
  0: { clouds: [[[54.20,24.62],[54.25,24.64],[54.30,24.65],[54.35,24.66],[54.40,24.66],[54.45,24.65],[54.50,24.63],[54.52,24.61],[54.50,24.58],[54.47,24.56],[54.43,24.55],[54.38,24.55],[54.33,24.56],[54.28,24.57],[54.24,24.58],[54.22,24.60],[54.20,24.62]]], rain: [{coords:[[54.30,24.60],[54.33,24.61],[54.37,24.62],[54.40,24.61],[54.42,24.60],[54.41,24.58],[54.38,24.57],[54.35,24.56],[54.32,24.57],[54.30,24.58],[54.30,24.60]], intensity:"light"}], cloudOpacity: 0.08 },
  1: { clouds: [[[54.25,24.65],[54.30,24.67],[54.35,24.68],[54.40,24.69],[54.45,24.68],[54.50,24.67],[54.55,24.65],[54.60,24.63],[54.63,24.60],[54.62,24.57],[54.60,24.54],[54.57,24.52],[54.53,24.51],[54.48,24.50],[54.43,24.51],[54.38,24.52],[54.33,24.54],[54.30,24.56],[54.27,24.58],[54.25,24.60],[54.24,24.63],[54.25,24.65]]], rain: [{coords:[[54.44,24.57],[54.48,24.58],[54.52,24.57],[54.54,24.55],[54.52,24.53],[54.48,24.52],[54.44,24.53],[54.42,24.55],[54.44,24.57]], intensity:"light"},{coords:[[54.55,24.55],[54.58,24.56],[54.61,24.55],[54.60,24.53],[54.57,24.52],[54.55,24.53],[54.55,24.55]], intensity:"light"}], cloudOpacity: 0.12 },
  2: { clouds: [[[54.20,24.65],[54.28,24.68],[54.36,24.70],[54.44,24.71],[54.52,24.70],[54.60,24.68],[54.67,24.65],[54.72,24.62],[54.74,24.58],[54.73,24.54],[54.70,24.50],[54.66,24.47],[54.61,24.45],[54.55,24.44],[54.49,24.43],[54.43,24.44],[54.37,24.46],[54.32,24.48],[54.28,24.51],[54.25,24.54],[54.22,24.57],[54.21,24.60],[54.20,24.63],[54.20,24.65]]], rain: [{coords:[[54.44,24.50],[54.48,24.52],[54.53,24.52],[54.56,24.50],[54.55,24.47],[54.51,24.46],[54.47,24.46],[54.44,24.48],[54.44,24.50]], intensity:"moderate"},{coords:[[54.56,24.43],[54.59,24.44],[54.62,24.43],[54.61,24.41],[54.58,24.40],[54.56,24.41],[54.56,24.43]], intensity:"light"}], cloudOpacity: 0.15 },
  3: { clouds: [[[54.15,24.62],[54.22,24.67],[54.30,24.71],[54.38,24.73],[54.46,24.74],[54.54,24.73],[54.62,24.71],[54.70,24.68],[54.76,24.64],[54.80,24.59],[54.79,24.54],[54.76,24.49],[54.72,24.45],[54.67,24.42],[54.61,24.39],[54.55,24.38],[54.49,24.37],[54.43,24.38],[54.37,24.39],[54.32,24.42],[54.27,24.45],[54.23,24.49],[54.20,24.53],[54.18,24.57],[54.16,24.60],[54.15,24.62]]], rain: [{coords:[[54.45,24.37],[54.48,24.38],[54.51,24.37],[54.52,24.35],[54.50,24.33],[54.47,24.32],[54.45,24.33],[54.44,24.35],[54.45,24.37]], intensity:"extreme"},{coords:[[54.42,24.44],[54.47,24.47],[54.53,24.48],[54.58,24.47],[54.60,24.44],[54.58,24.41],[54.53,24.39],[54.48,24.39],[54.44,24.40],[54.42,24.42],[54.42,24.44]], intensity:"heavy"},{coords:[[54.55,24.40],[54.59,24.42],[54.63,24.41],[54.65,24.39],[54.63,24.37],[54.59,24.36],[54.56,24.37],[54.55,24.38],[54.55,24.40]], intensity:"moderate"}], cloudOpacity: 0.20 },
  4: { clouds: [[[54.15,24.60],[54.22,24.66],[54.30,24.70],[54.38,24.73],[54.46,24.74],[54.54,24.74],[54.62,24.72],[54.70,24.69],[54.77,24.65],[54.82,24.60],[54.83,24.54],[54.81,24.48],[54.78,24.43],[54.73,24.39],[54.67,24.36],[54.60,24.34],[54.53,24.33],[54.46,24.34],[54.39,24.36],[54.33,24.39],[54.28,24.43],[54.24,24.47],[54.21,24.52],[54.18,24.56],[54.16,24.58],[54.15,24.60]]], rain: [{coords:[[54.46,24.39],[54.49,24.40],[54.52,24.39],[54.54,24.37],[54.52,24.35],[54.49,24.34],[54.47,24.35],[54.46,24.37],[54.46,24.39]], intensity:"extreme"},{coords:[[54.42,24.46],[54.47,24.49],[54.53,24.50],[54.59,24.49],[54.62,24.47],[54.61,24.43],[54.57,24.41],[54.52,24.40],[54.47,24.41],[54.44,24.43],[54.42,24.46]], intensity:"heavy"},{coords:[[54.58,24.42],[54.62,24.44],[54.66,24.43],[54.68,24.41],[54.67,24.38],[54.63,24.37],[54.60,24.38],[54.58,24.40],[54.58,24.42]], intensity:"moderate"}], cloudOpacity: 0.22 },
  5: { clouds: [[[54.20,24.58],[54.27,24.64],[54.35,24.69],[54.43,24.72],[54.51,24.73],[54.59,24.73],[54.67,24.71],[54.75,24.68],[54.82,24.63],[54.86,24.58],[54.87,24.52],[54.85,24.46],[54.82,24.41],[54.77,24.37],[54.71,24.34],[54.64,24.33],[54.57,24.33],[54.50,24.34],[54.43,24.36],[54.37,24.39],[54.32,24.43],[54.28,24.47],[54.25,24.51],[54.23,24.54],[54.21,24.56],[54.20,24.58]]], rain: [{coords:[[54.47,24.41],[54.50,24.42],[54.53,24.41],[54.55,24.39],[54.53,24.37],[54.50,24.36],[54.48,24.37],[54.47,24.39],[54.47,24.41]], intensity:"heavy"},{coords:[[54.44,24.48],[54.50,24.51],[54.57,24.51],[54.62,24.49],[54.63,24.46],[54.60,24.43],[54.55,24.42],[54.50,24.42],[54.46,24.44],[54.44,24.46],[54.44,24.48]], intensity:"moderate"},{coords:[[54.60,24.43],[54.64,24.45],[54.68,24.44],[54.70,24.42],[54.69,24.39],[54.65,24.38],[54.62,24.39],[54.60,24.41],[54.60,24.43]], intensity:"light"}], cloudOpacity: 0.20 },
  6: { clouds: [[[54.45,24.58],[54.52,24.62],[54.60,24.64],[54.68,24.63],[54.75,24.60],[54.80,24.56],[54.82,24.51],[54.80,24.46],[54.77,24.42],[54.72,24.39],[54.66,24.38],[54.60,24.38],[54.54,24.40],[54.49,24.43],[54.46,24.47],[54.44,24.51],[54.44,24.55],[54.45,24.58]],[[54.28,24.55],[54.32,24.57],[54.37,24.57],[54.40,24.55],[54.39,24.52],[54.36,24.50],[54.32,24.50],[54.29,24.52],[54.28,24.55]]], rain: [{coords:[[54.56,24.47],[54.60,24.48],[54.64,24.47],[54.65,24.45],[54.63,24.43],[54.59,24.42],[54.56,24.43],[54.55,24.45],[54.56,24.47]], intensity:"light"},{coords:[[54.62,24.43],[54.65,24.44],[54.68,24.43],[54.68,24.41],[54.66,24.40],[54.63,24.40],[54.62,24.41],[54.62,24.43]], intensity:"moderate"}], cloudOpacity: 0.12 },
  7: { clouds: [[[54.60,24.56],[54.65,24.58],[54.72,24.58],[54.78,24.56],[54.82,24.53],[54.83,24.49],[54.81,24.45],[54.77,24.43],[54.72,24.42],[54.67,24.43],[54.63,24.45],[54.60,24.48],[54.59,24.52],[54.60,24.56]],[[54.80,24.50],[54.83,24.51],[54.86,24.50],[54.87,24.48],[54.85,24.46],[54.82,24.46],[54.80,24.48],[54.80,24.50]]], rain: [{coords:[[54.70,24.48],[54.74,24.49],[54.78,24.48],[54.79,24.46],[54.77,24.44],[54.73,24.44],[54.71,24.45],[54.70,24.47],[54.70,24.48]], intensity:"light"}], cloudOpacity: 0.08 }
};

// ===== FEED CONTENT =====
var feedSteps = {
  0: [
    {sev:"warn", sevLabel:"Warning", text:"<strong>Baron Weather: Level 1 heavy rain developing over Gulf</strong> â€” 7-day monitoring activated", tags:["baron","esri"], handle:"play flood forecast"},
    {sev:"info", sevLabel:"Info", text:"<strong>Esri elevation model:</strong> 12 assets below 3m elevation in Mussafah corridor", tags:["esri","asset"], handle:"show elevation analysis"},
    {sev:"info", sevLabel:"Info", text:"<strong>IRL mobility:</strong> 180,000 daily population in potential impact zones", tags:["irl","mobility"], handle:"portfolio impact summary"},
    {sev:"ok", sevLabel:"Normal", text:"<strong>All critical infrastructure operational</strong> â€” no action required", tags:["infra"], handle:"return to overview"}
  ],
  1: [
    {sev:"warn", sevLabel:"Warning", text:"<strong>Baron Weather ESCALATION: Level 2</strong> â€” rain intensity increasing over Gulf", tags:["baron"], handle:"play flood forecast"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>Mussafah low areas: first ponding detected</strong> â€” Port Services (0.8m) and Industrial A (1.2m)", tags:["asset","esri"], handle:"mussafah asset detail"},
    {sev:"info", sevLabel:"Info", text:"<strong>Saadiyat shore: wave action increasing</strong> â€” Cultural District monitoring activated", tags:["esri","asset"], handle:"show elevation analysis"},
    {sev:"ok", sevLabel:"Normal", text:"<strong>All infrastructure operational</strong> â€” E-12, power grid, water systems normal", tags:["infra"], handle:"return to overview"}
  ],
  2: [
    {sev:"warn", sevLabel:"Warning", text:"<strong>Mussafah flood expanding along channel corridor</strong> â€” water reaching industrial facilities", tags:["asset","esri"], handle:"mussafah asset detail"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>Power Substation monitoring activated</strong> â€” flood level rising toward 1.5m threshold", tags:["infra","asset"], handle:"show transmission cascade"},
    {sev:"info", sevLabel:"Info", text:"<strong>IRL mobility: foot traffic dropping 15%</strong> in Mussafah corridor", tags:["irl","mobility"], handle:"portfolio impact summary"},
    {sev:"ok", sevLabel:"Normal", text:"<strong>E-12 highway clear</strong> â€” monitoring T+3/T+4 forecast", tags:["infra"], handle:"play flood forecast"}
  ],
  3: [
    {sev:"crit", sevLabel:"Critical", text:"<strong>Baron Weather ESCALATION: Level 3</strong> â€” widespread infrastructure flooding likely", tags:["baron","infra"], handle:"play flood forecast"},
    {sev:"crit", sevLabel:"Critical", text:"<strong>Mussafah Industrial: 18 assets in active flood zone</strong> â€” AED 860M exposed", tags:["asset","esri"], handle:"mussafah asset detail"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>Al Reem Island: flood waters approaching from channel</strong> â€” 3 residential towers in path", tags:["asset","esri"], handle:"al reem island risk"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>IRL mobility: 45,000 daily visitors in affected zones</strong> â€” evacuation planning recommended", tags:["irl","mobility"], handle:"portfolio impact summary"},
    {sev:"info", sevLabel:"Info", text:"<strong>E-12 highway currently clear</strong> â€” monitor T+4 forecast", tags:["infra"], handle:"play flood forecast"}
  ],
  4: [
    {sev:"crit", sevLabel:"Critical", text:"<strong>E-12 highway THREATENED</strong> â€” flood waters 200m from road surface", tags:["infra"], handle:"show transmission cascade"},
    {sev:"crit", sevLabel:"Critical", text:"<strong>KIZAD access road compromised</strong> â€” 400+ daily truck movements rerouting", tags:["infra","asset"], handle:"mussafah asset detail"},
    {sev:"crit", sevLabel:"Critical", text:"<strong>Baron sustained Level 3</strong> â€” 67 assets in flood zone, AED 2.6B exposed", tags:["baron","asset"], handle:"portfolio impact summary"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>Al Reem residential: evacuation notification issued</strong> â€” 3,800 residents affected", tags:["asset"], handle:"al reem island risk"},
    {sev:"info", sevLabel:"Info", text:"<strong>Khalifa City: channel flooding along drainage corridor</strong>", tags:["esri"], handle:"show elevation analysis"}
  ],
  5: [
    {sev:"crit", sevLabel:"Critical", text:"<strong>PEAK EVENT: 89 assets in flood zone</strong> â€” AED 3.4B total exposure", tags:["asset","baron"], handle:"portfolio impact summary"},
    {sev:"crit", sevLabel:"Critical", text:"<strong>E-12 highway IMPASSABLE</strong> â€” Abu Dhabi island access compromised", tags:["infra"], handle:"show transmission cascade"},
    {sev:"crit", sevLabel:"Critical", text:"<strong>Mussafah Power Substation: flood level at facility threshold</strong> â€” grid impact imminent", tags:["infra","asset"], handle:"mussafah asset detail"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>Baron Weather: recession expected T+6</strong> â€” prepare recovery operations", tags:["baron"], handle:"mitigation recommendations"},
    {sev:"info", sevLabel:"Info", text:"<strong>IRL mobility: 89,000 daily visitors displaced</strong> â€” economic impact AED 12M/day", tags:["irl","mobility"], handle:"portfolio impact summary"}
  ],
  6: [
    {sev:"warn", sevLabel:"Warning", text:"<strong>Baron Weather DOWNGRADE: Level 2</strong> â€” recession beginning, rain intensity falling", tags:["baron"], handle:"play flood forecast"},
    {sev:"warn", sevLabel:"Warning", text:"<strong>Flood waters receding from edges</strong> â€” Mussafah core basin still 0.4m deep", tags:["esri","asset"], handle:"mussafah asset detail"},
    {sev:"info", sevLabel:"Info", text:"<strong>Recovery crews mobilizing</strong> â€” infrastructure assessment teams deploying", tags:["infra"], handle:"mitigation recommendations"},
    {sev:"info", sevLabel:"Info", text:"<strong>IRL mobility: foot traffic recovering in peripheral zones</strong> â€” core areas still depressed", tags:["irl","mobility"], handle:"portfolio impact summary"}
  ],
  7: [
    {sev:"info", sevLabel:"Info", text:"<strong>Baron Weather: Level 1</strong> â€” storm system moving east, residual ponding only", tags:["baron"], handle:"play flood forecast"},
    {sev:"info", sevLabel:"Info", text:"<strong>Residual ponding: 3 pools in Mussafah</strong> â€” drainage expected within 48hr", tags:["esri"], handle:"mussafah asset detail"},
    {sev:"info", sevLabel:"Info", text:"<strong>Infrastructure assessment underway</strong> â€” E-12 reopening, substation inspection in progress", tags:["infra"], handle:"show transmission cascade"},
    {sev:"ok", sevLabel:"Normal", text:"<strong>Property inspection teams deployed</strong> â€” 28 assets pending damage assessment", tags:["asset"], handle:"portfolio impact summary"}
  ]
};

// ===== ESRI MAP INIT =====
require([
  "esri/Map", "esri/views/MapView",
  "esri/Graphic", "esri/layers/GraphicsLayer",
  "esri/geometry/Polygon", "esri/geometry/Point"
], function(Map, MapView, Graphic, GraphicsLayer, Polygon, Point) {
  var map = new Map({ basemap: "dark-gray-vector" });
  var view = new MapView({
    container: "mapView", map: map,
    center: [54.53, 24.45], zoom: 11,
    constraints: { minZoom: 9 },
    ui: { components: [] }
  });
  window._mapView = view;
  window._Graphic = Graphic;
  window._Polygon = Polygon;

  var cloudLayer = new GraphicsLayer({ opacity: 0.8 });
  var rainLayer = new GraphicsLayer({ opacity: 0.8 });
  var floodLayer = new GraphicsLayer({ opacity: 0.9 });
  var deepFloodLayer = new GraphicsLayer({ opacity: 0.9 });
  var assetLayer = new GraphicsLayer();
  map.addMany([rainLayer, cloudLayer, floodLayer, deepFloodLayer, assetLayer]);

  window._cloudLayer = cloudLayer;
  window._rainLayer = rainLayer;
  window._floodLayer = floodLayer;
  window._deepFloodLayer = deepFloodLayer;
  window._assetLayer = assetLayer;

  var assetGraphics = [];
  assets.forEach(function(a, i) {
    var style = "circle";
    var sz = 10;
    if (a[3] === "industrial") { style = "diamond"; sz = 11; }
    else if (a[3] === "infrastructure") { style = "square"; sz = 10; }
    else if (a[3] === "commercial") { style = "circle"; sz = 11; }
    var g = new Graphic({
      geometry: { type: "point", longitude: a[0], latitude: a[1] },
      symbol: { type: "simple-marker", color: [16,185,129], size: sz, style: style, outline: { color: [255,255,255,80], width: 1.5 } },
      attributes: { name: a[2], type: a[3], value: a[4], elevation: a[5], floodStep: a[6], idx: i, origSize: sz },
      popupTemplate: { title: "{name}", content: "Type: {type} | Value: {value} | Elev: {elevation}" }
    });
    assetLayer.add(g);
    assetGraphics.push(g);
  });
  window._assetGraphics = assetGraphics;
  window._prevAssetColors = assets.map(function() { return "green"; });

  updateFeed(0);
  setFloodStep(0);
});

// ===== SLIDER FUNCTIONS =====
function setFloodStep(step) {
  previousStep = currentStep;
  currentStep = step;
  var meta = stepMeta[step];

  document.getElementById('floodSlider').value = step;
  document.getElementById('sliderLabel').textContent = meta.label;
  document.getElementById('baronBadge').textContent = meta.baronLabel;
  document.getElementById('baronBadge').className = 'baron-badge ' + meta.baronClass;
  document.getElementById('sliderAssets').textContent = meta.assets;
  document.getElementById('sliderAssets').className = 'slider-kpi-val ' + meta.expClass;
  document.getElementById('sliderExposure').textContent = meta.exposure;
  document.getElementById('sliderExposure').className = 'slider-kpi-val ' + meta.expClass;

  document.getElementById('kpiAssets').textContent = meta.assets;
  document.getElementById('kpiAssets').className = 'kpi-pill-val ' + (meta.assets > 40 ? 'r' : meta.assets > 0 ? 'a' : 'g');
  document.getElementById('kpiExposure').textContent = meta.exposure;
  document.getElementById('kpiExposure').className = 'kpi-pill-val ' + meta.expClass;
  document.getElementById('kpiBaron').textContent = meta.baron;
  document.getElementById('kpiBaron').className = 'kpi-pill-val ' + (meta.baron >= 3 ? 'r' : meta.baron >= 2 ? 'a' : 'g');
  document.getElementById('kpiInfra').textContent = meta.infra;
  document.getElementById('kpiInfra').className = 'kpi-pill-val ' + meta.infraClass;

  document.querySelectorAll('.slider-step-label').forEach(function(el, i) {
    el.className = 'slider-step-label' + (i === step ? ' active' : '');
  });

  if (window._floodLayer && window._Graphic) {
    window._floodLayer.removeAll();
    window._deepFloodLayer.removeAll();
    var polys = floodSteps[step] || [];
    var isResidual = (step === 7);
    var baseColor = isResidual ? [40, 80, 140] : [0, 100, 255];
    var baseOpacity = isResidual ? 0.30 : (0.22 + (step <= 5 ? step * 0.04 : (7 - step) * 0.04));
    var outlineColor = isResidual ? [60, 120, 180, 0.4] : [0, 200, 255, 0.5];
    polys.forEach(function(ring) {
      window._floodLayer.add(new window._Graphic({
        geometry: new window._Polygon({ rings: [ring], spatialReference: { wkid: 4326 } }),
        symbol: { type: "simple-fill", color: [baseColor[0], baseColor[1], baseColor[2], baseOpacity], outline: { color: outlineColor, width: 0.8 } }
      }));
    });
    var deepPolys = deepWaterOverlays[step] || [];
    deepPolys.forEach(function(ring) {
      window._deepFloodLayer.add(new window._Graphic({
        geometry: new window._Polygon({ rings: [ring], spatialReference: { wkid: 4326 } }),
        symbol: { type: "simple-fill", color: [0, 40, 160, 0.50], outline: { width: 0 } }
      }));
    });
  }

  if (window._cloudLayer && window._rainLayer) {
    window._cloudLayer.removeAll();
    window._rainLayer.removeAll();
    var ws = weatherSteps[step];
    if (ws) {
      var cloudOpacity = ws.cloudOpacity || 0.12;
      ws.clouds.forEach(function(ring) {
        window._cloudLayer.add(new window._Graphic({
          geometry: new window._Polygon({ rings: [ring], spatialReference: { wkid: 4326 } }),
          symbol: { type: "simple-fill", color: [180, 180, 200, cloudOpacity], outline: { width: 0 } }
        }));
      });
      var rainColors = { light: [0,200,0,0.18], moderate: [255,255,0,0.22], heavy: [255,165,0,0.28], extreme: [255,0,0,0.33] };
      ws.rain.forEach(function(zone) {
        window._rainLayer.add(new window._Graphic({
          geometry: new window._Polygon({ rings: [zone.coords], spatialReference: { wkid: 4326 } }),
          symbol: { type: "simple-fill", color: rainColors[zone.intensity] || [0,200,0,0.18], outline: { width: 0 } }
        }));
      });
    }
  }

  // ===== FIX #1: Asset markers â€” prevent amber at T+0 =====
  if (window._assetGraphics && window._prevAssetColors) {
    window._assetGraphics.forEach(function(g, idx) {
      var fs = g.attributes.floodStep;
      var origSize = g.attributes.origSize;
      var style = g.symbol.style;
      var color, colorKey;

      if (step >= fs) {
        color = [239, 68, 68]; colorKey = "red";
      } else if (step >= fs - 1 && step > 0 && fs <= 7) {
        // FIX: Added "step > 0" so T+0 shows all assets green
        color = [245, 158, 11]; colorKey = "amber";
      } else {
        color = [16, 185, 129]; colorKey = "green";
      }

      var prevColor = window._prevAssetColors[idx];
      var didChange = (prevColor !== colorKey);
      window._prevAssetColors[idx] = colorKey;

      if (didChange && colorKey !== "green") {
        g.symbol = { type: "simple-marker", color: color, size: origSize + 5, style: style, outline: { color: [255,255,255,200], width: 3 } };
        (function(graphic, col, sz, st) {
          setTimeout(function() {
            graphic.symbol = { type: "simple-marker", color: col, size: sz, style: st, outline: { color: [255,255,255,80], width: 1.5 } };
          }, 800);
        })(g, color, origSize, style);
      } else {
        g.symbol = { type: "simple-marker", color: color, size: origSize, style: style, outline: { color: [255,255,255,80], width: 1.5 } };
      }
    });
  }

  updateFeed(step);
}

function updateFeed(step) {
  var items = feedSteps[step] || feedSteps[0];
  var feed = document.getElementById('intelFeed');
  feed.innerHTML = '';
  items.forEach(function(item) {
    var sevClass = item.sev;
    var sevLabelClass = item.sevLabel.toLowerCase();
    var tagsHtml = item.tags.map(function(t) { return '<span class="ftag ' + t + '">' + t.charAt(0).toUpperCase() + t.slice(1) + '</span>'; }).join('');
    feed.innerHTML += '<div class="feed-item ' + sevClass + '" onclick="handle(\'' + item.handle.replace(/'/g, "\\'") + '\')">' +
      '<div class="feed-time"><span class="feed-sev ' + sevLabelClass + '">' + item.sevLabel + '</span> ' + stepMeta[step].label + '</div>' +
      '<div class="feed-text">' + item.text + '</div>' +
      '<div class="feed-tags">' + tagsHtml + '</div></div>';
  });
}

function populateAssetsTab() {
  var feed = document.getElementById('assetsFeed');
  feed.innerHTML = '';
  assets.forEach(function(a, i) {
    var typeEmoji = a[3] === 'residential' ? 'ðŸ ' : a[3] === 'industrial' ? 'â—†' : a[3] === 'infrastructure' ? 'â– ' : 'â˜…';
    feed.innerHTML += '<div class="feed-item info" onclick="handle(\'' + a[2].replace(/'/g, "\\'") + '\')">' +
      '<div class="feed-time"><span class="feed-sev info">' + a[3] + '</span> ' + a[5] + ' elev</div>' +
      '<div class="feed-text"><strong>' + typeEmoji + ' ' + a[2] + '</strong><br>' + a[4] + '</div>' +
      '<div class="feed-tags"><span class="ftag asset">' + a[3] + '</span></div></div>';
  });
}
populateAssetsTab();

function switchTab(tab) {
  document.getElementById('tabForecast').className = 'sidebar-tab' + (tab === 'forecast' ? ' active' : '');
  document.getElementById('tabAssets').className = 'sidebar-tab' + (tab === 'assets' ? ' active' : '');
  document.getElementById('intelFeed').style.display = tab === 'forecast' ? '' : 'none';
  document.getElementById('assetsFeed').style.display = tab === 'assets' ? '' : 'none';
}

function jumpToStep(s) { setFloodStep(s); }

document.getElementById('floodSlider').addEventListener('input', function() {
  setFloodStep(parseInt(this.value));
});

function toggleAutoPlay() {
  if (autoPlayActive) {
    clearInterval(autoPlayInterval);
    autoPlayActive = false;
    document.getElementById('playBtn').textContent = 'â–¶';
  } else {
    autoPlayActive = true;
    document.getElementById('playBtn').textContent = 'â¸';
    var s = currentStep >= 7 ? 0 : currentStep;
    setFloodStep(s);
    autoPlayInterval = setInterval(function() {
      s++;
      if (s > 7) {
        clearInterval(autoPlayInterval);
        autoPlayActive = false;
        document.getElementById('playBtn').textContent = 'â–¶';
        return;
      }
      setFloodStep(s);
    }, 3000);
  }
}

// ===== TOUR =====
var tourSteps = [
  { title: "Welcome", text: "Predictive Flood Intelligence. See how a weather event will affect your assets before it happens â€” with 5 to 7 days of advance warning.", pos: { top: "50%", left: "50%", transform: "translate(-50%,-50%)" } },
  { title: "Map & Assets", text: "Your portfolio mapped against Esri elevation data. Each asset color-coded by current flood risk status â€” green (safe), amber (approaching), red (in flood zone).", pos: { top: "40%", left: "45%", transform: "translate(-50%,-50%)" } },
  { title: "Forecast Slider", text: "Drag the timeline to see how flood waters spread over 7 days. Based on Baron Weather's Extreme Weather Index and Abu Dhabi topographic data.", pos: { bottom: "120px", left: "45%", transform: "translateX(-50%)" } },
  { title: "Intel Feed", text: "Real-time alerts update as the forecast progresses. Baron Weather signals, asset status changes, and infrastructure impact warnings.", pos: { top: "40%", left: "150px" } },
  { title: "Chat Interface", text: "Ask any question about your assets, exposure, or mitigation options. Every answer includes data provenance and economic impact quantification.", pos: { top: "40%", right: "200px" } },
  { title: "Ready to Begin", text: "Click the button below to start the flood forecast animation and watch the 7-day scenario unfold.", pos: { top: "50%", left: "50%", transform: "translate(-50%,-50%)" }, final: true }
];
var tourStep = 0;
function startTour() {
  tourStep = 0;
  document.getElementById('tourOverlay').classList.add('active');
  showTourStep();
}
function showTourStep() {
  var s = tourSteps[tourStep];
  document.getElementById('tourTitle').textContent = s.title;
  document.getElementById('tourText').textContent = s.text;
  document.getElementById('tourStepCount').textContent = (tourStep + 1) + ' / ' + tourSteps.length;
  var tt = document.getElementById('tourTooltip');
  tt.style.cssText = '';
  for (var k in s.pos) tt.style[k] = s.pos[k];
  document.getElementById('tourNext').textContent = s.final ? 'Play Flood Forecast â†’' : 'Next';
}
function nextTourStep() {
  tourStep++;
  if (tourStep >= tourSteps.length) {
    endTour();
    toggleAutoPlay();
    return;
  }
  showTourStep();
}
function endTour() {
  document.getElementById('tourOverlay').classList.remove('active');
}

// ===== CHIPSETS =====
// FIX #2: Added "â†©ï¸ Return to overview" to post_forecast per playbook rules
var chipSets = {
  initial: ["â–¶ï¸ Play flood forecast", "ðŸ“Š Show elevation analysis", "ðŸ—ï¸ Mussafah asset detail", "ðŸ  Al Reem Island risk", "ðŸ’° Portfolio impact summary"],
  post_forecast: ["ðŸ“Š Show elevation analysis", "ðŸ—ï¸ Mussafah asset detail", "ðŸ’° Portfolio impact summary", "ðŸ›¡ï¸ Mitigation recommendations", "â†©ï¸ Return to overview"],
  elevation_drill: ["ðŸ—ï¸ Mussafah asset detail", "ðŸ  Al Reem Island risk", "â–¶ï¸ Play flood forecast", "â†©ï¸ Return to overview"],
  mussafah_drill: ["Show transmission cascade", "ðŸ’° Portfolio impact summary", "ðŸ›¡ï¸ Mitigation recommendations", "â†©ï¸ Return to overview"],
  reem_drill: ["Show transmission cascade", "ðŸ“Š Show elevation analysis", "ðŸ’° Portfolio impact summary", "â†©ï¸ Return to overview"],
  impact_drill: ["ðŸ›¡ï¸ Mitigation recommendations", "Show transmission cascade", "â–¶ï¸ Play flood forecast", "â†©ï¸ Return to overview"],
  cascade_drill: ["ðŸ’° Portfolio impact summary", "ðŸ›¡ï¸ Mitigation recommendations", "â†©ï¸ Return to overview"],
  mitigation_drill: ["ðŸ’° Portfolio impact summary", "ðŸ“Š Show elevation analysis", "â†©ï¸ Return to overview"]
};

// ===== SCRIPTED RESPONSES =====
var R = {

"play flood forecast": {
content: '<p><strong>\uD83C\uDF0A 7-Day Flood Forecast Complete</strong></p><p>The Baron Weather Extreme Weather Index predicts a severe rainfall event peaking at <strong>T+5 (120 hours)</strong>. Here\u2019s the progression:</p><div class="vb"><div class="vt">Flood Forecast Timeline</div><div class="vr"><span class="l">T+1 (+24hr)</span><span class="v amb">First water in Mussafah + Saadiyat shore. 4 assets monitoring.</span></div><div class="vr"><span class="l">T+3 (+72hr)</span><span class="v red">Baron Level 3. Mussafah fully inundated. Al Reem approach. 45 assets, AED 1.8B.</span></div><div class="vr"><span class="l">T+5 (PEAK)</span><span class="v red">Maximum extent. E-12 impassable. 89 assets, AED 3.4B. Critical infra at risk.</span></div><div class="vr"><span class="l">T+7 (+168hr)</span><span class="v amb">Major recession. Residual ponding Mussafah. 28 assets need assessment.</span></div></div><p><strong>Key Insight:</strong> Mussafah Industrial is the first to flood and last to drain. Any assets in this corridor face 5+ days of disruption per major event. April 2024 confirmed this pattern.</p><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Baron Weather EWI</span><span class="pt">Esri Flood Model</span><span class="pt">IRL Mobility</span></div></div>',
chips: chipSets.post_forecast,
action: "autoplay"
},

"show elevation analysis": {
content: '<p><strong>\uD83D\uDCCA Abu Dhabi Elevation Risk Profile</strong></p><p>Esri World Elevation data cross-referenced with asset locations:</p><div class="vb"><div class="vt">Elevation Risk Bands</div><table class="tb"><tr><th>Elevation</th><th>Assets</th><th>Value</th><th>Flood Risk</th></tr><tr><td class="hl" style="color:var(--accent-red)">0\u20132m (Critical)</td><td>5</td><td>AED 1.1B</td><td style="color:var(--accent-red)">Floods in moderate events (T+1)</td></tr><tr><td class="hl" style="color:var(--accent-amber)">2\u20133m (High)</td><td>4</td><td>AED 1.4B</td><td style="color:var(--accent-amber)">Floods in severe events (T+3)</td></tr><tr><td>3\u20135m (Moderate)</td><td>3</td><td>AED 860M</td><td>Floods only at peak (T+5)</td></tr><tr><td style="color:var(--accent-emerald)">5\u201310m (Low)</td><td>3</td><td>AED 2.8B</td><td style="color:var(--accent-emerald)">Unlikely to flood</td></tr><tr><td style="color:var(--accent-emerald)">10m+ (Minimal)</td><td>1</td><td>AED 1.8B</td><td style="color:var(--accent-emerald)">Not flood-vulnerable</td></tr></table></div><div class="vb"><div class="vt">Key Findings</div><div class="vr"><span class="l">Most Exposed</span><span class="v red">Mussafah Port Services at 0.8m \u2014 floods in any significant rain</span></div><div class="vr"><span class="l">Best Protected</span><span class="v grn">Al Maryah Island at 12m \u2014 flood-resilient by design</span></div><div class="vr"><span class="l">IRL Context</span><span class="v amb">62% of daily foot traffic (112,000) in 0\u20133m band</span></div></div><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Esri World Elevation</span><span class="pt">Asset Registry</span><span class="pt">IRL Mobility</span></div></div>',
chips: chipSets.elevation_drill
},

"mussafah asset detail": {
content: '<p><strong>\uD83C\uDFD7\uFE0F Mussafah Industrial Corridor \u2014 Highest Risk Zone</strong></p><p>4 assets totaling AED 1.17B in the lowest elevation band (0.8\u20132.1m):</p><div class="vb"><div class="vt">Mussafah Port Services \u2014 AED 260M</div><div class="vr"><span class="l">Elevation</span><span class="v red">0.8m \u2014 First to flood (T+1), last to drain (T+7)</span></div><div class="vr"><span class="l">IRL Foot Traffic</span><span class="v">8,400 daily workers \u00b7 8.2 hrs dwell</span></div><div class="vr"><span class="l">Flood Duration (Apr 2024)</span><span class="v red">5+ days</span></div><div class="vr"><span class="l">Access Road</span><span class="v amb">Flooded at T+2 \u2014 facility isolated by T+3</span></div></div><div class="vb"><div class="vt">Mussafah Industrial Complex A \u2014 AED 180M</div><div class="vr"><span class="l">Elevation</span><span class="v red">1.2m \u2014 Floods at T+2</span></div><div class="vr"><span class="l">Tenants / Employees</span><span class="v">23 tenants, 340 on-site daily</span></div><div class="vr"><span class="l">Damage Estimate</span><span class="v red">AED 12\u201318M per major event</span></div></div><div class="vb"><div class="vt">Mussafah Power Substation \u2014 CRITICAL</div><div class="vr"><span class="l">Elevation</span><span class="v amb">1.5m \u2014 Flood threshold at T+4</span></div><div class="vr"><span class="l">Service Area</span><span class="v">Industrial zone + 15,000 residential units</span></div><div class="vr"><span class="l">Cascade Risk</span><span class="v red">Grid failure \u2192 Al Reem water pumping loss</span></div></div><div class="vb"><div class="vt">KIZAD Logistics Hub \u2014 AED 310M</div><div class="vr"><span class="l">Elevation</span><span class="v amb">2.1m \u2014 Affected at T+3</span></div><div class="vr"><span class="l">Throughput</span><span class="v">400+ truck movements/day</span></div><div class="vr"><span class="l">Cascade</span><span class="v amb">Disruption to 14 downstream facilities</span></div></div><p><strong>April 2024 validation:</strong> Mussafah experienced 4 days of standing water. Recovery took 2 additional weeks. IRL mobility shows foot traffic dropped 78% and took 3 weeks to recover.</p><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Esri Elevation</span><span class="pt">Asset Registry</span><span class="pt">IRL Mobility</span><span class="pt">IRL Business Universe</span><span class="pt">Baron Weather \u00b7 Apr 2024</span></div></div>',
chips: chipSets.mussafah_drill
},

"al reem island risk": {
content: '<p><strong>\uD83C\uDFE0 Al Reem Island \u2014 Residential Towers at Risk from T+3</strong></p><div class="vb"><div class="vt">Al Reem Island Tower Complex \u2014 AED 1.2B</div><div class="vr"><span class="l">Elevation</span><span class="v amb">2.8m \u2014 Flood waters approach at T+3</span></div><div class="vr"><span class="l">Residents</span><span class="v">3 towers, 1,200 units, 3,800 residents</span></div><div class="vr"><span class="l">IRL Mobility</span><span class="v">18,000 daily foot traffic</span></div><div class="vr"><span class="l">Most Vulnerable</span><span class="v red">Ground-floor retail + parking</span></div><div class="vr"><span class="l">Access</span><span class="v amb">Roads compromised at T+4</span></div></div><div class="vb"><div class="vt">Reem Mall \u2014 AED 1.1B</div><div class="vr"><span class="l">Elevation</span><span class="v amb">3.2m \u2014 Direct impact at T+5</span></div><div class="vr"><span class="l">IRL Foot Traffic</span><span class="v">35,000 daily visitors</span></div><div class="vr"><span class="l">Mastercard Expenditure</span><span class="v">AED 4.2M/week</span></div><div class="vr"><span class="l">Impact Estimate</span><span class="v red">3\u20137 days closure, AED 2.4M revenue loss</span></div></div><div class="an"><div class="ah">\u26A0\uFE0F Reclaimed Land Risk</div><div class="ab2">Al Reem is reclaimed land \u2014 drainage designed for normal rainfall only. The channel between Al Reem and Abu Dhabi island acts as a <strong>funnel during storm surge</strong>, amplifying water levels on the western shore.<br><br><strong>IRL Property Prices:</strong> Units within 200m of the channel traded at <strong>5.1% discount</strong> since April 2024. Market is pricing flood proximity.</div></div><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Esri Elevation</span><span class="pt">Asset Registry</span><span class="pt">IRL Mobility</span><span class="pt">IRL Property Prices</span><span class="pt">Mastercard</span></div></div>',
chips: chipSets.reem_drill
},

"portfolio impact summary": {
content: '<p><strong>\uD83D\uDCB0 Portfolio Impact Across Forecast Timeline</strong></p><div class="vb"><div class="vt">Impact by Time Step</div><table class="tb"><tr><th>Step</th><th>Assets</th><th>Exposed</th><th>Damage Est.</th><th>Disruption/Day</th></tr><tr><td>T+0 (Now)</td><td>0</td><td>\u2014</td><td>\u2014</td><td>\u2014</td></tr><tr><td>T+1</td><td>4</td><td>AED 620M</td><td>AED 8\u201315M</td><td>AED 2.1M</td></tr><tr><td class="hl" style="color:var(--accent-amber)">T+3</td><td style="color:var(--accent-amber)">45</td><td style="color:var(--accent-amber)">AED 1.8B</td><td>AED 45\u201380M</td><td>AED 8.4M</td></tr><tr><td class="hl" style="color:var(--accent-red)">T+5 (Peak)</td><td style="color:var(--accent-red)">89</td><td style="color:var(--accent-red)">AED 3.4B</td><td style="color:var(--accent-red)">AED 120\u2013210M</td><td style="color:var(--accent-red)">AED 12.6M</td></tr><tr><td>T+7</td><td>28</td><td>AED 840M</td><td>TBD</td><td>AED 4.2M</td></tr></table></div><div class="vb"><div class="vt">Total Potential Impact (T+1 through T+7)</div><div class="vr"><span class="l">Direct Physical Damage</span><span class="v red">AED 120\u2013210M</span></div><div class="vr"><span class="l">Economic Disruption (7 days)</span><span class="v red">AED 55\u201385M</span></div><div class="vr"><span class="l">Property Value Impact (12-month)</span><span class="v amb">AED 180\u2013340M</span></div><div class="vr"><span class="l">Infrastructure Repair</span><span class="v amb">AED 40\u201365M</span></div><div class="vr" style="border-top:2px solid var(--border);padding-top:8px;margin-top:4px"><span class="l" style="font-weight:700;color:var(--text-primary)">COMBINED EXPOSURE</span><span class="v red" style="font-size:14px">AED 395\u2013700M</span></div></div><div class="vb"><div class="vt" style="color:var(--accent-emerald)">Value of 5-Day Advance Warning</div><div class="vr"><span class="l">Asset Protection Deployed</span><span class="v grn">Sandbagging, pumps, inventory relocation</span></div><div class="vr"><span class="l">Supply Chain Rerouting</span><span class="v grn">Through unaffected corridors</span></div><div class="vr"><span class="l">Estimated Loss Reduction</span><span class="v grn">30\u201345% (AED 120\u2013315M saved)</span></div></div><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Asset Registry</span><span class="pt">Baron Weather</span><span class="pt">Esri Flood Model</span><span class="pt">IRL Mobility</span><span class="pt">IRL Property Prices</span><span class="pt">Mastercard</span></div></div>',
chips: chipSets.impact_drill
},

"show transmission cascade": {
content: '<p><strong>\u26A1 Flood Transmission Cascade \u2014 Mussafah Scenario</strong></p><p>How a single flood event cascades across interconnected systems:</p><div class="vb"><div class="vt">\uD83C\uDF0A Weather Event (T+0 \u2192 T+1)</div><div class="vr"><span class="l">Trigger</span><span class="v amb">Baron Level 2 \u2192 3 escalation. 150mm+ over 48hr.</span></div></div><div class="vb"><div class="vt">\uD83C\uDFED Direct Physical Impact (T+1 \u2192 T+3)</div><div class="vr"><span class="l">Mussafah Industrial</span><span class="v red">0.4\u20131.2m standing water</span></div><div class="vr"><span class="l">Facilities Flooded</span><span class="v red">4 facilities, 340 workers displaced</span></div><div class="vr"><span class="l">Power Substation</span><span class="v amb">At flood threshold</span></div></div><div class="vb"><div class="vt">\uD83D\uDD0C Infrastructure Cascade (T+3 \u2192 T+4)</div><div class="vr"><span class="l">Substation Trips</span><span class="v red">Power loss to industrial zone</span></div><div class="vr"><span class="l">Water Pumping</span><span class="v red">Al Reem water pressure drops</span></div><div class="vr"><span class="l">E-12 Highway</span><span class="v red">Abu Dhabi island connectivity severed</span></div></div><div class="vb"><div class="vt">\uD83D\uDCBC Economic Cascade (T+4 \u2192 T+5)</div><div class="vr"><span class="l">KIZAD Logistics</span><span class="v amb">400+ daily truck movements halted</span></div><div class="vr"><span class="l">Downstream Disruption</span><span class="v amb">14 facilities affected</span></div><div class="vr"><span class="l">Reem Mall</span><span class="v amb">35,000 visitors diverted \u2014 AED 600K/day lost</span></div><div class="vr"><span class="l">Affected Population</span><span class="v">112,000 in mobility zones</span></div></div><div class="vb"><div class="vt">\uD83D\uDCB0 Financial Cascade (T+5 \u2192 T+7)</div><div class="vr"><span class="l">Direct Damage</span><span class="v red">AED 120\u2013210M</span></div><div class="vr"><span class="l">Business Interruption</span><span class="v red">AED 55\u201385M (7 days)</span></div><div class="vr"><span class="l">Property Value Impact</span><span class="v amb">-3% to -8% in affected zones</span></div><div class="vr"><span class="l">Insurance Claims</span><span class="v">Est. AED 180M+</span></div><div class="vr"><span class="l">Recovery Timeline</span><span class="v">2\u20136 weeks for full operations</span></div></div><p><strong>This cascade is predictable 5 days in advance with Baron Weather integration.</strong></p><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Baron Weather</span><span class="pt">Esri Flood Model</span><span class="pt">Asset Registry</span><span class="pt">IRL Mobility</span><span class="pt">IRL Business Universe</span></div></div>',
chips: chipSets.cascade_drill
},

"mitigation recommendations": {
content: '<p><strong>\uD83D\uDEE1\uFE0F Predictive Mitigation Framework \u2014 Because You Have 5 Days</strong></p><p>Baron Weather\u2019s advance warning translates every hour of lead time into preparation:</p><div class="vb"><div class="vt">T-5 Days (Baron Level 1 Detected)</div><div class="vr"><span class="l">Action</span><span class="v">Activate monitoring for all assets below 3m</span></div><div class="vr"><span class="l">Action</span><span class="v">Alert facility managers in Mussafah corridor</span></div><div class="vr"><span class="l">Action</span><span class="v">Verify insurance coverage + policy activation</span></div><div class="vr"><span class="l">Action</span><span class="v">Pre-position emergency supplies at 4 critical facilities</span></div></div><div class="vb"><div class="vt" style="color:var(--accent-amber)">T-3 Days (Baron Escalates to Level 2)</div><div class="vr"><span class="l">Action</span><span class="v">Deploy flood barriers at Port Services + Industrial A</span></div><div class="vr"><span class="l">Action</span><span class="v">Relocate high-value inventory from ground floors</span></div><div class="vr"><span class="l">Action</span><span class="v">Activate tenant notification \u2014 Al Reem residential</span></div><div class="vr"><span class="l">Action</span><span class="v">Pre-stage pumps at Mussafah Power Substation</span></div><div class="vr"><span class="l">Action</span><span class="v">Notify supply chain partners re: KIZAD disruption</span></div></div><div class="vb"><div class="vt" style="color:var(--accent-red)">T-1 Day (Baron Level 3 Confirmed)</div><div class="vr"><span class="l">Action</span><span class="v red">Complete evacuation of Mussafah ground-level ops</span></div><div class="vr"><span class="l">Action</span><span class="v red">Activate backup power for critical infra</span></div><div class="vr"><span class="l">Action</span><span class="v">Close E-12 vulnerable section (coordinate ADM)</span></div><div class="vr"><span class="l">Action</span><span class="v">Activate Reem Mall business continuity plan</span></div></div><div class="vb"><div class="vt" style="color:var(--accent-emerald)">Long-Term Development Guidance</div><div class="vr"><span class="l">New Developments</span><span class="v">Mandate min 5m elevation or flood-resilient design</span></div><div class="vr"><span class="l">Mussafah Corridor</span><span class="v">Drainage infrastructure investment required</span></div><div class="vr"><span class="l">Al Reem Island</span><span class="v">Channel-side flood barriers for ground-floor commercial</span></div></div><div class="an"><div class="ah">\uD83D\uDCB0 Estimated Loss Reduction: 30\u201345%</div><div class="ab2">On AED 395\u2013700M combined exposure, predictive mitigation preserves <strong>AED 120\u2013315M</strong>.</div></div><div class="pv"><div class="pl">Data Sources</div><div class="pg"><span class="pt">Baron Weather</span><span class="pt">Esri Elevation</span><span class="pt">Asset Registry</span><span class="pt">Emergency Management</span></div></div>',
chips: chipSets.mitigation_drill
},

"return to overview": {
content: '<p>Back to the main dashboard. Current forecast status:</p><div class="vb"><div class="vt">Portfolio Summary</div><div class="vr"><span class="l">Assets Monitored</span><span class="v">16 across Abu Dhabi</span></div><div class="vr"><span class="l">Portfolio Value</span><span class="v">AED 8.5B</span></div><div class="vr"><span class="l">Flood-Vulnerable (below 5m)</span><span class="v amb">12 assets</span></div><div class="vr"><span class="l">Baron Weather Status</span><span class="v amb">Level 1 \u2014 developing conditions</span></div><div class="vr"><span class="l">Max Forecast Exposure (T+5)</span><span class="v red">AED 3.4B</span></div></div><p>Use the forecast slider or ask a question to investigate further.</p>',
chips: chipSets.initial
}

};

// ===== ENGINE =====
var isProc = false;

function norm(t) { return t.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim(); }

function find(t) {
  var n = norm(t);
  for (var k in R) {
    if (n === k || n.includes(k) || k.includes(n)) return R[k];
  }
  if (n.includes('play') || n.includes('forecast') || n.includes('animate') || n.includes('autoplay')) return R['play flood forecast'];
  if (n.includes('elevation') || n.includes('height') || n.includes('terrain')) return R['show elevation analysis'];
  if (n.includes('mussafah') || n.includes('industrial') || n.includes('port service')) return R['mussafah asset detail'];
  if (n.includes('reem') || n.includes('residential') || n.includes('tower')) return R['al reem island risk'];
  if (n.includes('portfolio') || n.includes('impact') || n.includes('exposure') || n.includes('financial') || n.includes('cost')) return R['portfolio impact summary'];
  if (n.includes('cascade') || n.includes('transmission') || n.includes('chain')) return R['show transmission cascade'];
  if (n.includes('mitigat') || n.includes('recommend') || n.includes('prepare') || n.includes('protect')) return R['mitigation recommendations'];
  if (n.includes('overview') || n.includes('return') || n.includes('back') || n.includes('dashboard')) return R['return to overview'];
  return null;
}

function scroll() { document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight; }

function addMsg(c, u) {
  u = u || false;
  var el = document.getElementById('chatMessages'), m = document.createElement('div');
  m.className = 'msg ' + (u ? 'u' : 'a');
  m.innerHTML = '<div class="mb">' + (u ? DOMPurify.sanitize(c) : DOMPurify.sanitize(c, {
    ALLOWED_TAGS: ['div','span','strong','em','br','p','b','i','table','tr','td','th','thead','tbody'],
    ALLOWED_ATTR: ['class','style','colspan']
  })) + '</div>';
  el.appendChild(m); scroll();
}

function showTyp() {
  var el = document.getElementById('chatMessages'), m = document.createElement('div');
  m.className = 'msg a'; m.id = 'typ';
  m.innerHTML = '<div class="mb"><div class="td"><div class="tdt"></div><div class="tdt"></div><div class="tdt"></div></div></div>';
  el.appendChild(m); scroll();
}

function hideTyp() { var e = document.getElementById('typ'); if (e) e.remove(); }

function updChips(chips) {
  var g = document.getElementById('chipsGrid');
  g.innerHTML = '';
  chips.forEach(function(c) {
    var b = document.createElement('button');
    b.className = 'chip';
    if (c.includes('\u21A9\uFE0F')) b.className += ' ov';
    b.textContent = c;
    b.onclick = function() { handle(c); };
    g.appendChild(b);
  });
}

// FIX #3: Added "elevation" zoom target to return to overview when viewing elevation analysis
var zoomTargets = {
  "mussafah": { center: [54.48, 24.35], zoom: 14 },
  "port": { center: [54.46, 24.34], zoom: 15 },
  "reem": { center: [54.63, 24.50], zoom: 14 },
  "khalifa": { center: [54.59, 24.41], zoom: 13 },
  "saadiyat": { center: [54.60, 24.55], zoom: 14 },
  "highway": { center: [54.55, 24.39], zoom: 13 },
  "e-12": { center: [54.55, 24.39], zoom: 13 },
  "elevation": { center: [54.53, 24.45], zoom: 11 },
  "overview": { center: [54.53, 24.45], zoom: 11 },
  "return": { center: [54.53, 24.45], zoom: 11 }
};
function getZoom(text) {
  var t = text.toLowerCase();
  for (var key in zoomTargets) { if (t.indexOf(key) !== -1) return zoomTargets[key]; }
  return null;
}

async function handle(t) {
  if (isProc) return; isProc = true;
  addMsg(t, true); showTyp();
  var z = getZoom(t);
  if (z && window._mapView) {
    window._mapView.goTo({ center: z.center, zoom: z.zoom }, { duration: 800, easing: "ease-in-out" });
  }
  await new Promise(function(r) { setTimeout(r, 400 + Math.random() * 400); });
  var resp = find(t); hideTyp();
  if (resp) {
    addMsg(resp.content);
    updChips(resp.chips || chipSets.initial);
    if (resp.action === 'autoplay') {
      setTimeout(function() { toggleAutoPlay(); }, 500);
    }
  } else {
    addMsg('<p>I can investigate that further. The current 7-day flood forecast shows developing conditions with up to 89 assets potentially affected at peak. Try one of the suggested queries for detailed analysis.</p>');
    updChips(chipSets.initial);
  }
  isProc = false;
}

function handleSend() {
  var i = document.getElementById('chatInput'), t = i.value.trim();
  if (!t) return; i.value = ''; handle(t);
}
document.getElementById('chatInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
});

updChips(chipSets.initial);

function sendMessage(t) { handle(t); }
</script>
</body>
</html>
