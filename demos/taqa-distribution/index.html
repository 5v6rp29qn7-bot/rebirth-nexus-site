<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rebirth Nexus ‚Äî TAQA Distribution Intelligence</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-tertiary: #1a2234;
  --bg-card: #141c2e;
  --border-subtle: rgba(255,255,255,0.06);
  --border-active: rgba(251,191,36,0.3);
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-amber: #fbbf24;
  --accent-red: #ef4444;
  --accent-emerald: #10b981;
  --accent-cyan: #22d3ee;
  --accent-blue: #3b82f6;
  --font-display: 'DM Sans', sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
}

@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }
body { font-family: var(--font-display); background: var(--bg-primary); color: var(--text-primary); }

/* ===== LAYOUT ===== */
.app { display: flex; height: 100vh; }


/* ===== INTEL SIDEBAR ===== */
.sidebar { width: 260px; min-width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; overflow: hidden; }
.sidebar-header { padding: 12px 14px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
.sidebar-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px; }
.sidebar-live { display: flex; align-items: center; gap: 5px; font-size: 9px; color: var(--accent-red); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.sidebar-live .live-dot { width: 4px; height: 4px; background: var(--accent-red); border-radius: 50%; animation: pulse 2s infinite; }
.feed { flex: 1; overflow-y: auto; padding: 8px; }
.feed-item { padding: 10px; margin-bottom: 6px; border-radius: 6px; border-left: 3px solid transparent; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.02); }
.feed-item:hover { background: var(--bg-card); transform: translateX(2px); }
.feed-item.crit { border-left-color: var(--accent-red); }
.feed-item.warn { border-left-color: var(--accent-amber); }
.feed-item.info { border-left-color: var(--accent-cyan); }
.feed-time { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 10px; color: var(--text-muted); }
.feed-sev { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 5px; border-radius: 3px; }
.feed-sev.critical { background: rgba(239,68,68,0.15); color: var(--accent-red); }
.feed-sev.warning { background: rgba(251,191,36,0.15); color: var(--accent-amber); }
.feed-sev.info { background: rgba(34,211,238,0.15); color: var(--accent-cyan); }
.feed-text { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
.feed-text strong { color: var(--text-primary); }
.feed-tags { display: flex; gap: 4px; margin-top: 6px; }
.ftag { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 500; }
.ftag.thermal { background: rgba(239,68,68,0.1); color: var(--accent-red); }
.ftag.grid { background: rgba(251,191,36,0.1); color: var(--accent-amber); }
.ftag.water { background: rgba(34,211,238,0.1); color: var(--accent-cyan); }
.ftag.power { background: rgba(16,185,129,0.1); color: var(--accent-emerald); }
.ftag.supply { background: rgba(139,92,246,0.1); color: #a78bfa; }
.ftag.weather { background: rgba(251,191,36,0.1); color: var(--accent-amber); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
@media (max-width: 1100px) { .sidebar { display: none; } }

/* ===== MAP PANEL ===== */
.map-panel { flex: 1; position: relative; min-width: 0; overflow: hidden; }
#viewDiv { width: 100%; height: 100%; }

.map-overlay-top { position: absolute; top: 16px; left: 16px; z-index: 10; display: flex; gap: 10px; align-items: center; }
.brand { display: flex; align-items: center; gap: 10px; background: rgba(10,14,23,0.92); backdrop-filter: blur(12px); padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border-subtle); }
.brand-icon { width: 32px; height: 32px; background: transparent; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.brand-icon img { width: 100%; height: 100%; object-fit: contain; }
.brand-text { font-size: 14px; font-weight: 600; letter-spacing: 0.5px; }
.brand-sub { font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }

.map-legend { position: absolute; bottom: 16px; left: 16px; z-index: 10; background: rgba(10,14,23,0.92); backdrop-filter: blur(12px); padding: 14px 18px; border-radius: 10px; border: 1px solid var(--border-subtle); min-width: 200px; }
.legend-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 10px; }
.legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 11px; color: var(--text-secondary); }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.legend-dot.critical { background: var(--accent-red); box-shadow: 0 0 8px rgba(239,68,68,0.5); }
.legend-dot.high { background: #f97316; }
.legend-dot.moderate { background: var(--accent-amber); }
.legend-dot.normal { background: var(--accent-emerald); }
.legend-line { width: 18px; height: 2px; flex-shrink: 0; }
.legend-line.transmission { background: var(--accent-cyan); }
.legend-line.distribution { background: var(--accent-blue); }

/* ===== SCHEMATIC INSET ===== */
.schematic-inset { position: absolute; bottom: 16px; right: 16px; z-index: 10; width: 280px; background: rgba(10,14,23,0.94); backdrop-filter: blur(12px); border-radius: 10px; border: 1px solid var(--border-subtle); overflow: hidden; display: none; transition: opacity 0.3s; }
.schematic-inset.visible { display: block; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.schematic-header { padding: 8px 12px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
.schematic-title { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-weight: 600; }
.schematic-badge { font-size: 8px; padding: 2px 6px; border-radius: 3px; background: rgba(239,68,68,0.15); color: var(--accent-red); font-weight: 600; text-transform: uppercase; }
.schematic-body { padding: 12px; }
.schematic-svg { width: 100%; }
.schematic-label { font-size: 8px; fill: var(--text-muted); font-family: var(--font-mono); }
.schematic-label-val { font-size: 8px; fill: var(--accent-red); font-family: var(--font-mono); font-weight: 600; }

/* ===== ANALYTICS SIDEBAR ===== */
.analytics-sidebar { position: absolute; top: 16px; right: 16px; z-index: 10; display: flex; flex-direction: row; gap: 6px; }
.stat-card { background: rgba(10,14,23,0.92); backdrop-filter: blur(12px); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-subtle); min-width: 0; text-align: center; }
.stat-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
.stat-value { font-size: 15px; font-weight: 700; margin-top: 1px; }
.stat-detail { font-size: 9px; color: var(--text-muted); margin-top: 1px; }
.stat-value.red { color: var(--accent-red); }
.stat-value.amber { color: var(--accent-amber); }
.stat-value.green { color: var(--accent-emerald); }

/* ===== CHAT PANEL ===== */
.chat-panel { width: 420px; min-width: 420px; display: flex; flex-direction: column; background: var(--bg-secondary); border-left: 1px solid var(--border-subtle); height: 100vh; }

.chat-header { padding: 14px 18px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 12px; }
.header-icon { width: 36px; height: 36px; background: transparent; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.header-icon img { width: 100%; height: 100%; object-fit: contain; }
.header-text { flex: 1; }
.header-title { font-size: 14px; font-weight: 600; }
.header-sub { font-size: 10px; color: var(--text-muted); letter-spacing: 0.5px; }

.alert-bar { display: flex; align-items: center; gap: 8px; padding: 8px 18px; background: rgba(239,68,68,0.08); border-bottom: 1px solid rgba(239,68,68,0.15); }
.alert-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-red); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.alert-text { font-size: 11px; font-weight: 500; color: var(--accent-red); flex: 1; }
.alert-time { font-size: 10px; color: var(--text-muted); }

.kpi-row { display: flex; gap: 6px; padding: 10px 18px; border-bottom: 1px solid var(--border-subtle); overflow-x: auto; }
.kpi { background: var(--bg-tertiary); padding: 8px 10px; border-radius: 8px; text-align: center; flex: 1; min-width: 70px; }
.kpi-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
.kpi-val { font-size: 13px; font-weight: 700; margin-top: 2px; }
.kpi-val.red { color: var(--accent-red); }
.kpi-val.green { color: var(--accent-emerald); }
.kpi-val.amber { color: var(--accent-amber); }

.chat-messages { flex: 1; overflow-y: auto; padding: 14px 18px; scroll-behavior: smooth; }
.message { margin-bottom: 14px; }
.message.user { text-align: right; }
.msg-bubble { display: inline-block; max-width: 92%; padding: 10px 14px; border-radius: 12px; font-size: 12.5px; line-height: 1.55; text-align: left; }
.message.assistant .msg-bubble { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); }
.message.user .msg-bubble { background: var(--accent-amber); color: #000; font-weight: 500; }

/* Visualization blocks inside messages */
.viz-block { margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid var(--border-subtle); }
.viz-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-cyan); margin-bottom: 8px; }
.viz-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 11px; }
.viz-row:last-child { border: none; }
.viz-row .label { color: var(--text-secondary); }
.viz-row .value { font-weight: 600; }
.viz-row .value.red { color: var(--accent-red); }
.viz-row .value.amber { color: var(--accent-amber); }
.viz-row .value.green { color: var(--accent-emerald); }
.viz-row .value.cyan { color: var(--accent-cyan); }

.viz-table { width: 100%; border-collapse: collapse; font-size: 10.5px; margin-top: 6px; }
.viz-table th { text-align: left; padding: 4px 6px; color: var(--text-muted); font-weight: 500; border-bottom: 1px solid var(--border-subtle); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }
.viz-table td { padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.03); color: var(--text-secondary); }
.viz-table td.highlight { color: var(--text-primary); font-weight: 600; }

.viz-trace { display: flex; align-items: center; gap: 4px; padding: 8px; background: rgba(34,211,238,0.05); border-radius: 6px; flex-wrap: wrap; }
.trace-node { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; }
.trace-node.source { background: rgba(239,68,68,0.15); color: var(--accent-red); border: 1px solid rgba(239,68,68,0.3); }
.trace-node.path { background: rgba(251,191,36,0.1); color: var(--accent-amber); border: 1px solid rgba(251,191,36,0.2); }
.trace-node.endpoint { background: rgba(16,185,129,0.1); color: var(--accent-emerald); border: 1px solid rgba(16,185,129,0.2); }
.trace-arrow { color: var(--text-muted); font-size: 10px; }

.viz-workorder { padding: 10px; background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.15); border-radius: 6px; }
.wo-header { font-size: 11px; font-weight: 600; color: var(--accent-blue); margin-bottom: 6px; }
.wo-field { display: flex; justify-content: space-between; padding: 3px 0; font-size: 10.5px; }
.wo-field .wo-label { color: var(--text-muted); }
.wo-field .wo-value { color: var(--text-secondary); }

.viz-notification { padding: 10px; background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.15); border-radius: 6px; }
.notif-header { font-size: 10px; font-weight: 600; color: var(--accent-emerald); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.notif-body { font-size: 11px; color: var(--text-secondary); line-height: 1.5; white-space: pre-line; }

/* Provenance */
.provenance { margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border-subtle); }
.prov-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 4px; }
.prov-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.prov-tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; background: rgba(255,255,255,0.04); color: var(--text-muted); display: flex; align-items: center; gap: 3px; }
.prov-tag::before { content: "‚úì"; color: var(--accent-emerald); font-size: 8px; }

.chips-area { padding: 12px 18px; background: var(--bg-tertiary); border-top: 1px solid var(--border-subtle); }
.chips-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; }
.chips-grid { display: flex; flex-wrap: wrap; gap: 6px; }
.chip { padding: 7px 12px; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--bg-secondary); color: var(--text-secondary); font-size: 11px; cursor: pointer; transition: all 0.2s; font-family: var(--font-display); }
.chip:hover { border-color: var(--accent-amber); color: var(--accent-amber); background: rgba(251,191,36,0.05); }
.chip.overview { border-color: rgba(34,211,238,0.3); color: var(--accent-cyan); }
.chip.overview:hover { background: rgba(34,211,238,0.08); }

.chat-input-area { display: flex; gap: 8px; padding: 12px 18px; border-top: 1px solid var(--border-subtle); }
.chat-input-area input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 12px; font-family: var(--font-display); outline: none; }
.chat-input-area input:focus { border-color: var(--accent-amber); }
.chat-input-area button { background: var(--accent-amber); color: #000; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; font-size: 12px; cursor: pointer; font-family: var(--font-display); }

.typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
.typing-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); animation: typingBounce 1.4s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

/* Tour */
.tour-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.6); }
.tour-overlay.active { display: block; }
.tour-tooltip { position: absolute; background: var(--bg-card); border: 1px solid var(--accent-amber); border-radius: 12px; padding: 16px; max-width: 320px; z-index: 1001; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
.tour-title { font-size: 14px; font-weight: 600; color: var(--accent-amber); margin-bottom: 6px; }
.tour-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
.tour-btn { background: var(--accent-amber); color: #000; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; }
.tour-step { font-size: 10px; color: var(--text-muted); float: right; margin-top: 4px; }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
/* === PASSWORD GATE === */
.password-gate { position: fixed; inset: 0; background: #0a0e17; display: flex; align-items: center; justify-content: center; z-index: 99999; }
.password-gate.hidden { display: none; }
.password-box { background: #111827; border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 40px; text-align: center; max-width: 400px; width: 90%; }
.pw-logo { width: 64px; height: 64px; background: transparent; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; overflow: hidden; }
.pw-logo img { width: 100%; height: 100%; object-fit: contain; }
.pw-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #f1f5f9; }
.pw-subtitle { font-size: 13px; color: #64748b; margin-bottom: 24px; }
.pw-input { width: 100%; padding: 12px 16px; background: #0a0e17; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #f1f5f9; font-size: 14px; text-align: center; outline: none; margin-bottom: 12px; font-family: inherit; box-sizing: border-box; }
.pw-input:focus { border-color: #fbbf24; }
.pw-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; border-radius: 8px; color: #000; font-weight: 600; font-size: 14px; cursor: pointer; font-family: inherit; }
.pw-btn:hover { opacity: 0.9; }
.pw-error { color: #ef4444; font-size: 12px; margin-top: 8px; display: none; }
.pw-error.show { display: block; }
.pw-footer { font-size: 11px; color: #475569; margin-top: 20px; }
@keyframes pwShake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }
.pw-shake { animation: pwShake 0.4s ease; }

</style>
</head>
<body>
<!-- PASSWORD GATE -->
<div class="password-gate" id="pwGate">
  <div class="password-box">
    <div class="pw-logo"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='‚ö°'"></div>
    <div class="pw-title">Nexus Demo Access</div>
    <div class="pw-subtitle">TAQA Distribution Intelligence</div>
    <input type="password" class="pw-input" id="pwInput" placeholder="Enter access code" autocomplete="off">
    <button class="pw-btn" id="pwBtn">Access Demo</button>
    <div class="pw-error" id="pwError">Incorrect access code</div>
    <div class="pw-footer">Rebirth Nexus Inc. ¬∑ Confidential</div>
  </div>
</div>
<script>
(function(){
  var k='nexus_taqa_dist';
  if(sessionStorage.getItem(k)==='granted'){document.getElementById('pwGate').classList.add('hidden');}
  document.getElementById('pwBtn').onclick=check;
  document.getElementById('pwInput').addEventListener('keydown',function(e){if(e.key==='Enter')check();});
  function check(){
    if(document.getElementById('pwInput').value==='deserthawk'){
      sessionStorage.setItem(k,'granted');
      document.getElementById('pwGate').classList.add('hidden');
    } else {
      var e=document.getElementById('pwError');e.classList.add('show');
      var b=document.querySelector('.password-box');b.classList.add('pw-shake');
      setTimeout(function(){b.classList.remove('pw-shake');},400);
    }
  }
})();
</script>
<div class="app">
    <!-- INTEL SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Grid Intelligence</span>
        <span class="sidebar-live"><div class="live-dot"></div> Live</span>
      </div>
      <div class="feed" id="intelFeed">
        <div class="feed-item crit" onclick="handleChipClick('Investigate Substation 7 Cascade')">
          <div class="feed-time"><span class="feed-sev critical">Critical</span> 14:23 GST</div>
          <div class="feed-text"><strong>Sub-7 transformer at 92¬∞C</strong> ‚Äî 3¬∞C from thermal limit. Cascade risk to S12, S15, S18.</div>
          <div class="feed-tags"><span class="ftag thermal">Thermal</span><span class="ftag grid">Cascade</span></div>
        </div>
        <div class="feed-item crit" onclick="handleChipClick('What\'s our total financial exposure?')">
          <div class="feed-time"><span class="feed-sev critical">Critical</span> 14:18 GST</div>
          <div class="feed-text"><strong>Reserve margin at 2.4%.</strong> Load shedding protocol on standby for 340 MW.</div>
          <div class="feed-tags"><span class="ftag grid">Capacity</span><span class="ftag power">Reserve</span></div>
        </div>
        <div class="feed-item warn" onclick="handleChipClick('Show grid thermal stress map')">
          <div class="feed-time"><span class="feed-sev warning">Warning</span> 14:12 GST</div>
          <div class="feed-text"><strong>Downtown Core underground cables</strong> approaching thermal limit. 72h restoration if faulted.</div>
          <div class="feed-tags"><span class="ftag thermal">Thermal</span><span class="ftag grid">Underground</span></div>
        </div>
        <div class="feed-item warn" onclick="handleChipClick('Water-energy nexus status')">
          <div class="feed-time"><span class="feed-sev warning">Warning</span> 14:08 GST</div>
          <div class="feed-text"><strong>3 water pumping stations</strong> on backup generators. Southern corridor ‚Äî 340,000 residents at risk.</div>
          <div class="feed-tags"><span class="ftag water">Water</span><span class="ftag power">Backup Gen</span></div>
        </div>
        <div class="feed-item warn" onclick="handleChipClick('Transformer inventory summary')">
          <div class="feed-time"><span class="feed-sev warning">Warning</span> 14:02 GST</div>
          <div class="feed-text"><strong>Solar output down 23%.</strong> Gas turbines absorbing shortfall at $2.1M/day premium.</div>
          <div class="feed-tags"><span class="ftag power">Solar</span><span class="ftag grid">Fuel Cost</span></div>
        </div>
        <div class="feed-item info" onclick="handleChipClick('Asset portfolio criticality ranking')">
          <div class="feed-time"><span class="feed-sev info">Info</span> 13:55 GST</div>
          <div class="feed-text"><strong>Mobile transformer</strong> identified in Jebel Ali. 48h deployment, $340K/month rental.</div>
          <div class="feed-tags"><span class="ftag supply">Equipment</span><span class="ftag grid">Contingency</span></div>
        </div>
        <div class="feed-item info" onclick="handleChipClick('Investigate Substation 7 Cascade')">
          <div class="feed-time"><span class="feed-sev info">Info</span> 13:48 GST</div>
          <div class="feed-text"><strong>Nexus flagged TR-7A at 86¬∞C</strong> ‚Äî predicted cascade trajectory 6 hours before static alarm thresholds would trigger.</div>
          <div class="feed-tags"><span class="ftag thermal">Predictive</span><span class="ftag grid">Early Warning</span></div>
        </div>
      </div>
    </div>

  <!-- MAP -->
  <div class="map-panel">
    <div id="viewDiv"></div>
    
    <div class="map-overlay-top">
      <div class="brand">
        <div class="brand-icon"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='‚ö°'"></div>
        <div>
          <div class="brand-text">Rebirth Nexus</div>
          <div class="brand-sub">TAQA Distribution Intelligence</div>
        </div>
      </div>
    </div>

    <div class="analytics-sidebar">
      <div class="stat-card">
        <div class="stat-label">Grid Exposure</div>
        <div class="stat-value red">AED 14.8M</div>
        <div class="stat-detail">6 substations at risk</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Reserve Margin</div>
        <div class="stat-value red">2.4%</div>
        <div class="stat-detail">Normal: 15%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Protected</div>
        <div class="stat-value green" id="protectedValue">AED 0</div>
        <div class="stat-detail" id="protectedDetail">No actions taken</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Peak Demand</div>
        <div class="stat-value amber">12.4 GW</div>
        <div class="stat-detail">Capacity: 12.7 GW</div>
      </div>
    </div>

    <div class="map-legend">
      <div class="legend-title">Network Overlay</div>
      <div class="legend-item"><div class="legend-dot critical"></div> Substation ‚Äî Critical</div>
      <div class="legend-item"><div class="legend-dot high"></div> Substation ‚Äî Stressed</div>
      <div class="legend-item"><div class="legend-dot normal"></div> Substation ‚Äî Operational</div>
      <div class="legend-item"><div class="legend-line transmission"></div> 132kV Transmission</div>
      <div class="legend-item"><div class="legend-line distribution"></div> 33/11kV Distribution</div>
      <div class="legend-item"><div style="width:7px;height:7px;background:rgba(255,255,255,0.6);flex-shrink:0"></div> Transformer</div>
      <div class="legend-item"><div style="width:7px;height:7px;background:rgba(255,255,255,0.5);transform:rotate(45deg);flex-shrink:0"></div> Switch Point</div>
      <div class="legend-item"><div style="width:8px;height:8px;background:rgba(34,211,238,0.8);flex-shrink:0"></div> Field Crew</div>
      <div class="legend-item"><div style="width:10px;height:10px;border-radius:50%;background:rgba(239,68,68,0.08);border:1px dashed rgba(239,68,68,0.3);flex-shrink:0"></div> Heat Stress Zone</div>
    </div>

    <!-- SCHEMATIC INSET: Sub-7 Single-Line Diagram -->
    <div class="schematic-inset">
      <div class="schematic-header">
        <span class="schematic-title">Sub-7 Single Line ‚Äî PRY 33/11</span>
        <span class="schematic-badge">92¬∞C Critical</span>
      </div>
      <div class="schematic-body">
        <svg class="schematic-svg" viewBox="0 0 256 200" xmlns="http://www.w3.org/2000/svg">
          <!-- 132kV Incoming -->
          <line x1="128" y1="2" x2="128" y2="24" stroke="#ef4444" stroke-width="2.5"/>
          <text x="142" y="10" class="schematic-label">132kV</text>

          <!-- Main Breaker -->
          <rect x="120" y="24" width="16" height="10" fill="none" stroke="#ef4444" stroke-width="1.5" rx="1"/>
          <line x1="124" y1="29" x2="132" y2="29" stroke="#ef4444" stroke-width="1.5"/>
          <text x="142" y="32" class="schematic-label-val">CB-01 Closed</text>

          <!-- 132/33kV Transformer TR-7A -->
          <line x1="128" y1="34" x2="128" y2="44" stroke="#ef4444" stroke-width="2"/>
          <circle cx="128" cy="50" r="6" fill="none" stroke="#ef4444" stroke-width="1.5"/>
          <circle cx="128" cy="60" r="6" fill="none" stroke="#fbbf24" stroke-width="1.5"/>
          <text x="142" y="52" class="schematic-label-val">TR-7A 92¬∞C</text>
          <text x="142" y="62" class="schematic-label">50 MVA</text>

          <!-- 33kV Bus -->
          <line x1="128" y1="66" x2="128" y2="76" stroke="#fbbf24" stroke-width="2"/>
          <line x1="40" y1="76" x2="216" y2="76" stroke="#fbbf24" stroke-width="2.5"/>
          <text x="8" y="74" class="schematic-label" style="fill:#fbbf24">33kV BUS</text>

          <!-- 33/11kV Transformers (3 feeders) -->
          <!-- Feeder 1 -->
          <line x1="72" y1="76" x2="72" y2="90" stroke="#fbbf24" stroke-width="1.5"/>
          <rect x="64" y="90" width="16" height="8" fill="none" stroke="#fbbf24" stroke-width="1" rx="1"/>
          <circle cx="72" cy="104" r="5" fill="none" stroke="#3b82f6" stroke-width="1"/>
          <circle cx="72" cy="112" r="5" fill="none" stroke="#3b82f6" stroke-width="1"/>
          <text x="56" y="126" class="schematic-label">F-7A</text>

          <!-- Feeder 2 -->
          <line x1="128" y1="76" x2="128" y2="90" stroke="#fbbf24" stroke-width="1.5"/>
          <rect x="120" y="90" width="16" height="8" fill="none" stroke="#fbbf24" stroke-width="1" rx="1"/>
          <circle cx="128" cy="104" r="5" fill="none" stroke="#3b82f6" stroke-width="1"/>
          <circle cx="128" cy="112" r="5" fill="none" stroke="#3b82f6" stroke-width="1"/>
          <text x="112" y="126" class="schematic-label">F-7B</text>

          <!-- Feeder 3 -->
          <line x1="184" y1="76" x2="184" y2="90" stroke="#fbbf24" stroke-width="1.5"/>
          <rect x="176" y="90" width="16" height="8" fill="none" stroke="#fbbf24" stroke-width="1" rx="1"/>
          <circle cx="184" cy="104" r="5" fill="none" stroke="#3b82f6" stroke-width="1"/>
          <circle cx="184" cy="112" r="5" fill="none" stroke="#3b82f6" stroke-width="1"/>
          <text x="168" y="126" class="schematic-label">F-7C</text>

          <!-- 11kV Bus -->
          <line x1="72" y1="117" x2="72" y2="136" stroke="#3b82f6" stroke-width="1.5"/>
          <line x1="128" y1="117" x2="128" y2="136" stroke="#3b82f6" stroke-width="1.5"/>
          <line x1="184" y1="117" x2="184" y2="136" stroke="#3b82f6" stroke-width="1.5"/>
          <line x1="40" y1="136" x2="216" y2="136" stroke="#3b82f6" stroke-width="2"/>
          <text x="8" y="134" class="schematic-label" style="fill:#3b82f6">11kV BUS</text>

          <!-- Service points (downstream loads) -->
          <line x1="56" y1="136" x2="56" y2="152" stroke="#3b82f6" stroke-width="1"/>
          <line x1="88" y1="136" x2="88" y2="152" stroke="#3b82f6" stroke-width="1"/>
          <line x1="112" y1="136" x2="112" y2="152" stroke="#3b82f6" stroke-width="1"/>
          <line x1="144" y1="136" x2="144" y2="152" stroke="#3b82f6" stroke-width="1"/>
          <line x1="168" y1="136" x2="168" y2="152" stroke="#3b82f6" stroke-width="1"/>
          <line x1="200" y1="136" x2="200" y2="152" stroke="#3b82f6" stroke-width="1"/>

          <!-- Load symbols (arrows) -->
          <polygon points="52,152 60,152 56,160" fill="#3b82f6" opacity="0.6"/>
          <polygon points="84,152 92,152 88,160" fill="#3b82f6" opacity="0.6"/>
          <polygon points="108,152 116,152 112,160" fill="#3b82f6" opacity="0.6"/>
          <polygon points="140,152 148,152 144,160" fill="#3b82f6" opacity="0.6"/>
          <polygon points="164,152 172,152 168,160" fill="#3b82f6" opacity="0.6"/>
          <polygon points="196,152 204,152 200,160" fill="#3b82f6" opacity="0.6"/>

          <!-- Labels -->
          <text x="24" y="172" class="schematic-label">Steel Works</text>
          <text x="80" y="172" class="schematic-label">Data Ctr</text>
          <text x="120" y="172" class="schematic-label">Hospital</text>
          <text x="158" y="172" class="schematic-label">Indust.</text>
          <text x="192" y="172" class="schematic-label">Resid.</text>

          <!-- Stats bar -->
          <text x="8" y="192" class="schematic-label">45,200 customers</text>
          <text x="128" y="192" class="schematic-label-val">$12M/day exposure</text>
        </svg>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="chat-panel">
    <div class="chat-header">
      <div class="header-icon"><img src="/logo.png" alt="Nexus" onerror="this.outerHTML='‚ö°'"></div>
      <div class="header-text">
        <div class="header-title">NexusGrid Intelligence</div>
        <div class="header-sub">TAQA Distribution ¬∑ Abu Dhabi Emirate</div>
      </div>
    </div>

    <div class="alert-bar">
      <div class="alert-pulse"></div>
      <div class="alert-text">HEAT ALERT ‚Äî Abu Dhabi Grid Stress ¬∑ 52¬∞C</div>
      <div class="alert-time" id="alertTime">Live</div>
    </div>

    <div class="kpi-row">
      <div class="kpi"><div class="kpi-label">Exposure</div><div class="kpi-val red">AED 14.8M</div></div>
      <div class="kpi"><div class="kpi-label">Assets</div><div class="kpi-val red">6</div></div>
      <div class="kpi"><div class="kpi-label">Protected</div><div class="kpi-val green" id="kpiProtected">AED 0</div></div>
      <div class="kpi"><div class="kpi-label">ROI</div><div class="kpi-val amber">19:1</div></div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chips-area">
      <div class="chips-label">Suggested Queries</div>
      <div class="chips-grid" id="chipsGrid"></div>
    </div>

    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Ask about grid operations...">
      <button id="sendBtn" onclick="handleSend()">Send</button>
    </div>
  </div>
</div>

<div class="tour-overlay" id="tourOverlay">
  <div class="tour-tooltip" id="tourTooltip"></div>
</div>

<!-- ESRI MAP -->
<script src="https://js.arcgis.com/4.28/"></script>
<script>
// ============================================
// ESRI MAP SETUP
// ============================================
require(["esri/Map","esri/views/MapView","esri/Graphic","esri/layers/GraphicsLayer","esri/geometry/Point","esri/geometry/Polyline","esri/Color"],
function(Map, MapView, Graphic, GraphicsLayer, Point, Polyline, Color) {

  const map = new Map({ basemap: "dark-gray-vector" });
  const view = new MapView({ container: "viewDiv", map: map, center: [54.55, 24.42], zoom: 11 });
  view.ui.remove(["zoom","attribution"]);
  window._mapView = view; // expose for chip zoom

  const subLayer = new GraphicsLayer();
  const lineLayer = new GraphicsLayer();
  const heatLayer = new GraphicsLayer();
  const crewLayer = new GraphicsLayer();
  const schematicLayer = new GraphicsLayer();
  map.addMany([heatLayer, lineLayer, schematicLayer, crewLayer, subLayer]);

  // Substations with real TAQA-style data
  const subs = [
    { id: "S7", name: "Mussafah Industrial (PRY 33/11)", lat: 24.35, lon: 54.50, temp: 92, status: "CRITICAL", type: "PRY 33/11", dms: "Yes", kv: "132/33", customers: 45200, transformers: 3, load_mva: 285 },
    { id: "S12", name: "Downtown Core (S/S)", lat: 24.49, lon: 54.37, temp: 89, status: "HIGH", type: "S/S", dms: "Yes", kv: "33/11", customers: 34100, transformers: 2, load_mva: 192 },
    { id: "S15", name: "Mussafah Port (PRY 33/11)", lat: 24.36, lon: 54.48, temp: 87, status: "HIGH", type: "PRY 33/11", dms: "Yes", kv: "132/33", customers: 28500, transformers: 2, load_mva: 210 },
    { id: "S18", name: "Corniche Residential (GMTs)", lat: 24.47, lon: 54.35, temp: 85, status: "MODERATE", type: "GMT", dms: "Partly", kv: "33/11", customers: 52800, transformers: 4, load_mva: 145 },
    { id: "S3", name: "Khalifa City (SW/S)", lat: 24.42, lon: 54.58, temp: 78, status: "NORMAL", type: "SW/S", dms: "Yes", kv: "33/11", customers: 38200, transformers: 2, load_mva: 165 },
    { id: "S9", name: "Yas Island (QRM)", lat: 24.50, lon: 54.60, temp: 76, status: "NORMAL", type: "QRM", dms: "Partly", kv: "33/11", customers: 24600, transformers: 2, load_mva: 120 },
    { id: "S21", name: "Saadiyat Cultural (TRM)", lat: 24.54, lon: 54.43, temp: 74, status: "NORMAL", type: "TRM", dms: "No", kv: "33/11", customers: 18900, transformers: 1, load_mva: 88 },
    { id: "S6", name: "Al Reem Island (S/S)", lat: 24.50, lon: 54.40, temp: 82, status: "MODERATE", type: "S/S", dms: "Yes", kv: "33/11", customers: 42100, transformers: 3, load_mva: 178 },
    { id: "S1", name: "Main Grid Substation (PRY 33/11)", lat: 24.44, lon: 54.44, temp: 72, status: "NORMAL", type: "PRY 33/11", dms: "Yes", kv: "132/33", customers: 0, transformers: 6, load_mva: 450 },
    { id: "WP1", name: "Southern Water Corridor PS", lat: 24.33, lon: 54.52, temp: 0, status: "BACKUP", type: "P/U", dms: "No", kv: "11/0.415", customers: 340000, transformers: 0, load_mva: 12 },
  ];

  const colorMap = { CRITICAL: [239,68,68], HIGH: [249,115,22], MODERATE: [251,191,36], NORMAL: [16,185,129], BACKUP: [139,92,246] };

  subs.forEach(s => {
    const c = colorMap[s.status] || [100,100,100];
    const size = s.status === "CRITICAL" ? 18 : s.status === "HIGH" ? 15 : 12;
    subLayer.add(new Graphic({
      geometry: new Point({ longitude: s.lon, latitude: s.lat }),
      symbol: { type: "simple-marker", color: c, size: size, outline: { color: [255,255,255,80], width: 1.5 } },
      attributes: s,
      popupTemplate: { title: "{name}", content: "Status: {status} | Temp: {temp}¬∞C | Type: {type}" }
    }));
  });

  // === 132kV TRANSMISSION LINES (thick cyan ‚Äî backbone) ===
  const lines = [
    { from: [54.44,24.44], to: [54.50,24.35], type: "transmission" },
    { from: [54.44,24.44], to: [54.37,24.49], type: "transmission" },
    { from: [54.44,24.44], to: [54.48,24.36], type: "transmission" },
    { from: [54.44,24.44], to: [54.35,24.47], type: "distribution" },
    { from: [54.44,24.44], to: [54.58,24.42], type: "distribution" },
    { from: [54.44,24.44], to: [54.60,24.50], type: "distribution" },
    { from: [54.44,24.44], to: [54.43,24.54], type: "distribution" },
    { from: [54.44,24.44], to: [54.40,24.50], type: "distribution" },
    { from: [54.50,24.35], to: [54.52,24.33], type: "distribution" },
  ];
  lines.forEach(l => {
    lineLayer.add(new Graphic({
      geometry: new Polyline({ paths: [[ l.from, l.to ]] }),
      symbol: { type: "simple-line", color: l.type === "transmission" ? [34,211,238,180] : [59,130,246,120], width: l.type === "transmission" ? 2.5 : 1.5, style: "solid" }
    }));
  });

  // === DISTRIBUTION FEEDERS (branching from substations ‚Äî blue, thinner) ===
  const feeders = [
    // S7 feeders (critical area ‚Äî orange/red tint)
    { from: [54.50,24.35], to: [54.51,24.34], c: [239,68,68,140] },
    { from: [54.50,24.35], to: [54.49,24.34], c: [239,68,68,140] },
    { from: [54.50,24.35], to: [54.51,24.36], c: [239,68,68,140] },
    { from: [54.51,24.34], to: [54.52,24.335], c: [239,68,68,100] },
    { from: [54.51,24.34], to: [54.51,24.33], c: [239,68,68,100] },
    { from: [54.49,24.34], to: [54.48,24.335], c: [239,68,68,100] },
    // S12 feeders (downtown ‚Äî orange)
    { from: [54.37,24.49], to: [54.36,24.50], c: [249,115,22,120] },
    { from: [54.37,24.49], to: [54.38,24.50], c: [249,115,22,120] },
    { from: [54.37,24.49], to: [54.36,24.48], c: [249,115,22,120] },
    { from: [54.36,24.50], to: [54.355,24.505], c: [249,115,22,80] },
    // S3 Khalifa City feeders (normal ‚Äî blue)
    { from: [54.58,24.42], to: [54.59,24.43], c: [59,130,246,100] },
    { from: [54.58,24.42], to: [54.57,24.41], c: [59,130,246,100] },
    { from: [54.58,24.42], to: [54.59,24.41], c: [59,130,246,100] },
    { from: [54.59,24.43], to: [54.60,24.435], c: [59,130,246,70] },
    // S6 Reem Island feeders
    { from: [54.40,24.50], to: [54.41,24.51], c: [59,130,246,100] },
    { from: [54.40,24.50], to: [54.39,24.51], c: [59,130,246,100] },
    // S21 Saadiyat feeders
    { from: [54.43,24.54], to: [54.44,24.55], c: [59,130,246,100] },
    { from: [54.43,24.54], to: [54.42,24.55], c: [59,130,246,100] },
  ];
  feeders.forEach(f => {
    schematicLayer.add(new Graphic({
      geometry: new Polyline({ paths: [[f.from, f.to]] }),
      symbol: { type: "simple-line", color: f.c, width: 1, style: "solid" }
    }));
  });

  // === TRANSFORMER SYMBOLS (small squares at feeder junctions) ===
  const transformers = [
    { lon: 54.51, lat: 24.34, label: "TR-7A (92¬∞C)", status: "CRITICAL" },
    { lon: 54.49, lat: 24.34, label: "TR-7B (88¬∞C)", status: "HIGH" },
    { lon: 54.36, lat: 24.50, label: "TR-12A (89¬∞C)", status: "HIGH" },
    { lon: 54.38, lat: 24.50, label: "TR-12B (84¬∞C)", status: "MODERATE" },
    { lon: 54.59, lat: 24.43, label: "TR-3A (78¬∞C)", status: "NORMAL" },
    { lon: 54.57, lat: 24.41, label: "TR-3B (76¬∞C)", status: "NORMAL" },
    { lon: 54.41, lat: 24.51, label: "TR-6A (82¬∞C)", status: "MODERATE" },
    { lon: 54.44, lat: 24.55, label: "TR-21A (74¬∞C)", status: "NORMAL" },
  ];
  transformers.forEach(t => {
    const c = colorMap[t.status] || [100,100,100];
    schematicLayer.add(new Graphic({
      geometry: new Point({ longitude: t.lon, latitude: t.lat }),
      symbol: { type: "simple-marker", style: "square", color: [...c, 200], size: 7, outline: { color: [255,255,255,120], width: 1 } },
      popupTemplate: { title: t.label, content: "Status: " + t.status }
    }));
  });

  // === SWITCH / DISCONNECT POINTS (small diamonds) ===
  const switches = [
    { lon: 54.505, lat: 24.345, label: "SW-7-01 (Closed)" },
    { lon: 54.485, lat: 24.345, label: "SW-7-02 (Closed)" },
    { lon: 54.365, lat: 24.495, label: "SW-12-01 (Closed)" },
    { lon: 54.585, lat: 24.425, label: "SW-3-01 (Closed)" },
    { lon: 54.405, lat: 24.505, label: "SW-6-01 (Closed)" },
    { lon: 54.435, lat: 24.545, label: "SW-21-01 (Open)" },
  ];
  switches.forEach(sw => {
    schematicLayer.add(new Graphic({
      geometry: new Point({ longitude: sw.lon, latitude: sw.lat }),
      symbol: { type: "simple-marker", style: "diamond", color: [255,255,255,140], size: 5, outline: { color: [255,255,255,60], width: 0.5 } },
      popupTemplate: { title: sw.label }
    }));
  });

  // Heat stress zone overlay (transparent)
  heatLayer.add(new Graphic({
    geometry: {
      type: "polygon",
      rings: [[
        [54.42, 24.28], [54.60, 24.28], [54.62, 24.44], [54.44, 24.44], [54.42, 24.28]
      ]]
    },
    symbol: {
      type: "simple-fill",
      color: new Color([239, 68, 68, 0.08]),
      outline: { color: new Color([239, 68, 68, 0.3]), width: 1.5, style: "dash" }
    }
  }));

  // Field crew positions
  const crews = [
    { lat: 24.37, lon: 54.51, label: "Line Crew Alpha" },
    { lat: 24.44, lon: 54.40, label: "Sub Maintenance B3" },
    { lat: 24.50, lon: 54.42, label: "Emergency Response E1" },
    { lat: 24.48, lon: 54.55, label: "Line Crew Charlie" },
    { lat: 24.34, lon: 54.55, label: "Industrial Response I2" }
  ];
  crews.forEach(c => {
    crewLayer.add(new Graphic({
      geometry: { type: "point", longitude: c.lon, latitude: c.lat },
      symbol: { type: "simple-marker", color: [34, 211, 238], size: 5, style: "square", outline: { color: [34, 211, 238, 80], width: 3 } },
      popupTemplate: { title: c.label }
    }));
  });
});

// ============================================
// SCRIPTED RESPONSES & CHIP SETS
// ============================================

const chipSets = {
  initial: [
    "‚ö° Investigate Substation 7 Cascade",
    "üî• Show grid thermal stress map",
    "üí∞ What's our total financial exposure?",
    "üîß Transformer inventory summary",
    "üíß Water-energy nexus status",
    "üìä Asset portfolio criticality ranking"
  ],
  cascade: [
    "Show affected customers downstream",
    "What's the cascade timeline?",
    "Mitigation options for Sub-7?",
    "Generate incident work order",
    "üíß Impact on water pumping stations",
    "‚Ü©Ô∏è Return to overview"
  ],
  trace: [
    "Notify VIP customers",
    "Send maintenance SMS to all affected",
    "Create emergency work order",
    "Show network trace schematic",
    "‚Ü©Ô∏è Return to overview"
  ],
  maintenance: [
    "DGA analysis for TR-7A",
    "Time-to-failure prediction",
    "Spare transformer availability",
    "Schedule emergency crew dispatch",
    "‚Ü©Ô∏è Return to overview"
  ],
  financial: [
    "Break down the $18.7M exposure",
    "What's the ROI on proactive mitigation?",
    "Board-level risk summary",
    "Compare capex scenarios",
    "‚Ü©Ô∏è Return to overview"
  ],
  water: [
    "Pumping station diesel reserves?",
    "Which residents lose water first?",
    "Backup generator runtime remaining",
    "Emergency water tanker deployment",
    "‚Ü©Ô∏è Return to overview"
  ],
  assetMgmt: [
    "Top 5 assets for capex priority",
    "Single points of failure in network",
    "Replace vs. refurbish analysis",
    "Quiet risk ‚Äî aging assets with no redundancy",
    "‚Ü©Ô∏è Return to overview"
  ],
  gisQueries: [
    "How many transformers rated 5-20 kVA?",
    "Streetlight count by lamp type",
    "Cable length by voltage and status",
    "Substation count by DMS control",
    "‚Ü©Ô∏è Return to overview"
  ],
  operations: [
    "Trace downstream from TR-7A",
    "Generate SMS notification",
    "Create work order",
    "Show restoration workflow",
    "‚Ü©Ô∏è Return to overview"
  ]
};

const scriptedResponses = {
  // ===== INITIAL / CASCADE =====
  "investigate substation 7 cascade": {
    content: `<p><strong>‚ö° SUBSTATION 7 ‚Äî MUSSAFAH INDUSTRIAL: CRITICAL CASCADE RISK</strong></p>
<div class="viz-block">
<div class="viz-title">Thermal Status ‚Äî TR-7A</div>
<div class="viz-row"><span class="label">Current Oil Temperature</span><span class="value red">92¬∞C</span></div>
<div class="viz-row"><span class="label">Thermal Trip Point</span><span class="value">95¬∞C</span></div>
<div class="viz-row"><span class="label">Rate of Rise</span><span class="value amber">+1.2¬∞C/hour</span></div>
<div class="viz-row"><span class="label">Time to Trip</span><span class="value red">~2.5 hours</span></div>
<div class="viz-row"><span class="label">Transformer Age</span><span class="value">12 years (Fuji, 2013)</span></div>
<div class="viz-row"><span class="label">Maximo Health Score</span><span class="value red">34/100 (Critical)</span></div>
<div class="viz-row"><span class="label">Last PM (Maximo)</span><span class="value amber">847 days ago ‚Äî 2 deferred WOs</span></div>
<div class="viz-row"><span class="label">Rated KVA</span><span class="value">50,000 kVA</span></div>
<div class="viz-row"><span class="label">Replacement Cost</span><span class="value">AED 4.2M</span></div>
<div class="viz-row"><span class="label">Lead Time</span><span class="value red">18 weeks ‚Äî no spare until Q3</span></div>
</div>
<p><strong>N-1 contingency is already exhausted</strong> ‚Äî TR-7B is offline for planned maintenance, leaving no redundant incomer. If TR-7A trips, the cascade unfolds:</p>
<div class="viz-block">
<div class="viz-title">Cascade Timeline</div>
<div class="viz-row"><span class="label">T+0 min</span><span class="value red">Sub-7 trips ‚Üí automatic feeder transfer fails (no headroom) ‚Üí 45,200 customers dark</span></div>
<div class="viz-row"><span class="label">T+3 min</span><span class="value red">Sub-12 overloads from redirected 33kV load ‚Üí Downtown Core at risk</span></div>
<div class="viz-row"><span class="label">T+15 min</span><span class="value amber">3 water pumping stations lose grid power</span></div>
<div class="viz-row"><span class="label">T+14 hrs</span><span class="value amber">Backup diesel exhausted at pumping stations</span></div>
<div class="viz-row"><span class="label">T+18 hrs</span><span class="value red">340,000 residents lose water in 52¬∞C heat</span></div>
</div>
<p>Standard SCADA alarms trigger at static thresholds ‚Äî <strong>after</strong> the trip, when 45,000 customers are already dark. Nexus identified this thermal acceleration pattern and cascade trajectory at 86¬∞C, <strong>six hours earlier</strong>, when load redistribution across adjacent feeders was still viable.</p>
<div class="provenance"><div class="prov-label">Data Sources</div><div class="prov-tags"><span class="prov-tag">SCADA/ADMS</span><span class="prov-tag">Esri GIS</span><span class="prov-tag">DGA History</span><span class="prov-tag">IBM Maximo EAM</span><span class="prov-tag">Weather API</span></div></div>`,
    chips: chipSets.cascade,
    updateMetrics: false
  },

  "show affected customers downstream": {
    content: `<p><strong>NETWORK TRACE: TR-7A ‚Üí Downstream Customers</strong></p>
<div class="viz-block">
<div class="viz-title">Trace Path</div>
<div class="viz-trace">
<span class="trace-node source">TR-7A (92¬∞C)</span><span class="trace-arrow">‚Üí</span>
<span class="trace-node path">33kV Bus Bar</span><span class="trace-arrow">‚Üí</span>
<span class="trace-node path">CB-7A-01</span><span class="trace-arrow">‚Üí</span>
<span class="trace-node path">Feeder F7-01..F7-06</span><span class="trace-arrow">‚Üí</span>
<span class="trace-node path">12 √ó GMTs</span><span class="trace-arrow">‚Üí</span>
<span class="trace-node endpoint">847 Service Points</span>
</div>
</div>
<div class="viz-block">
<div class="viz-title">Affected Customers ‚Äî VIP Priority</div>
<table class="viz-table">
<tr><th>Service Point</th><th>Customer</th><th>Type</th><th>VIP</th><th>kWh/mo</th></tr>
<tr><td>SP-7A-001</td><td class="highlight">Abu Dhabi Steel Works</td><td>Industrial</td><td style="color:var(--accent-red)">STRATEGIC</td><td>2,340,000</td></tr>
<tr><td>SP-7A-002</td><td class="highlight">Mussafah Data Center</td><td>Industrial</td><td style="color:var(--accent-red)">CRITICAL</td><td>1,890,000</td></tr>
<tr><td>SP-7A-003</td><td class="highlight">Mussafah Industrial Hospital</td><td>Hospital</td><td style="color:var(--accent-red)">CRITICAL</td><td>567,000</td></tr>
<tr><td>SP-7A-008</td><td class="highlight">Emirates Aluminum Works</td><td>Industrial</td><td style="color:var(--accent-red)">STRATEGIC</td><td>1,567,000</td></tr>
<tr><td>SP-7A-004</td><td>Al Noor Industrial Park</td><td>Commercial</td><td>‚Äî</td><td>234,000</td></tr>
</table>
</div>
<p><strong>Summary:</strong> 847 total service points at risk. 13 industrial, 45 commercial, 789 residential. 3 VIP accounts require priority notification. Monthly revenue at risk: <strong>AED 4.2M</strong>.</p>
<div class="provenance"><div class="prov-label">Data Sources</div><div class="prov-tags"><span class="prov-tag">Esri GIS Trace</span><span class="prov-tag">CIS/Billing</span><span class="prov-tag">IBM Maximo EAM</span><span class="prov-tag">VIP Registry</span></div></div>`,
    chips: chipSets.trace
  },

  "whats the cascade timeline": {
    content: `<p><strong>FULL CASCADE TIMELINE ‚Äî Substation 7 Failure Scenario</strong></p>
<div class="viz-block">
<div class="viz-title">First-Order Effects (0‚Äì5 minutes)</div>
<div class="viz-row"><span class="label">T+0</span><span class="value red">TR-7A thermal trip at 95¬∞C ‚Üí Sub-7 offline</span></div>
<div class="viz-row"><span class="label">T+0</span><span class="value red">45,200 customers lose power immediately</span></div>
<div class="viz-row"><span class="label">T+0</span><span class="value amber">8 industrial facilities halt production</span></div>
<div class="viz-row"><span class="label">T+3 min</span><span class="value red">Sub-12 overloads (load redistribution fails)</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Second-Order Effects (5‚Äì60 minutes)</div>
<div class="viz-row"><span class="label">T+5 min</span><span class="value amber">34,100 more customers affected via Sub-12</span></div>
<div class="viz-row"><span class="label">T+8 min</span><span class="value amber">Corniche Hospital switches to backup generators</span></div>
<div class="viz-row"><span class="label">T+15 min</span><span class="value amber">3 water pumping stations lose grid feed ‚Üí diesel backup</span></div>
<div class="viz-row"><span class="label">T+45 min</span><span class="value">Grid frequency drops to 49.7 Hz (stress zone)</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Third-Order Effects (1‚Äì18 hours)</div>
<div class="viz-row"><span class="label">T+6 hrs</span><span class="value amber">Underground cables in Downtown Core approach thermal limits</span></div>
<div class="viz-row"><span class="label">T+14 hrs</span><span class="value red">Diesel reserves exhausted at pumping stations</span></div>
<div class="viz-row"><span class="label">T+18 hrs</span><span class="value red">340,000 residents lose water supply in 52¬∞C heat</span></div>
</div>
<p><strong>Total exposure: AED 18.7M</strong> across direct outage costs, economic impact, emergency response, and reputational damage.</p>`,
    chips: chipSets.cascade
  },

  "mitigation options for sub7": {
    content: `<p><strong>MITIGATION ANALYSIS ‚Äî 4 Options Ranked by ROI</strong></p>
<div class="viz-block">
<div class="viz-title">Option 1: Emergency Load Redistribution (Recommended)</div>
<div class="viz-row"><span class="label">Action</span><span class="value">Shift 40 MW from Sub-7 feeders to Sub-3 and Sub-6</span></div>
<div class="viz-row"><span class="label">Cost</span><span class="value green">AED 180,000 (switching ops + crew overtime)</span></div>
<div class="viz-row"><span class="label">Risk Reduced</span><span class="value green">AED 12.4M</span></div>
<div class="viz-row"><span class="label">ROI</span><span class="value green">69:1</span></div>
<div class="viz-row"><span class="label">Timeline</span><span class="value">Executable within 90 minutes</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Option 2: Mobile Cooling Deployment</div>
<div class="viz-row"><span class="label">Action</span><span class="value">Deploy portable oil coolers to TR-7A</span></div>
<div class="viz-row"><span class="label">Cost</span><span class="value">AED 320,000</span></div>
<div class="viz-row"><span class="label">Effect</span><span class="value green">Reduces oil temp by ~4¬∞C, buys 3+ additional hours</span></div>
<div class="viz-row"><span class="label">ROI</span><span class="value green">38:1</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Option 3: Targeted Demand Response</div>
<div class="viz-row"><span class="label">Action</span><span class="value">Curtail 5 largest commercial accounts on F7-03</span></div>
<div class="viz-row"><span class="label">Cost</span><span class="value">AED 450,000 (curtailment compensation)</span></div>
<div class="viz-row"><span class="label">Effect</span><span class="value green">Drops TR-7A load by 18%, stabilizes at 88¬∞C</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Option 4: Pre-positioned Mobile Substation</div>
<div class="viz-row"><span class="label">Action</span><span class="value">Stage mobile sub at Mussafah as backup</span></div>
<div class="viz-row"><span class="label">Cost</span><span class="value">AED 780,000 (transport + connection)</span></div>
<div class="viz-row"><span class="label">Effect</span><span class="value green">Full redundancy ‚Äî eliminates cascade risk entirely</span></div>
</div>
<p><strong>Recommendation:</strong> Execute Options 1 + 2 simultaneously. Combined cost AED 500K protects AED 15.5M. Combined ROI: <strong>31:1</strong>.</p>`,
    chips: chipSets.cascade,
    updateMetrics: true
  },

  // ===== FINANCIAL =====
  "whats our total financial exposure": {
    content: `<p><strong>üí∞ TOTAL FINANCIAL EXPOSURE ‚Äî Heat Wave Scenario</strong></p>
<div class="viz-block">
<div class="viz-title">Exposure Breakdown</div>
<div class="viz-row"><span class="label">Direct Outage Cost (SAIDI impact)</span><span class="value red">AED 4.2M</span></div>
<div class="viz-row"><span class="label">Industrial Customer Economic Loss</span><span class="value red">AED 6.8M</span></div>
<div class="viz-row"><span class="label">Emergency Response & Restoration</span><span class="value amber">AED 2.1M</span></div>
<div class="viz-row"><span class="label">Water Network Emergency (diesel, tankers)</span><span class="value amber">AED 1.8M</span></div>
<div class="viz-row"><span class="label">Regulatory Penalty (SAIDI/SAIFI breach)</span><span class="value amber">AED 2.4M</span></div>
<div class="viz-row"><span class="label">Equipment Damage (accelerated aging)</span><span class="value">AED 1.4M</span></div>
<div class="viz-row" style="border-top:1px solid var(--border-subtle);padding-top:6px;margin-top:4px"><span class="label" style="font-weight:700;color:var(--text-primary)">TOTAL EXPOSURE</span><span class="value red" style="font-size:14px">AED 18.7M</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Proactive Mitigation Cost</div>
<div class="viz-row"><span class="label">Load redistribution + mobile cooling</span><span class="value green">AED 500K</span></div>
<div class="viz-row"><span class="label">Demand response (curtailment)</span><span class="value green">AED 450K</span></div>
<div class="viz-row"><span class="label">Emergency crew standby</span><span class="value green">AED 350K</span></div>
<div class="viz-row" style="border-top:1px solid var(--border-subtle);padding-top:6px;margin-top:4px"><span class="label" style="font-weight:700;color:var(--text-primary)">TOTAL MITIGATION</span><span class="value green">AED 1.3M</span></div>
</div>
<p><strong>Net protection:</strong> AED 1.3M spent to protect AED 15.5M. <strong>ROI: 12:1</strong>. Remaining residual exposure: AED 3.2M (unavoidable aging costs).</p>`,
    chips: chipSets.financial
  },

  // ===== WATER-ENERGY NEXUS =====
  "waterenergy nexus status": {
    content: `<p><strong>üíß WATER-ENERGY NEXUS ‚Äî Critical Interdependency Alert</strong></p>
<div class="viz-block">
<div class="viz-title">Southern Water Corridor Status</div>
<div class="viz-row"><span class="label">Pumping Station PS-South-1</span><span class="value red">ON BACKUP DIESEL</span></div>
<div class="viz-row"><span class="label">Pumping Station PS-South-2</span><span class="value red">ON BACKUP DIESEL</span></div>
<div class="viz-row"><span class="label">Pumping Station PS-South-3</span><span class="value red">ON BACKUP DIESEL</span></div>
<div class="viz-row"><span class="label">Diesel Reserve (PS-South-1)</span><span class="value amber">14 hours remaining</span></div>
<div class="viz-row"><span class="label">Diesel Reserve (PS-South-2)</span><span class="value amber">11 hours remaining</span></div>
<div class="viz-row"><span class="label">Diesel Reserve (PS-South-3)</span><span class="value red">8 hours remaining</span></div>
<div class="viz-row"><span class="label">Residents Dependent</span><span class="value red">340,000</span></div>
</div>
<p>These three pumping stations lost grid feed when feeder F7-09 tripped during the initial Sub-7 stress event. Desalination output is stable, but <strong>distribution</strong> is the bottleneck ‚Äî the pumps can't push water without power.</p>
<p><strong>Cascade logic:</strong> If Sub-7 fully trips ‚Üí feeder F7-09 is permanently lost ‚Üí diesel runs out in 8-14 hours ‚Üí 340,000 residents lose water in 52¬∞C heat. This transforms an electrical outage into a <strong>public health emergency</strong>.</p>
<div class="provenance"><div class="prov-label">Data Sources</div><div class="prov-tags"><span class="prov-tag">SCADA (Pumping)</span><span class="prov-tag">IBM Maximo EAM</span><span class="prov-tag">Fuel Monitoring</span><span class="prov-tag">Population GIS</span></div></div>`,
    chips: chipSets.water
  },

  // ===== GIS / STATISTICAL QUERIES =====
  "transformer inventory summary": {
    content: `<p><strong>üîß TRANSFORMER INVENTORY ‚Äî Abu Dhabi Distribution Network</strong></p>
<div class="viz-block">
<div class="viz-title">By Subtype (from ABUDHABI.Transformer)</div>
<table class="viz-table">
<tr><th>Subtype</th><th>Count</th><th>Total kVA</th></tr>
<tr><td class="highlight">GMT (Ground Mounted)</td><td>4,847</td><td>2,456,000</td></tr>
<tr><td class="highlight">PMT (Pole Mounted)</td><td>3,212</td><td>845,000</td></tr>
<tr><td>Power Transformer</td><td>89</td><td>12,340,000</td></tr>
<tr><td>Step Transformer</td><td>34</td><td>1,200,000</td></tr>
<tr><td>Isolation Transformer</td><td>67</td><td>234,000</td></tr>
<tr><td>T_Transformer</td><td>12</td><td>89,000</td></tr>
<tr style="border-top:1px solid var(--border-subtle)"><td class="highlight">TOTAL</td><td class="highlight">8,261</td><td class="highlight">17,164,000</td></tr>
</table>
</div>
<div class="viz-block">
<div class="viz-title">By Manufacturer (Top 5)</div>
<div class="viz-row"><span class="label">ABB</span><span class="value">2,134 units (25.8%)</span></div>
<div class="viz-row"><span class="label">Schneider Electric</span><span class="value">1,876 units (22.7%)</span></div>
<div class="viz-row"><span class="label">Siemens</span><span class="value">1,543 units (18.7%)</span></div>
<div class="viz-row"><span class="label">Fuji Electric</span><span class="value">1,234 units (14.9%)</span></div>
<div class="viz-row"><span class="label">Alstom</span><span class="value">987 units (11.9%)</span></div>
</div>
<div class="viz-block">
<div class="viz-title">Age Profile (ManufactureYear)</div>
<div class="viz-row"><span class="label">0-5 years (2020-2025)</span><span class="value green">2,456 units</span></div>
<div class="viz-row"><span class="label">5-10 years (2015-2020)</span><span class="value green">2,134 units</span></div>
<div class="viz-row"><span class="label">10-15 years (2010-2015)</span><span class="value amber">1,987 units</span></div>
<div class="viz-row"><span class="label">15-20 years (2005-2010)</span><span class="value amber">1,234 units</span></div>
<div class="viz-row"><span class="label">>20 years (pre-2005)</span><span class="value red">450 units ‚ö†Ô∏è</span></div>
</div>
<p>450 transformers are beyond their 20-year design life. Of these, <strong>67 have no redundancy</strong> (single points of failure). Priority replacement program recommended.</p>`,
    chips: chipSets.gisQueries
  },

  // ===== OPERATIONAL WORKFLOWS =====
  "generate incident work order": {
    content: `<p><strong>üìã WORK ORDER GENERATED</strong></p>
<div class="viz-workorder">
<div class="wo-header">WO-2025-07-4821 ‚Äî EMERGENCY</div>
<div class="wo-field"><span class="wo-label">Asset ID</span><span class="wo-value">TR-7A (FacilityID: TRF-S7-001)</span></div>
<div class="wo-field"><span class="wo-label">Location</span><span class="wo-value">Substation 7 ‚Äî Mussafah Industrial</span></div>
<div class="wo-field"><span class="wo-label">Issue Type</span><span class="wo-value">Thermal Stress ‚Äî Oil Temperature Exceedance</span></div>
<div class="wo-field"><span class="wo-label">Priority</span><span class="wo-value" style="color:var(--accent-red)">P1 ‚Äî CRITICAL</span></div>
<div class="wo-field"><span class="wo-label">Description</span><span class="wo-value">TR-7A oil temp at 92¬∞C (limit 95¬∞C), rising +1.2¬∞C/hr. Cascade risk to S12, S15, S18. Water corridor PS at risk.</span></div>
<div class="wo-field"><span class="wo-label">Assigned Crew</span><span class="wo-value">Substation Maintenance Team A (6 persons)</span></div>
<div class="wo-field"><span class="wo-label">Est. Duration</span><span class="wo-value">4-6 hours</span></div>
<div class="wo-field"><span class="wo-label">Affected Customers</span><span class="wo-value">847 service points (3 VIP accounts)</span></div>
<div class="wo-field"><span class="wo-label">VIP Impact</span><span class="wo-value" style="color:var(--accent-red)">Abu Dhabi Steel Works, Mussafah Data Center, Mussafah Industrial Hospital</span></div>
<div class="wo-field"><span class="wo-label">Equipment Needed</span><span class="wo-value">Mobile oil cooler, portable transformer testing kit, thermal camera</span></div>
</div>
<p>Work order synced to Maximo (MXASSETNUM: TR-S7-001). VIP customers flagged for priority notification via email + SMS + personal call from Customer Relations.</p>`,
    chips: chipSets.operations
  },

  "send maintenance sms to all affected": {
    content: `<p><strong>üì± NOTIFICATION TEMPLATES GENERATED</strong></p>
<div class="viz-notification">
<div class="notif-header">üì± SMS ‚Äî Standard Customers (844 recipients)</div>
<div class="notif-body">TAQA Distribution Alert: Planned maintenance in Mussafah Industrial area. Power may be interrupted [DATE] [TIME]-[TIME]. We apologize for the inconvenience. For updates: 800-TAQA (8272)</div>
</div>
<div class="viz-notification" style="margin-top:8px;border-color:rgba(239,68,68,0.15);background:rgba(239,68,68,0.05)">
<div class="notif-header" style="color:var(--accent-red)">üö® VIP Protocol ‚Äî 3 Recipients (Email + SMS + Call)</div>
<div class="notif-body">URGENT ‚Äî TAQA Distribution
Priority Notification for: Abu Dhabi Steel Works
Asset: Substation 7 / TR-7A
Issue: Thermal stress requiring emergency intervention
Expected Impact: Potential power interruption 2-4 hours
Action: Emergency mobile cooling deployment in progress
VIP Liaison: Ahmed Al-Rashid, +971-XX-XXX-XXXX
Next Update: Within 60 minutes</div>
</div>
<p>Standard SMS queued for dispatch. VIP notifications require manual confirmation before sending ‚Äî <strong>3 VIP accounts flagged for Customer Relations personal call.</strong></p>`,
    chips: chipSets.operations
  },

  // ===== NOTIFY VIP (alias for SMS response) =====
  "notify vip customers": {
    content: `<p><strong>üì± VIP NOTIFICATION PROTOCOL ACTIVATED</strong></p>
<div class="viz-notification">
<div class="notif-header">üì± SMS ‚Äî Standard Customers (844 recipients)</div>
<div class="notif-body">TAQA Distribution Alert: Planned maintenance in Mussafah Industrial area. Power may be interrupted [DATE] [TIME]-[TIME]. We apologize for the inconvenience. For updates: 800-TAQA (8272)</div>
</div>
<div class="viz-notification" style="margin-top:8px;border-color:rgba(239,68,68,0.15);background:rgba(239,68,68,0.05)">
<div class="notif-header" style="color:var(--accent-red)">üö® VIP Protocol ‚Äî 3 Recipients (Email + SMS + Call)</div>
<div class="notif-body">URGENT ‚Äî TAQA Distribution
Priority Notification for: Abu Dhabi Steel Works
Asset: Substation 7 / TR-7A
Issue: Thermal stress requiring emergency intervention
Expected Impact: Potential power interruption 2-4 hours
Action: Emergency mobile cooling deployment in progress
VIP Liaison: Ahmed Al-Rashid, +971-XX-XXX-XXXX
Next Update: Within 60 minutes</div>
</div>
<p>Standard SMS queued for dispatch. VIP notifications require manual confirmation before sending ‚Äî <strong>3 VIP accounts flagged for Customer Relations personal call.</strong></p>`,
    chips: chipSets.operations
  },

  // ===== ASSET MANAGEMENT =====
  "asset portfolio criticality ranking": {
    content: `<p><strong>üìä ASSET PORTFOLIO ‚Äî Criticality Ranking (Top 10)</strong></p>
<div class="viz-block">
<div class="viz-title">Criticality Score = f(Age, Load, Redundancy, VIP Impact, Replacement Cost)</div>
<table class="viz-table">
<tr><th>#</th><th>Asset</th><th>Type</th><th>Age</th><th>Score</th><th>Action</th></tr>
<tr><td>1</td><td class="highlight" style="color:var(--accent-red)">TR-7A (Sub-7)</td><td>Power TX</td><td>12yr</td><td style="color:var(--accent-red)">97</td><td>Replace Q3</td></tr>
<tr><td>2</td><td class="highlight">TR-12A (Sub-12)</td><td>Power TX</td><td>15yr</td><td style="color:var(--accent-red)">91</td><td>Replace Q4</td></tr>
<tr><td>3</td><td class="highlight">CB-S15-01</td><td>Circuit Bkr</td><td>18yr</td><td style="color:var(--accent-amber)">84</td><td>Refurbish</td></tr>
<tr><td>4</td><td>TR-18B (Sub-18)</td><td>GMTs</td><td>14yr</td><td style="color:var(--accent-amber)">79</td><td>Monitor</td></tr>
<tr><td>5</td><td>F7-03 Cable</td><td>33kV UG</td><td>20yr</td><td style="color:var(--accent-amber)">76</td><td>Replace</td></tr>
<tr><td>6</td><td>TR-6C (Sub-6)</td><td>Power TX</td><td>11yr</td><td>72</td><td>Monitor</td></tr>
<tr><td>7</td><td>VR-S12-01</td><td>Voltage Reg</td><td>16yr</td><td>68</td><td>Test</td></tr>
<tr><td>8</td><td>SW-S3-04</td><td>UG Disconnect</td><td>19yr</td><td>65</td><td>Replace</td></tr>
<tr><td>9</td><td>CAP-S18-02</td><td>Capacitor Bank</td><td>13yr</td><td>61</td><td>Test</td></tr>
<tr><td>10</td><td>TR-9A (Sub-9)</td><td>QRM TX</td><td>10yr</td><td>58</td><td>Monitor</td></tr>
</table>
</div>
<p><strong>Budget recommendation:</strong> AED 52M capex over 24 months. Top 3 assets account for 65% of cascade risk in the network. Addressing them reduces system-wide SAIDI by an estimated 40%.</p>`,
    chips: chipSets.assetMgmt
  },

  "how many transformers rated 520 kva": {
    content: `<p><strong>QUERY: Transformers Rated 5-20 kVA</strong></p>
<div class="viz-block">
<div class="viz-title">Results from ABUDHABI.Transformer (RatedKVA between 5 and 20)</div>
<table class="viz-table">
<tr><th>Subtype</th><th>Manufacturer</th><th>Count</th><th>Avg Age</th></tr>
<tr><td>PMT</td><td>ABB</td><td>234</td><td>8.2 yr</td></tr>
<tr><td>PMT</td><td>Schneider</td><td>198</td><td>9.1 yr</td></tr>
<tr><td>PMT</td><td>Fuji</td><td>167</td><td>11.4 yr</td></tr>
<tr><td>GMT</td><td>ABB</td><td>89</td><td>6.7 yr</td></tr>
<tr><td>GMT</td><td>Siemens</td><td>76</td><td>7.3 yr</td></tr>
<tr style="border-top:1px solid var(--border-subtle)"><td class="highlight" colspan="2">TOTAL</td><td class="highlight">764</td><td>8.5 yr</td></tr>
</table>
</div>
<p>764 transformers in the 5-20 kVA range, predominantly PMTs (599) vs GMTs (165). The Fuji PMT cohort has the highest average age at 11.4 years ‚Äî candidates for condition assessment.</p>`,
    chips: chipSets.gisQueries
  },

  "show grid thermal stress map": {
    content: `<p><strong>üî• GRID THERMAL STRESS ‚Äî All Substations</strong></p>
<div class="viz-block">
<div class="viz-title">Substation Thermal Status (sorted by temperature)</div>
<table class="viz-table">
<tr><th>Substation</th><th>Type</th><th>Temp</th><th>Limit</th><th>Status</th><th>Customers</th></tr>
<tr><td class="highlight" style="color:var(--accent-red)">S7 ‚Äî Mussafah Industrial</td><td>PRY 33/11</td><td style="color:var(--accent-red)">92¬∞C</td><td>95¬∞C</td><td style="color:var(--accent-red)">CRITICAL</td><td>45,200</td></tr>
<tr><td class="highlight" style="color:#f97316">S12 ‚Äî Downtown Core</td><td>S/S</td><td style="color:#f97316">89¬∞C</td><td>95¬∞C</td><td style="color:#f97316">HIGH</td><td>34,100</td></tr>
<tr><td class="highlight" style="color:#f97316">S15 ‚Äî Mussafah Port</td><td>PRY 33/11</td><td style="color:#f97316">87¬∞C</td><td>95¬∞C</td><td style="color:#f97316">HIGH</td><td>28,500</td></tr>
<tr><td>S18 ‚Äî Corniche Residential</td><td>GMT</td><td style="color:var(--accent-amber)">85¬∞C</td><td>95¬∞C</td><td style="color:var(--accent-amber)">MOD</td><td>52,800</td></tr>
<tr><td>S6 ‚Äî Al Reem Island</td><td>S/S</td><td style="color:var(--accent-amber)">82¬∞C</td><td>95¬∞C</td><td style="color:var(--accent-amber)">MOD</td><td>42,100</td></tr>
<tr><td>S3 ‚Äî Khalifa City</td><td>SW/S</td><td style="color:var(--accent-emerald)">78¬∞C</td><td>95¬∞C</td><td style="color:var(--accent-emerald)">OK</td><td>38,200</td></tr>
<tr><td>S9 ‚Äî Yas Island</td><td>QRM</td><td style="color:var(--accent-emerald)">76¬∞C</td><td>95¬∞C</td><td style="color:var(--accent-emerald)">OK</td><td>24,600</td></tr>
<tr><td>S21 ‚Äî Saadiyat Cultural</td><td>TRM</td><td style="color:var(--accent-emerald)">74¬∞C</td><td>95¬∞C</td><td style="color:var(--accent-emerald)">OK</td><td>18,900</td></tr>
</table>
</div>
<p><strong>3 substations in danger zone</strong> (>85¬∞C). Combined customer exposure: 107,800 service points. Sub-7 is the priority ‚Äî it's the only one approaching trip threshold within the next 3 hours.</p>`,
    chips: chipSets.cascade
  },

  // ===== RETURN TO OVERVIEW =====
  "return to overview": {
    content: `<p>Back to the main dashboard. The grid situation remains active:</p>
<div class="viz-block">
<div class="viz-title">Current Status Summary</div>
<div class="viz-row"><span class="label">Critical Substations</span><span class="value red">1 (Sub-7 ‚Äî 92¬∞C)</span></div>
<div class="viz-row"><span class="label">High-Risk Substations</span><span class="value amber">2 (Sub-12, Sub-15)</span></div>
<div class="viz-row"><span class="label">Total Exposure</span><span class="value red">AED 18.7M</span></div>
<div class="viz-row"><span class="label">Customers at Risk</span><span class="value">107,800 direct + 340,000 water</span></div>
<div class="viz-row"><span class="label">Time to Critical</span><span class="value red">~2.5 hours (Sub-7 TR-7A)</span></div>
</div>
<p>What would you like to investigate?</p>`,
    chips: chipSets.initial
  }
};

// ============================================
// FUNCTIONS
// ============================================

let isProcessing = false;
let conversationHistory = [];
const ALLOWED_HTML = ['div','span','strong','em','br','p','b','i','ul','ol','li','table','tr','td','th','thead','tbody'];
const ALLOWED_ATTR = ['class','style','colspan'];

function sanitize(html) {
  return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html, { ALLOWED_TAGS: ALLOWED_HTML, ALLOWED_ATTR: ALLOWED_ATTR }) : html;
}

function normalizeText(t) {
  return t.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
}

function findResponse(text) {
  const n = normalizeText(text);
  // Direct match
  for (const [key, val] of Object.entries(scriptedResponses)) {
    if (n === key || n.includes(key) || key.includes(n)) return val;
  }
  // Keyword routing
  if (n.includes('cascade') || n.includes('substation 7') || n.includes('sub7') || n.includes('sub 7')) return scriptedResponses['investigate substation 7 cascade'];
  if (n.includes('customer') && (n.includes('affected') || n.includes('downstream') || n.includes('trace'))) return scriptedResponses['show affected customers downstream'];
  if (n.includes('timeline')) return scriptedResponses['whats the cascade timeline'];
  if (n.includes('mitigat')) return scriptedResponses['mitigation options for sub7'];
  if (n.includes('financial') || n.includes('exposure') || n.includes('187') || n.includes('dollar') || n.includes('cost')) return scriptedResponses['whats our total financial exposure'];
  if (n.includes('water') || n.includes('pumping') || n.includes('nexus') || n.includes('desalination')) return scriptedResponses['waterenergy nexus status'];
  if (n.includes('transformer') && (n.includes('inventory') || n.includes('summary') || n.includes('how many'))) return scriptedResponses['transformer inventory summary'];
  if (n.includes('520') || (n.includes('rated') && n.includes('kva'))) return scriptedResponses['how many transformers rated 520 kva'];
  if (n.includes('work order') || n.includes('workorder')) return scriptedResponses['generate incident work order'];
  if (n.includes('sms') || n.includes('notify') || n.includes('notification') || n.includes('send')) return scriptedResponses['send maintenance sms to all affected'];
  if (n.includes('thermal') || n.includes('stress') || n.includes('heat map')) return scriptedResponses['show grid thermal stress map'];
  if (n.includes('portfolio') || n.includes('criticality') || n.includes('ranking') || n.includes('capex')) return scriptedResponses['asset portfolio criticality ranking'];
  if (n.includes('overview') || n.includes('return') || n.includes('back')) return scriptedResponses['return to overview'];
  return null;
}

function scrollToBottom() {
  const c = document.getElementById('chatMessages');
  c.scrollTop = c.scrollHeight;
}

function addMessage(content, isUser = false) {
  const c = document.getElementById('chatMessages');
  const m = document.createElement('div');
  m.className = `message ${isUser ? 'user' : 'assistant'}`;
  m.innerHTML = `<div class="msg-bubble">${isUser ? DOMPurify.sanitize(content) : sanitize(content)}</div>`;
  c.appendChild(m);
  scrollToBottom();
}

function showTyping() {
  const c = document.getElementById('chatMessages');
  const m = document.createElement('div');
  m.className = 'message assistant';
  m.id = 'typingMsg';
  m.innerHTML = '<div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>';
  c.appendChild(m);
  scrollToBottom();
}

function hideTyping() {
  const e = document.getElementById('typingMsg');
  if (e) e.remove();
}

function updateChips(chips) {
  const g = document.getElementById('chipsGrid');
  g.innerHTML = '';
  chips.forEach(chip => {
    const b = document.createElement('button');
    b.className = 'chip';
    if (chip.includes('Return') || chip.includes('‚Ü©Ô∏è')) b.className += ' overview';
    b.textContent = chip;
    b.onclick = () => handleChipClick(chip);
    g.appendChild(b);
  });
}

function updateProtected() {
  document.getElementById('protectedValue').textContent = 'AED 15.5M';
  document.getElementById('protectedDetail').textContent = 'Mitigation active';
  document.getElementById('kpiProtected').textContent = 'AED 15.5M';
}

// Map zoom targets for each query type
const zoomTargets = {
  "sub-7": { center: [54.50, 24.35], zoom: 14, schematic: true },
  "sub-12": { center: [54.37, 24.49], zoom: 14, schematic: false },
  "cascade": { center: [54.50, 24.35], zoom: 14, schematic: true },
  "thermal": { center: [54.48, 24.38], zoom: 12, schematic: false },
  "financial": { center: [54.48, 24.42], zoom: 11, schematic: false },
  "water": { center: [54.52, 24.33], zoom: 13, schematic: false },
  "transformer": { center: [54.48, 24.42], zoom: 12, schematic: false },
  "asset": { center: [54.48, 24.42], zoom: 11, schematic: false },
  "trace": { center: [54.50, 24.35], zoom: 15, schematic: true },
  "overview": { center: [54.55, 24.42], zoom: 11, schematic: false },
  "inventory": { center: [54.48, 24.42], zoom: 11, schematic: false },
  "customers": { center: [54.50, 24.35], zoom: 14, schematic: true },
  "work order": { center: [54.50, 24.35], zoom: 14, schematic: true },
  "mitigation": { center: [54.50, 24.35], zoom: 13, schematic: true },
  "notify": { center: [54.50, 24.35], zoom: 14, schematic: true },
  "sms": { center: [54.50, 24.35], zoom: 14, schematic: false },
  "pumping": { center: [54.52, 24.33], zoom: 13, schematic: false },
  "diesel": { center: [54.52, 24.33], zoom: 13, schematic: false },
  "dga": { center: [54.50, 24.35], zoom: 15, schematic: true },
  "spare": { center: [54.50, 24.35], zoom: 14, schematic: true },
  "crew": { center: [54.50, 24.35], zoom: 14, schematic: true },
};

function getZoomTarget(chipText) {
  const t = chipText.toLowerCase();
  for (const [key, val] of Object.entries(zoomTargets)) {
    if (t.includes(key)) return val;
  }
  return null;
}

function showSchematic(show) {
  const el = document.querySelector('.schematic-inset');
  if (el) { if (show) el.classList.add('visible'); else el.classList.remove('visible'); }
}

async function handleChipClick(chipText) {
  if (isProcessing) return;
  isProcessing = true;
  addMessage(chipText, true);
  showTyping();

  // Zoom map and toggle schematic
  const zoom = getZoomTarget(chipText);
  if (zoom && window._mapView) {
    window._mapView.goTo({ center: zoom.center, zoom: zoom.zoom }, { duration: 800, easing: "ease-in-out" });
    showSchematic(zoom.schematic);
  } else {
    showSchematic(false);
  }

  await new Promise(r => setTimeout(r, 500 + Math.random() * 500));
  const response = findResponse(chipText);
  hideTyping();
  if (response) {
    addMessage(response.content);
    if (response.updateMetrics) updateProtected();
    updateChips(response.chips || chipSets.initial);
  } else {
    addMessage('<p>I can analyze that further. The current grid situation involves AED 14.8M in exposure across 6 substations with cascade risk to 47,200 customers. Try one of the suggested queries for detailed analysis.</p>');
    updateChips(chipSets.initial);
  }
  isProcessing = false;
}

function handleSend() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  handleChipClick(text);
}

document.getElementById('chatInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
});

// ===== TOUR =====
const tourSteps = [
  { el: '.brand', title: 'Welcome to NexusGrid', desc: 'This is TAQA Distribution\'s AI command center. A 52¬∞C heat wave is stressing the Abu Dhabi grid ‚Äî Nexus is monitoring 45 substations in real-time.', pos: 'bottom' },
  { el: '.analytics-sidebar', title: 'Live Grid Metrics', desc: 'Real-time exposure tracking. AED 14.8M at risk across 6 substations. Reserve margin collapsed to 2.4%.', pos: 'left' },
  { el: '.map-legend', title: 'Network Visualization', desc: 'Esri GIS map showing all substations color-coded by thermal status. Red = critical. Transmission and distribution lines visible.', pos: 'top' },
  { el: '.chat-header', title: 'Conversational Intelligence', desc: 'Ask natural language questions about the grid. "What happens if Sub-7 trips?" or "How many transformers rated 5-20 kVA?"', pos: 'left' },
  { el: '.chips-area', title: 'Smart Suggestions', desc: 'Context-aware prompts that adapt as you explore. Start with "Investigate Substation 7 Cascade" to see the full scenario.', pos: 'top' }
];
let tourStep = 0;

function startTour() {
  tourStep = 0;
  document.getElementById('tourOverlay').classList.add('active');
  showTourStep();
}

function showTourStep() {
  const step = tourSteps[tourStep];
  const el = document.querySelector(step.el);
  if (!el) { nextTourStep(); return; }
  const rect = el.getBoundingClientRect();
  const tooltip = document.getElementById('tourTooltip');
  const isLast = tourStep === tourSteps.length - 1;
  tooltip.innerHTML = `
    <div class="tour-title">${step.title}</div>
    <div class="tour-desc">${step.desc}</div>
    <button class="tour-btn" onclick="${isLast ? 'endTour()' : 'nextTourStep()'}">${isLast ? 'Start Exploring ‚Üí' : 'Next'}</button>
    <span class="tour-step">${tourStep + 1}/${tourSteps.length}</span>`;
  
  let top, left;
  if (step.pos === 'bottom') { top = rect.bottom + 12; left = rect.left; }
  else if (step.pos === 'left') { top = rect.top; left = rect.left - 340; }
  else { top = rect.top - 180; left = rect.left; }
  tooltip.style.top = Math.max(10, Math.min(top, window.innerHeight - 250)) + 'px';
  tooltip.style.left = Math.max(10, Math.min(left, window.innerWidth - 350)) + 'px';
}

function nextTourStep() { tourStep++; if (tourStep >= tourSteps.length) { endTour(); return; } showTourStep(); }
function endTour() { document.getElementById('tourOverlay').classList.remove('active'); }

// ===== INIT =====
updateChips(chipSets.initial);
addMessage(`<p><strong>üî• HEAT WAVE ALERT ‚Äî Abu Dhabi Grid Under Stress</strong></p>
<p>Nexus has detected critical thermal stress across the distribution network. Key findings:</p>
<div class="viz-block">
<div class="viz-row"><span class="label">Ambient Temperature</span><span class="value red">52¬∞C (5-day forecast)</span></div>
<div class="viz-row"><span class="label">Peak Demand</span><span class="value red">12.4 GW vs 12.7 GW capacity</span></div>
<div class="viz-row"><span class="label">Highest Risk</span><span class="value red">Sub-7 Mussafah ‚Äî TR-7A at 92¬∞C</span></div>
<div class="viz-row"><span class="label">Cascade Exposure</span><span class="value red">AED 18.7M across 4 substations</span></div>
<div class="viz-row"><span class="label">Water Impact</span><span class="value amber">340,000 residents if pumping stations fail</span></div>
</div>
<p>Nexus identified this cascading failure trajectory <strong>6 hours before</strong> standard alarm thresholds would have triggered emergency protocols ‚Äî when load redistribution was still feasible. What would you like to investigate?</p>`);

// Update alert time
setInterval(() => {
  document.getElementById('alertTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}, 60000);
document.getElementById('alertTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

setTimeout(startTour, 1500);
</script>
</body>
</html>
