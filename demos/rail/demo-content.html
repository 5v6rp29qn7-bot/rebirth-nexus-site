<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus ‚Äî Rail Intelligence Platform</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #1a1d29;
            --bg-secondary: #232836;
            --bg-tertiary: #2a3042;
            --bg-card: #323848;
            --text-primary: #ffffff;
            --text-secondary: #a8b2c1;
            --text-muted: #6b7280;
            --accent-purple: #8b8fff;
            --accent-cyan: #5fd4ff;
            --accent-green: #5ee88a;
            --accent-amber: #ffcf3d;
            --accent-red: #ff7979;
            --border-subtle: rgba(140, 180, 255, 0.25);
        }
        html, body { height: 100%; overflow: hidden; background: var(--bg-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; color: var(--text-primary); }
        .app-container { display: flex; flex-direction: column; height: 100%; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .sensor-feed { width: 300px; background: var(--bg-secondary); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; flex-shrink: 0; }
        .feed-header { padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; background: var(--bg-primary); }
        .feed-title { font-size: 12px; font-weight: 700; color: var(--accent-cyan); text-transform: uppercase; }
        .feed-live { font-size: 10px; background: rgba(95, 212, 255, 0.2); color: var(--accent-cyan); padding: 3px 8px; border-radius: 10px; display: flex; align-items: center; gap: 4px; }
        .feed-live::before { content: ""; width: 6px; height: 6px; background: var(--accent-cyan); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .feed-items { flex: 1; overflow-y: auto; padding: 12px; }
        .feed-item { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px; margin-bottom: 10px; transition: all 0.2s; }
        .feed-item:hover { border-color: var(--accent-purple); }
        .feed-item.critical { border-left: 3px solid var(--accent-red); }
        .feed-item.warning { border-left: 3px solid var(--accent-amber); }
        .feed-item.info { border-left: 3px solid var(--accent-cyan); }
        .feed-item.success { border-left: 3px solid var(--accent-green); }
        .feed-meta { font-size: 10px; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 6px; }
        .feed-type { text-transform: uppercase; font-weight: 600; }
        .feed-type.critical { color: var(--accent-red); }
        .feed-type.warning { color: var(--accent-amber); }
        .feed-type.info { color: var(--accent-cyan); }
        .feed-type.success { color: var(--accent-green); }
        .feed-headline { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .feed-body { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .center-panel { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-primary); }
        #mapView { flex: 1; width: 100%; height: 100%; }
        .stats-overlay { position: absolute; top: 20px; right: 20px; background: rgba(26, 29, 41, 0.95); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 16px; width: 260px; backdrop-filter: blur(8px); z-index: 100; }
        .overlay-title { font-size: 11px; font-weight: 700; color: var(--accent-purple); margin-bottom: 14px; text-transform: uppercase; border-bottom: 1px solid var(--border-subtle); padding-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; }
        .stat-label { color: var(--text-muted); }
        .stat-val { font-weight: 600; }
        .stat-val.up { color: var(--accent-green); }
        .stat-val.down { color: var(--accent-red); }
        .stat-val.warn { color: var(--accent-amber); }
        .chat-panel { width: 420px; background: var(--bg-secondary); border-left: 1px solid var(--border-subtle); display: flex; flex-direction: column; flex-shrink: 0; }
        .chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 14px; background: var(--bg-primary); }
        .logo-box { width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent-purple), #6b6fdf); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .header-info h2 { font-size: 15px; font-weight: 700; }
        .header-info p { font-size: 10px; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 2px; }
        .kpi-strip { display: flex; padding: 14px 16px; gap: 12px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-tertiary); }
        .kpi-card { flex: 1; text-align: center; padding: 8px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-subtle); }
        .kpi-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .kpi-val { font-size: 15px; font-weight: 700; }
        .kpi-val.green { color: var(--accent-green); }
        .kpi-val.red { color: var(--accent-red); }
        .kpi-val.amber { color: var(--accent-amber); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 20px; max-width: 95%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { margin-left: auto; text-align: right; }
        .message-content { display: inline-block; padding: 14px 18px; border-radius: 14px; font-size: 13px; line-height: 1.6; text-align: left; }
        .message.assistant .message-content { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .message.user .message-content { background: var(--accent-purple); color: #fff; font-weight: 500; }
        .viz-roi-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 14px 0; }
        .roi-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px; text-align: center; }
        .roi-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }
        .roi-value { font-size: 18px; font-weight: 700; }
        .roi-value.green { color: var(--accent-green); }
        .roi-value.red { color: var(--accent-red); }
        .roi-value.amber { color: var(--accent-amber); }
        .viz-risk-matrix { background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 8px; margin: 14px 0; overflow: hidden; }
        .risk-matrix-header { background: var(--bg-card); padding: 10px 14px; font-size: 12px; font-weight: 600; border-bottom: 1px solid var(--border-subtle); }
        .risk-item { display: flex; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--border-subtle); gap: 12px; }
        .risk-item:last-child { border-bottom: none; }
        .risk-level { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .risk-level.critical { background: var(--accent-red); }
        .risk-level.high { background: var(--accent-amber); }
        .risk-info { flex: 1; }
        .risk-name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .risk-detail { font-size: 11px; color: var(--text-muted); }
        .risk-value { font-size: 13px; font-weight: 700; min-width: 60px; text-align: right; }
        .risk-value.red { color: var(--accent-red); }
        .risk-value.amber { color: var(--accent-amber); }
        .viz-timeline { margin: 14px 0; padding-left: 20px; border-left: 2px solid var(--border-subtle); }
        .timeline-item { position: relative; padding: 0 0 20px 20px; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-marker { position: absolute; left: -26px; top: 4px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-secondary); }
        .timeline-marker.red { background: var(--accent-red); }
        .timeline-marker.amber { background: var(--accent-amber); }
        .timeline-time { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
        .timeline-title { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .timeline-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .typing-indicator { display: flex; gap: 4px; padding: 14px 18px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 14px; width: fit-content; }
        .typing-dot { width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%; animation: typingBounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        .input-area { padding: 16px 20px; border-top: 1px solid var(--border-subtle); background: var(--bg-primary); }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
        .chip { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--accent-cyan); padding: 8px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .chip:hover { border-color: var(--accent-purple); color: var(--accent-purple); }
        .input-box { display: flex; gap: 10px; }
        .chat-input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: white; padding: 12px 16px; border-radius: 8px; outline: none; font-size: 13px; }
        .chat-input:focus { border-color: var(--accent-purple); }
        .send-btn { background: var(--accent-purple); color: #fff; border: none; padding: 0 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; }
        .send-btn:hover { background: #7a7ef0; }
        .send-btn:disabled { background: var(--text-muted); cursor: not-allowed; }
        .map-legend { position: absolute; bottom: 20px; left: 20px; background: rgba(26, 29, 41, 0.95); padding: 14px 16px; border-radius: 8px; border: 1px solid var(--border-subtle); font-size: 11px; z-index: 100; }
        .legend-title { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; color: var(--text-secondary); }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.red { background: var(--accent-red); }
        .legend-dot.amber { background: var(--accent-amber); }
        .legend-dot.green { background: var(--accent-green); }
        .legend-dot.blue { background: var(--accent-cyan); }
        .route-info { position: absolute; top: 20px; left: 20px; background: rgba(26, 29, 41, 0.95); padding: 14px 16px; border-radius: 8px; border: 1px solid var(--border-subtle); font-size: 11px; z-index: 100; }
        .route-info-title { font-size: 10px; color: var(--accent-purple); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .route-info-item { display: flex; justify-content: space-between; margin-bottom: 6px; gap: 20px; }
        .route-info-label { color: var(--text-muted); }
        .route-info-value { color: var(--text-primary); font-weight: 600; }
        
        /* Tour Overlay */
        .tour-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.60); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .tour-overlay.active { opacity: 1; pointer-events: auto; }
        .tour-card { background: var(--bg-secondary); border: 1px solid var(--accent-purple); border-radius: 16px; max-width: 540px; padding: 32px 36px; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .tour-step-indicator { display: flex; gap: 6px; margin-bottom: 16px; }
        .tour-step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border-subtle); transition: all 0.3s; }
        .tour-step-dot.active { background: var(--accent-purple); width: 24px; border-radius: 4px; }
        .tour-step-dot.completed { background: var(--accent-green); }
        .tour-title { font-size: 22px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary); }
        .tour-subtitle { font-size: 12px; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .tour-content { font-size: 14px; line-height: 1.7; color: var(--text-secondary); margin-bottom: 20px; }
        .tour-content strong { color: var(--text-primary); }
        .tour-content .highlight { color: var(--accent-purple); font-weight: 500; }
        .tour-highlight-box { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin: 12px 0; }
        .tour-highlight-box .pillar { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; }
        .tour-highlight-box .pillar:last-child { margin-bottom: 0; }
        .tour-highlight-box .pillar-icon { width: 20px; text-align: center; }
        .tour-highlight-box .pillar-name { color: var(--text-primary); font-weight: 500; }
        .tour-highlight-box .pillar-desc { color: var(--text-muted); margin-left: auto; font-size: 11px; }
        .tour-buttons { display: flex; gap: 12px; justify-content: flex-end; }
        .tour-btn { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .tour-btn.primary { background: var(--accent-purple); color: #fff; }
        .tour-btn.primary:hover { background: #7a7ef0; }
        .tour-btn.secondary { background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .tour-btn.secondary:hover { border-color: var(--text-muted); color: var(--text-primary); }
        .tour-skip { position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-muted); font-size: 12px; cursor: pointer; }
        .tour-skip:hover { color: var(--text-primary); }
        .tour-spotlight { position: fixed; z-index: 9998; border: 2px solid var(--accent-purple); border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none; transition: all 0.4s ease-out; }
        
        @media (max-width: 1200px) { .sensor-feed { width: 260px; } .chat-panel { width: 380px; } }
        @media (max-width: 1000px) { .sensor-feed { display: none; } .stats-overlay { display: none; } .route-info { display: none; } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <div class="sensor-feed" id="sensorFeed">
                <div class="feed-header"><span class="feed-title">üöÇ Sensor Feed</span><span class="feed-live">LIVE</span></div>
                <div class="feed-items" id="feedItems"></div>
            </div>
            <div class="center-panel" id="mapContainer">
                <div id="mapView"></div>
                <div class="route-info">
                    <div class="route-info-title">üõ§Ô∏è Network Status</div>
                    <div class="route-info-item"><span class="route-info-label">Active Trains</span><span class="route-info-value">847</span></div>
                    <div class="route-info-item"><span class="route-info-label">Total Miles</span><span class="route-info-value">4,200</span></div>
                    <div class="route-info-item"><span class="route-info-label">On-Time</span><span class="route-info-value" style="color:#5ee88a">94.2%</span></div>
                    <div class="route-info-item"><span class="route-info-label">Alerts</span><span class="route-info-value" style="color:#ffcf3d">23</span></div>
                </div>
                <div class="stats-overlay">
                    <div class="overlay-title">üîß Fleet Status</div>
                    <div class="stat-row"><span class="stat-label">Total Railcars</span><span class="stat-val">12,847</span></div>
                    <div class="stat-row"><span class="stat-label">Maintenance Due</span><span class="stat-val warn">156</span></div>
                    <div class="stat-row"><span class="stat-label">Bearing Alerts</span><span class="stat-val down">12</span></div>
                    <div class="stat-row"><span class="stat-label">Chicago Dwell</span><span class="stat-val">18.4 hrs</span></div>
                    <div class="stat-row"><span class="stat-label">Avg Transit Time</span><span class="stat-val up">4.2 days</span></div>
                </div>
                <div class="map-legend">
                    <div class="legend-title">Asset Status</div>
                    <div class="legend-item"><div class="legend-dot red"></div> Critical Alert</div>
                    <div class="legend-item"><div class="legend-dot amber"></div> Maintenance Due</div>
                    <div class="legend-item"><div class="legend-dot green"></div> Normal Ops</div>
                    <div class="legend-item"><div class="legend-dot blue"></div> Major Yard</div>
                </div>
            </div>
            <div class="chat-panel" id="chatPanel">
                <div class="chat-header">
                    <div class="logo-box">üöÇ</div>
                    <div class="header-info"><h2>NEXUS RAIL</h2><p>Predictive Intelligence</p></div>
                </div>
                <div class="kpi-strip">
                    <div class="kpi-card"><div class="kpi-label">Fleet</div><div class="kpi-val">12,847</div></div>
                    <div class="kpi-card"><div class="kpi-label">Alerts</div><div class="kpi-val amber">23</div></div>
                    <div class="kpi-card"><div class="kpi-label">On-Time</div><div class="kpi-val green">94.2%</div></div>
                    <div class="kpi-card"><div class="kpi-label">Risk</div><div class="kpi-val green">0.003%</div></div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="input-area">
                    <div class="chip-container" id="chipContainer"></div>
                    <div class="input-box">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about fleet, maintenance, routes...">
                        <button class="send-btn" id="sendBtn">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-card">
            <button class="tour-skip" id="tourSkip">Skip Tour ‚úï</button>
            <div class="tour-step-indicator" id="tourSteps"></div>
            <div class="tour-subtitle" id="tourSubtitle"></div>
            <div class="tour-title" id="tourTitle"></div>
            <div class="tour-content" id="tourContent"></div>
            <div class="tour-buttons">
                <button class="tour-btn secondary" id="tourPrev">‚Üê Back</button>
                <button class="tour-btn primary" id="tourNext">Next ‚Üí</button>
            </div>
        </div>
    </div>
    <div class="tour-spotlight" id="tourSpotlight" style="display:none;"></div>

    <script src="https://js.arcgis.com/4.28/"></script>
    <script>
        // Tour Configuration
        const tourSteps = [
            {
                subtitle: "Welcome to Nexus Rail",
                title: "Predictive Rail Intelligence",
                content: `<p>You're looking at a <strong>live rail operations center</strong>. We're monitoring 12,847 railcars across 4,200 miles of track.</p>
                    <p>Right now, a critical bearing failure is developing on car TTGX-9821. The system has already predicted the failure and prepared recommendations.</p>
                    <p>Let me show you how it works.</p>`,
                target: null
            },
            {
                subtitle: "The Five Pillars",
                title: "How Nexus Synthesizes Rail Data",
                content: `<p>Every insight comes from <strong>correlating five data pillars</strong> in real-time:</p>
                    <div class="tour-highlight-box">
                        <div class="pillar"><span class="pillar-icon">üöÇ</span><span class="pillar-name">Fleet Operations</span><span class="pillar-desc">12,847 railcars, sensors, maintenance</span></div>
                        <div class="pillar"><span class="pillar-icon">üó∫Ô∏è</span><span class="pillar-name">Geospatial Network</span><span class="pillar-desc">Esri ArcGIS, routes, yards</span></div>
                        <div class="pillar"><span class="pillar-icon">üå°Ô∏è</span><span class="pillar-name">IoT Sensor Data</span><span class="pillar-desc">Bearings, brakes, track vibration</span></div>
                        <div class="pillar"><span class="pillar-icon">üå®Ô∏è</span><span class="pillar-name">Weather Intelligence</span><span class="pillar-desc">NWS alerts, storm tracking</span></div>
                        <div class="pillar"><span class="pillar-icon">üß†</span><span class="pillar-name">Predictive Analytics</span><span class="pillar-desc">Failure prediction, maintenance scheduling</span></div>
                    </div>
                    <p>This is <span class="highlight">predictive maintenance</span> meets <span class="highlight">operations intelligence</span>.</p>`,
                target: null
            },
            {
                subtitle: "Real-Time Sensor Feed",
                title: "Equipment Monitoring",
                content: `<p>The Sensor Feed shows <strong>live telemetry</strong> from across your fleet ‚Äî bearing temperatures, brake pressures, track vibration, GPS updates.</p>
                    <p>When sensors detect anomalies, Nexus correlates them with maintenance history, weather, and route data to <span class="highlight">predict failures before they happen</span>.</p>
                    <p>Current alert: TTGX-9821 bearing at 182¬∞F ‚Äî failure predicted in 6-8 hours.</p>`,
                target: '#sensorFeed'
            },
            {
                subtitle: "Network Visualization",
                title: "Your Rail Network at a Glance",
                content: `<p>The map shows your entire network with <strong>real-time status</strong>:</p>
                    <p>üîµ <strong>Blue dots</strong> = Major yards (Chicago, KC, Denver, LA...)</p>
                    <p>üî¥ <strong>Red dots</strong> = Critical alerts requiring action</p>
                    <p>üü° <strong>Amber dots</strong> = Equipment needing maintenance</p>
                    <p>üîµüü¢üü£ <strong>Lines</strong> = Active rail corridors</p>
                    <p>This is <span class="highlight">Esri ArcGIS</span> integrated with predictive intelligence.</p>`,
                target: '#mapContainer'
            },
            {
                subtitle: "Conversational Interface",
                title: "Ask Questions, Get Answers",
                content: `<p>This is where you interact with Nexus. Ask questions in <strong>plain English</strong> about your fleet, maintenance needs, weather impacts, or route optimization.</p>
                    <p>Try: <em>"Show bearing alerts"</em> or <em>"What's the weather impact on Chicago?"</em></p>
                    <p>Responses are generated in <span class="highlight">real-time by AI</span>, synthesizing sensor data, weather, and operational context.</p>`,
                target: '#chatPanel'
            },
            {
                subtitle: "Ready to Explore",
                title: "Try It Yourself",
                content: `<p>The scenario is live. Here are some things to try:</p>
                    <p>‚Ä¢ Click <strong>"Show bearing alerts"</strong> to see equipment issues</p>
                    <p>‚Ä¢ Click <strong>"Predict maintenance needs"</strong> for the forecast</p>
                    <p>‚Ä¢ Click <strong>"Chicago yard status"</strong> for hub operations</p>
                    <p>‚Ä¢ Click <strong>"Weather impact analysis"</strong> for storm effects</p>
                    <p>‚Ä¢ Or type any question ‚Äî <span class="highlight">AI will respond</span></p>`,
                target: null
            }
        ];
        
        let currentTourStep = 0;
        
        function initTour() {
            const overlay = document.getElementById('tourOverlay');
            const stepsContainer = document.getElementById('tourSteps');
            stepsContainer.innerHTML = tourSteps.map((_, i) => `<div class="tour-step-dot" data-step="${i}"></div>`).join('');
            setTimeout(() => { overlay.classList.add('active'); renderTourStep(0); }, 1500);
            document.getElementById('tourNext').addEventListener('click', nextTourStep);
            document.getElementById('tourPrev').addEventListener('click', prevTourStep);
            document.getElementById('tourSkip').addEventListener('click', endTour);
        }
        
        function renderTourStep(step) {
            const data = tourSteps[step];
            document.getElementById('tourSubtitle').textContent = data.subtitle;
            document.getElementById('tourTitle').textContent = data.title;
            document.getElementById('tourContent').innerHTML = data.content;
            document.querySelectorAll('.tour-step-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < step) dot.classList.add('completed');
                if (i === step) dot.classList.add('active');
            });
            document.getElementById('tourPrev').style.visibility = step === 0 ? 'hidden' : 'visible';
            document.getElementById('tourNext').textContent = step === tourSteps.length - 1 ? "Start Exploring ‚Üí" : "Next ‚Üí";
            const spotlight = document.getElementById('tourSpotlight');
            if (data.target) {
                const el = document.querySelector(data.target);
                if (el) {
                    const rect = el.getBoundingClientRect();
                    spotlight.style.display = 'block';
                    spotlight.style.top = rect.top - 4 + 'px';
                    spotlight.style.left = rect.left - 4 + 'px';
                    spotlight.style.width = rect.width + 8 + 'px';
                    spotlight.style.height = rect.height + 8 + 'px';
                }
            } else { spotlight.style.display = 'none'; }
        }
        
        function nextTourStep() { if (currentTourStep < tourSteps.length - 1) { currentTourStep++; renderTourStep(currentTourStep); } else { endTour(); } }
        function prevTourStep() { if (currentTourStep > 0) { currentTourStep--; renderTourStep(currentTourStep); } }
        function endTour() { document.getElementById('tourOverlay').classList.remove('active'); document.getElementById('tourSpotlight').style.display = 'none'; }

        // Chat & Demo Logic
        const DEMO_TOKEN = 'nexus-rail-2025';
        const INITIAL_CHIPS = ['Show bearing alerts', 'Predict maintenance needs', 'Chicago yard status', 'Weather impact analysis'];
        const FEED_EVENTS = [
            { type: 'warning', title: 'Bearing Temp Elevated', detail: 'TTGX-9821: 182¬∞F gradient detected.', delay: 2000 },
            { type: 'info', title: 'GPS Update', detail: 'Train 891 confirmed at MP 445.', delay: 6000 },
            { type: 'critical', title: 'Track Vibration Spike', detail: 'Segment 27-A: 8.4Hz anomaly.', delay: 12000 },
            { type: 'success', title: 'Maintenance Complete', detail: 'TTGX-4521 returning to service.', delay: 18000 },
            { type: 'warning', title: 'Dwell Time Alert', detail: 'Train 103 idle 48 min at Chicago.', delay: 24000 }
        ];
        const scriptedResponses = {
            'show bearing alerts': {
                content: `<p><strong>12 Active Bearing Alerts:</strong></p><div class="viz-risk-matrix"><div class="risk-matrix-header">üå°Ô∏è Temperature Anomalies</div><div class="risk-item"><div class="risk-level critical"></div><div class="risk-info"><div class="risk-name">TTGX-9821</div><div class="risk-detail">182¬∞F ‚Ä¢ Chicago-KC ‚Ä¢ Failure in 6-8 hrs</div></div><div class="risk-value red">Critical</div></div><div class="risk-item"><div class="risk-level high"></div><div class="risk-info"><div class="risk-name">TTGX-48271</div><div class="risk-detail">167¬∞F ‚Ä¢ +7.3¬∞F/100mi gradient</div></div><div class="risk-value amber">168 hrs</div></div><div class="risk-item"><div class="risk-level high"></div><div class="risk-info"><div class="risk-name">DTTX-7734</div><div class="risk-detail">159¬∞F ‚Ä¢ Monitoring required</div></div><div class="risk-value amber">240 hrs</div></div></div><p><strong>Recommendation:</strong> Route TTGX-9821 to nearest maintenance facility. Cost of delay: $45K/hour.</p>`,
                chips: ['Route to maintenance', 'Show failure history', 'Cost analysis', 'View all alerts']
            },
            'predict maintenance needs': {
                content: `<p><strong>Predictive Maintenance Forecast:</strong></p><div class="viz-roi-cards"><div class="roi-card"><div class="roi-label">Due This Week</div><div class="roi-value amber">34</div></div><div class="roi-card"><div class="roi-label">Due This Month</div><div class="roi-value">156</div></div><div class="roi-card"><div class="roi-label">Prediction Accuracy</div><div class="roi-value green">94.3%</div></div><div class="roi-card"><div class="roi-label">Cost Avoidance</div><div class="roi-value green">$2.3M</div></div></div><div class="viz-timeline"><div class="timeline-item"><div class="timeline-marker red"></div><div class="timeline-content"><div class="timeline-time">Next 24 Hours</div><div class="timeline-title">8 Critical Interventions</div><div class="timeline-desc">Wheel bearings (5), brake systems (2), structural (1)</div></div></div><div class="timeline-item"><div class="timeline-marker amber"></div><div class="timeline-content"><div class="timeline-time">This Week</div><div class="timeline-title">34 Scheduled Services</div><div class="timeline-desc">Optimal window: Tuesday-Thursday</div></div></div></div>`,
                chips: ['Schedule maintenance', 'Resource allocation', 'Parts inventory']
            },
            'chicago yard status': {
                content: `<p><strong>Chicago Clearing Yard:</strong></p><div class="viz-roi-cards"><div class="roi-card"><div class="roi-label">Capacity</div><div class="roi-value amber">87%</div></div><div class="roi-card"><div class="roi-label">Avg Dwell</div><div class="roi-value">18.4 hrs</div></div><div class="roi-card"><div class="roi-label">Trains</div><div class="roi-value">127</div></div><div class="roi-card"><div class="roi-label">Departures</div><div class="roi-value green">84</div></div></div><p><strong>Alert:</strong> Capacity at 87% with storm approaching. Recommend diverting 12 eastbound trains to KC. Delay cost if no action: <span style="color:#ff7979">$340K</span></p>`,
                chips: ['Divert trains', 'Show storm impact', 'Yard trends']
            },
            'weather impact analysis': {
                content: `<p><strong>Weather Impact (Next 48hrs):</strong></p><div class="viz-risk-matrix"><div class="risk-matrix-header">üå®Ô∏è Storm Forecast</div><div class="risk-item"><div class="risk-level critical"></div><div class="risk-info"><div class="risk-name">Chicago Hub</div><div class="risk-detail">8-12" snow ‚Ä¢ Speed limit 25mph</div></div><div class="risk-value red">Severe</div></div><div class="risk-item"><div class="risk-level high"></div><div class="risk-info"><div class="risk-name">KC Corridor</div><div class="risk-detail">4-6" snow ‚Ä¢ Minor delays</div></div><div class="risk-value amber">Moderate</div></div><div class="risk-item"><div class="risk-level low"></div><div class="risk-info"><div class="risk-name">Southern Routes</div><div class="risk-detail">Clear conditions</div></div><div class="risk-value green">Normal</div></div></div><div class="viz-roi-cards"><div class="roi-card"><div class="roi-label">Routes Affected</div><div class="roi-value red">7</div></div><div class="roi-card"><div class="roi-label">Est. Delay Cost</div><div class="roi-value red">$890K</div></div></div>`,
                chips: ['Reroute options', 'Pre-position crews', 'Customer alerts']
            }
        };
        function normalizeQuery(q) { return q.toLowerCase().trim().replace(/[?!.,]/g, ''); }
        function findResponse(query) {
            const n = normalizeQuery(query);
            if (scriptedResponses[n]) return scriptedResponses[n];
            const kw = { 'bearing': 'show bearing alerts', 'temperature': 'show bearing alerts', 'alert': 'show bearing alerts', 'maintenance': 'predict maintenance needs', 'predict': 'predict maintenance needs', 'chicago': 'chicago yard status', 'yard': 'chicago yard status', 'weather': 'weather impact analysis', 'storm': 'weather impact analysis' };
            for (const [k, v] of Object.entries(kw)) { if (n.includes(k)) return scriptedResponses[v]; }
            return null;
        }
        let conversationHistory = [], isProcessing = false;
        function addMessage(content, isUser, chips = []) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;
            div.innerHTML = `<div class="message-content">${typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(content, { ALLOWED_TAGS: ['div', 'p', 'strong', 'br', 'ul', 'li', 'span'], ALLOWED_ATTR: ['class', 'style'] }) : content}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            if (!isUser && chips.length > 0) updateChips(chips);
        }
        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message assistant typing';
            div.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        function removeTypingIndicator() { const t = document.querySelector('.message.typing'); if (t) t.remove(); }
        function updateChips(chips) {
            const container = document.getElementById('chipContainer');
            container.innerHTML = '';
            chips.forEach(text => {
                const btn = document.createElement('button');
                btn.className = 'chip';
                btn.textContent = text;
                btn.onclick = () => handleInput(text);
                container.appendChild(btn);
            });
        }
        async function handleInput(overrideText) {
            if (isProcessing) return;
            const input = document.getElementById('chatInput');
            const text = overrideText || input.value.trim();
            if (!text) return;
            input.value = '';
            isProcessing = true;
            document.getElementById('sendBtn').disabled = true;
            addMessage(text, true);
            conversationHistory.push({ role: 'user', content: text });
            addTypingIndicator();
            const scripted = findResponse(text);
            if (scripted) {
                setTimeout(() => {
                    removeTypingIndicator();
                    addMessage(scripted.content, false, scripted.chips || INITIAL_CHIPS);
                    conversationHistory.push({ role: 'assistant', content: scripted.content });
                    isProcessing = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 800);
            } else {
                try {
                    const resp = await fetch('/.netlify/functions/rail-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Demo-Token': DEMO_TOKEN },
                        body: JSON.stringify({ message: text, conversationHistory: conversationHistory.slice(-10).map(m => ({ role: m.role, content: m.content.replace(/<[^>]*>/g, '') })) })
                    });
                    if (!resp.ok) throw new Error();
                    const data = await resp.json();
                    removeTypingIndicator();
                    let r = data.response;
                    if (!r.includes('<div') && !r.includes('<p>')) r = r.split('\n\n').map(p => `<p>${p}</p>`).join('');
                    addMessage(r, false, INITIAL_CHIPS);
                    conversationHistory.push({ role: 'assistant', content: r });
                } catch (e) {
                    removeTypingIndicator();
                    addMessage(`<p>I can help with fleet tracking, maintenance, and weather analysis. Try "bearing alerts" or "Chicago yard".</p>`, false, INITIAL_CHIPS);
                }
                isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }
        function initFeed() {
            FEED_EVENTS.forEach(event => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = `feed-item ${event.type}`;
                    div.innerHTML = `<div class="feed-meta"><span>${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span><span class="feed-type ${event.type}">${event.type.toUpperCase()}</span></div><div class="feed-headline">${event.title}</div><div class="feed-body">${event.detail}</div>`;
                    div.style.opacity = '0';
                    document.getElementById('feedItems').prepend(div);
                    requestAnimationFrame(() => { div.style.transition = 'opacity 0.3s'; div.style.opacity = '1'; });
                }, event.delay);
            });
        }
        require(['esri/Map', 'esri/views/MapView', 'esri/Graphic', 'esri/layers/GraphicsLayer', 'esri/geometry/Polyline'], function(Map, MapView, Graphic, GraphicsLayer, Polyline) {
            const map = new Map({ basemap: 'dark-gray-vector' });
            const view = new MapView({ container: 'mapView', map: map, center: [-95.7, 39.8], zoom: 4 });
            const routeLayer = new GraphicsLayer();
            const yardLayer = new GraphicsLayer();
            const alertLayer = new GraphicsLayer();
            map.addMany([routeLayer, yardLayer, alertLayer]);
            const corridors = [
                { path: [[-87.63, 41.88], [-94.58, 39.1]], color: '#5fd4ff' },
                { path: [[-87.63, 41.88], [-90.2, 38.63], [-94.58, 39.1]], color: '#5fd4ff' },
                { path: [[-87.63, 41.88], [-93.27, 44.98]], color: '#5fd4ff' },
                { path: [[-87.63, 41.88], [-83.05, 42.33], [-79.0, 43.0], [-74.0, 40.7]], color: '#5fd4ff' },
                { path: [[-94.58, 39.1], [-104.99, 39.74]], color: '#5ee88a' },
                { path: [[-104.99, 39.74], [-111.89, 40.76], [-122.42, 37.77]], color: '#5ee88a' },
                { path: [[-94.58, 39.1], [-96.8, 32.78], [-95.36, 29.76]], color: '#8b8fff' },
                { path: [[-122.42, 37.77], [-118.24, 34.05]], color: '#5ee88a' },
                { path: [[-118.24, 34.05], [-110.93, 32.22], [-96.8, 32.78]], color: '#8b8fff' }
            ];
            corridors.forEach(c => {
                routeLayer.add(new Graphic({
                    geometry: new Polyline({ paths: [c.path], spatialReference: { wkid: 4326 } }),
                    symbol: { type: 'simple-line', color: c.color, width: 3 }
                }));
            });
            const yards = [
                { lon: -87.63, lat: 41.88 }, { lon: -94.58, lat: 39.1 }, { lon: -90.2, lat: 38.63 },
                { lon: -104.99, lat: 39.74 }, { lon: -122.42, lat: 37.77 }, { lon: -118.24, lat: 34.05 },
                { lon: -95.36, lat: 29.76 }, { lon: -96.8, lat: 32.78 }, { lon: -93.27, lat: 44.98 }
            ];
            yards.forEach(y => {
                yardLayer.add(new Graphic({
                    geometry: { type: 'point', longitude: y.lon, latitude: y.lat },
                    symbol: { type: 'simple-marker', color: '#5fd4ff', size: 14, outline: { color: '#fff', width: 2 } }
                }));
            });
            const alerts = [
                { lon: -89.5, lat: 40.5, type: 'critical' }, { lon: -91.2, lat: 39.2, type: 'critical' },
                { lon: -98.5, lat: 38.5, type: 'warning' }, { lon: -100.5, lat: 41.2, type: 'warning' }
            ];
            alerts.forEach(a => {
                alertLayer.add(new Graphic({
                    geometry: { type: 'point', longitude: a.lon, latitude: a.lat },
                    symbol: { type: 'simple-marker', color: a.type === 'critical' ? '#ff7979' : '#ffcf3d', size: a.type === 'critical' ? 14 : 11, outline: { color: '#fff', width: 2 } }
                }));
            });
            view.ui.remove('zoom');
        });
        document.addEventListener('DOMContentLoaded', () => {
            updateChips(INITIAL_CHIPS);
            addMessage(`<p><strong>Rail Intelligence Active.</strong></p><p>Monitoring <strong>12,847 railcars</strong> across 4,200 miles. Currently tracking <span style="color:#ffcf3d">23 alerts</span> including 12 bearing anomalies.</p><p>TTGX-9821 requires immediate attention ‚Äî bearing failure predicted within 6-8 hours.</p>`, false, INITIAL_CHIPS);
            initFeed();
            initTour();
            document.getElementById('sendBtn').addEventListener('click', () => handleInput());
            document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter') handleInput(); });
        });
    </script>
</body>
</html>
